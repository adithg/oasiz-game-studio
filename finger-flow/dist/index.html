<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="mobile-web-app-capable" content="yes" />
  <title>Finger Flow</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      touch-action: none;
      background: #050510;
      font-family: 'Space Mono', monospace;
      -webkit-user-select: none;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    canvas {
      display: block;
      width: 100%;
      height: 100%;
    }

    /* Settings Button */
    #settingsBtn {
      position: absolute;
      top: 45px;
      right: 20px;
      width: 48px;
      height: 48px;
      background: rgba(255, 255, 255, 0.08);
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 100;
      backdrop-filter: blur(10px);
    }

    #settingsBtn:hover {
      background: rgba(255, 255, 255, 0.15);
      border-color: rgba(255, 255, 255, 0.4);
      transform: rotate(45deg);
    }

    #settingsBtn:active {
      transform: rotate(45deg) scale(0.95);
    }

    #settingsBtn svg {
      width: 24px;
      height: 24px;
      fill: rgba(255, 255, 255, 0.8);
      transition: transform 0.3s ease;
    }

    @media (pointer: coarse) {
      #settingsBtn {
        top: 120px;
      }
    }

    /* Settings Panel */
    #settingsPanel {
      position: absolute;
      top: 0;
      right: -320px;
      width: 300px;
      height: 100%;
      background: linear-gradient(160deg, rgba(15, 15, 30, 0.98), rgba(5, 5, 15, 0.98));
      backdrop-filter: blur(20px);
      border-left: 1px solid rgba(100, 200, 255, 0.2);
      padding: 90px 28px 28px;
      transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 200;
      box-shadow: -10px 0 40px rgba(0, 0, 0, 0.5);
    }

    #settingsPanel.open {
      right: 0;
    }

    @media (pointer: coarse) {
      #settingsPanel {
        padding-top: 150px;
      }
    }

    #settingsPanel h2 {
      color: #fff;
      font-family: 'Orbitron', sans-serif;
      font-size: 22px;
      margin-bottom: 36px;
      font-weight: 700;
      letter-spacing: 3px;
      text-transform: uppercase;
      background: linear-gradient(135deg, #64c8ff, #a78bfa);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .settings-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 28px;
      padding: 12px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .settings-row label {
      color: rgba(255, 255, 255, 0.85);
      font-size: 14px;
      letter-spacing: 1px;
      font-weight: 400;
    }

    /* Custom Toggle Switch */
    .toggle {
      position: relative;
      width: 56px;
      height: 30px;
    }

    .toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.08);
      border: 2px solid rgba(255, 255, 255, 0.15);
      border-radius: 30px;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .toggle-slider::before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 2px;
      bottom: 2px;
      background: rgba(255, 255, 255, 0.5);
      border-radius: 50%;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .toggle input:checked + .toggle-slider {
      background: rgba(100, 200, 255, 0.25);
      border-color: rgba(100, 200, 255, 0.5);
    }

    .toggle input:checked + .toggle-slider::before {
      transform: translateX(26px);
      background: #64c8ff;
      box-shadow: 0 0 20px rgba(100, 200, 255, 0.6), 0 0 40px rgba(100, 200, 255, 0.3);
    }

    #closeSettings {
      position: absolute;
      top: 30px;
      right: 24px;
      width: 40px;
      height: 40px;
      background: transparent;
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      color: rgba(255, 255, 255, 0.7);
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    @media (pointer: coarse) {
      #closeSettings {
        top: 90px;
      }
    }

    #closeSettings:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.4);
      color: #fff;
      transform: rotate(90deg);
    }

    /* Game Over Screen */
    #gameOverScreen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(ellipse at center, rgba(20, 10, 30, 0.95), rgba(5, 5, 15, 0.98));
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 50;
      pointer-events: none;
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    #gameOverScreen h1 {
      font-family: 'Orbitron', sans-serif;
      font-size: 56px;
      font-weight: 900;
      color: #ff4466;
      text-shadow: 0 0 40px rgba(255, 68, 102, 0.6), 0 0 80px rgba(255, 68, 102, 0.3);
      margin-bottom: 12px;
      letter-spacing: 6px;
      animation: glitchText 0.3s ease;
    }

    @keyframes glitchText {
      0%, 100% { transform: translateX(0); }
      20% { transform: translateX(-5px); }
      40% { transform: translateX(5px); }
      60% { transform: translateX(-3px); }
      80% { transform: translateX(3px); }
    }

    #deathReason {
      font-size: 16px;
      color: rgba(255, 255, 255, 0.5);
      margin-bottom: 40px;
      letter-spacing: 1px;
    }

    #finalScore {
      font-family: 'Orbitron', sans-serif;
      font-size: 84px;
      font-weight: 900;
      color: #fff;
      margin-bottom: 8px;
      text-shadow: 0 0 30px rgba(255, 255, 255, 0.5);
      animation: scoreReveal 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes scoreReveal {
      from {
        transform: scale(0.5);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    .score-label {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.4);
      letter-spacing: 4px;
      margin-bottom: 12px;
      text-transform: uppercase;
    }

    #maxCombo {
      font-size: 16px;
      color: #ffd700;
      margin-bottom: 50px;
      letter-spacing: 1px;
    }

    .restart-hint {
      font-size: 18px;
      color: rgba(100, 200, 255, 0.8);
      animation: pulse 2s ease-in-out infinite;
      letter-spacing: 2px;
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.5; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.02); }
    }

    /* Responsive */
    @media (max-width: 480px) {
      #gameOverScreen h1 {
        font-size: 40px;
        letter-spacing: 4px;
      }

      #finalScore {
        font-size: 64px;
      }
    }

    /* Decorative elements */
    .glow-line {
      position: absolute;
      width: 200px;
      height: 2px;
      background: linear-gradient(90deg, transparent, rgba(100, 200, 255, 0.5), transparent);
      animation: glowPulse 3s ease-in-out infinite;
    }

    .glow-line.top {
      top: 15%;
      left: 50%;
      transform: translateX(-50%);
    }

    .glow-line.bottom {
      bottom: 20%;
      left: 50%;
      transform: translateX(-50%);
    }

    @keyframes glowPulse {
      0%, 100% { opacity: 0.3; width: 150px; }
      50% { opacity: 0.8; width: 250px; }
    }
  </style>
  <script type="module" crossorigin>(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const h of a.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&i(h)}).observe(document,{childList:!0,subtree:!0});function e(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(s){if(s.ep)return;s.ep=!0;const a=e(s);fetch(s.href,a)}})();class f{canvas;ctx;width=0;height=0;gameState="START";score=0;distance=0;combo=0;maxCombo=0;comboTimer=0;perfectCenterBonus=0;shieldActive=!1;shieldTimer=0;slowMoActive=!1;slowMoTimer=0;pathSegments=[];segmentHeight=15;basePathWidth=220;minPathWidth=70;scrollSpeed=0;targetScrollSpeed=4;maxScrollSpeed=14;isPressed=!1;playerX=0;playerY=0;wasEverPressed=!1;graceTime=0;graceDuration=800;lastPlayerX=0;lastPlayerY=0;trail=[];particles=[];stars=[];floatingTexts=[];hue=200;targetHue=200;lastMilestone=0;milestoneText="";milestoneTimer=0;cameraShakeX=0;cameraShakeY=0;cameraShakeIntensity=0;cameraOffsetX=0;cameraOffsetY=0;cameraZoom=1;targetCameraZoom=1;screenFlash=0;screenFlashColor="#fff";slowMoFactor=1;pulseEffect=0;dangerLevel=0;chromaticAberration=0;audioContext=null;musicOscillator=null;musicGain=null;settings={music:!0,fx:!0,haptics:!0};isMobile=!1;settingsOpen=!1;lastTime=0;time=0;deathTimer=0;deathReason="";lastSparkTime=0;constructor(){console.log("[FingerFlowGame] Initializing game"),this.canvas=document.getElementById("gameCanvas"),this.ctx=this.canvas.getContext("2d"),this.isMobile=window.matchMedia("(pointer: coarse)").matches,this.loadSettings(),this.setupCanvas(),this.setupEventListeners(),this.setupUI(),this.initPath(),this.initAudio(),this.lastTime=performance.now(),this.gameLoop()}initAudio(){try{this.audioContext=new(window.AudioContext||window.webkitAudioContext)}catch{console.log("[initAudio] Web Audio not supported")}}startBackgroundMusic(){if(!(!this.settings.music||!this.audioContext)){this.stopBackgroundMusic();try{this.musicGain=this.audioContext.createGain(),this.musicGain.gain.setValueAtTime(0,this.audioContext.currentTime),this.musicGain.gain.linearRampToValueAtTime(.03,this.audioContext.currentTime+2),this.musicGain.connect(this.audioContext.destination),this.musicOscillator=this.audioContext.createOscillator(),this.musicOscillator.type="sine",this.musicOscillator.frequency.setValueAtTime(80,this.audioContext.currentTime),this.musicOscillator.connect(this.musicGain),this.musicOscillator.start();const t=this.audioContext.createOscillator(),e=this.audioContext.createGain();t.type="sine",t.frequency.setValueAtTime(120,this.audioContext.currentTime),e.gain.setValueAtTime(.015,this.audioContext.currentTime),t.connect(e),e.connect(this.audioContext.destination),t.start()}catch{}}}stopBackgroundMusic(){try{this.musicOscillator&&(this.musicOscillator.stop(),this.musicOscillator=null),this.musicGain&&(this.musicGain=null)}catch{}}playSound(t){if(!this.settings.fx||!this.audioContext)return;const e=this.audioContext,i=e.currentTime;try{if(t==="collect"){const s=e.createOscillator(),a=e.createGain();s.connect(a),a.connect(e.destination),s.frequency.setValueAtTime(600+this.combo*40,i),s.frequency.exponentialRampToValueAtTime(1e3+this.combo*60,i+.08),s.type="sine",a.gain.setValueAtTime(.12,i),a.gain.exponentialRampToValueAtTime(.01,i+.12),s.start(i),s.stop(i+.12)}else if(t==="powerup")[0,.05,.1,.15].forEach((s,a)=>{const h=e.createOscillator(),o=e.createGain();h.connect(o),o.connect(e.destination),h.frequency.setValueAtTime([400,500,600,800][a],i+s),h.type="sine",o.gain.setValueAtTime(.1,i+s),o.gain.exponentialRampToValueAtTime(.01,i+s+.2),h.start(i+s),h.stop(i+s+.2)});else if(t==="milestone")[0,.08,.16].forEach((s,a)=>{const h=e.createOscillator(),o=e.createGain();h.connect(o),o.connect(e.destination),h.frequency.setValueAtTime([523,659,784][a],i+s),h.type="sine",o.gain.setValueAtTime(.12,i+s),o.gain.exponentialRampToValueAtTime(.01,i+s+.25),h.start(i+s),h.stop(i+s+.25)});else if(t==="death"){const s=e.createOscillator(),a=e.createGain();s.connect(a),a.connect(e.destination),s.frequency.setValueAtTime(400,i),s.frequency.exponentialRampToValueAtTime(60,i+.6),s.type="sawtooth",a.gain.setValueAtTime(.15,i),a.gain.exponentialRampToValueAtTime(.01,i+.6),s.start(i),s.stop(i+.6)}else if(t==="start"){const s=e.createOscillator(),a=e.createGain();s.connect(a),a.connect(e.destination),s.frequency.setValueAtTime(300,i),s.frequency.exponentialRampToValueAtTime(600,i+.12),a.gain.setValueAtTime(.08,i),a.gain.exponentialRampToValueAtTime(.01,i+.15),s.start(i),s.stop(i+.15)}else if(t==="perfect"){const s=e.createOscillator(),a=e.createGain();s.connect(a),a.connect(e.destination),s.frequency.setValueAtTime(1200,i),s.frequency.exponentialRampToValueAtTime(1800,i+.05),s.type="sine",a.gain.setValueAtTime(.06,i),a.gain.exponentialRampToValueAtTime(.01,i+.1),s.start(i),s.stop(i+.1)}else if(t==="warning"){const s=e.createOscillator(),a=e.createGain();s.connect(a),a.connect(e.destination),s.frequency.setValueAtTime(200,i),s.type="square",a.gain.setValueAtTime(.03,i),a.gain.exponentialRampToValueAtTime(.01,i+.05),s.start(i),s.stop(i+.05)}}catch{}}loadSettings(){const t=localStorage.getItem("fingerflow-settings");if(t)try{this.settings={...this.settings,...JSON.parse(t)}}catch{console.log("[loadSettings] Failed to parse settings")}}saveSettings(){localStorage.setItem("fingerflow-settings",JSON.stringify(this.settings))}setupCanvas(){this.width=window.innerWidth,this.height=window.innerHeight,this.canvas.width=this.width,this.canvas.height=this.height,this.basePathWidth=Math.min(this.width*.55,280),this.minPathWidth=Math.max(this.width*.12,50)}setupEventListeners(){window.addEventListener("resize",()=>this.handleResize()),this.canvas.addEventListener("mousedown",t=>this.handlePointerDown(t.clientX,t.clientY)),this.canvas.addEventListener("mousemove",t=>this.handlePointerMove(t.clientX,t.clientY)),this.canvas.addEventListener("mouseup",()=>this.handlePointerUp()),this.canvas.addEventListener("mouseleave",()=>this.handlePointerUp()),this.canvas.addEventListener("touchstart",t=>{t.preventDefault();const e=t.touches[0];this.handlePointerDown(e.clientX,e.clientY)}),this.canvas.addEventListener("touchmove",t=>{t.preventDefault();const e=t.touches[0];this.handlePointerMove(e.clientX,e.clientY)}),this.canvas.addEventListener("touchend",t=>{t.preventDefault(),this.handlePointerUp()}),this.canvas.addEventListener("touchcancel",t=>{t.preventDefault(),this.handlePointerUp()})}setupUI(){const t=document.getElementById("settingsBtn"),e=document.getElementById("settingsPanel"),i=document.getElementById("closeSettings"),s=document.getElementById("musicToggle"),a=document.getElementById("fxToggle"),h=document.getElementById("hapticsToggle");s&&(s.checked=this.settings.music),a&&(a.checked=this.settings.fx),h&&(h.checked=this.settings.haptics),t?.addEventListener("click",()=>{this.settingsOpen=!0,e?.classList.add("open"),this.triggerHaptic("light")}),i?.addEventListener("click",()=>{this.settingsOpen=!1,e?.classList.remove("open"),this.triggerHaptic("light")}),s?.addEventListener("change",()=>{this.settings.music=s.checked,this.saveSettings(),this.triggerHaptic("light"),this.settings.music||this.stopBackgroundMusic()}),a?.addEventListener("change",()=>{this.settings.fx=a.checked,this.saveSettings(),this.triggerHaptic("light")}),h?.addEventListener("change",()=>{this.settings.haptics=h.checked,this.saveSettings(),this.triggerHaptic("light")})}handleResize(){this.setupCanvas(),this.gameState==="START"&&this.initPath()}handlePointerDown(t,e){this.settingsOpen||(this.audioContext?.state==="suspended"&&this.audioContext.resume(),this.playerX=t,this.playerY=e,this.lastPlayerX=t,this.lastPlayerY=e,this.isPressed=!0,this.gameState==="START"?this.startGame():this.gameState==="GAME_OVER"&&this.resetGame(),this.wasEverPressed=!0,this.triggerHaptic("light"))}handlePointerMove(t,e){if(!this.settingsOpen&&(this.lastPlayerX=this.playerX,this.lastPlayerY=this.playerY,this.playerX=t,this.playerY=e,this.isPressed&&(this.gameState==="PLAYING"||this.gameState==="DYING"))){const i=Math.sqrt(Math.pow(t-this.lastPlayerX,2)+Math.pow(e-this.lastPlayerY,2));this.trail.push({x:t,y:e,age:0,size:Math.min(14,4+i*.35)}),this.trail.length>100&&this.trail.shift(),i>8&&Math.random()<.4&&this.particles.push({x:t+(Math.random()-.5)*10,y:e+(Math.random()-.5)*10,vx:(Math.random()-.5)*2,vy:(Math.random()-.5)*2,life:1,maxLife:1,size:2+Math.random()*2,hue:this.hue,type:"spark"})}}handlePointerUp(){this.settingsOpen||(this.isPressed&&this.gameState==="PLAYING"&&this.wasEverPressed&&this.graceTime<=0&&(this.shieldActive||(console.log("[handlePointerUp] Finger lifted - game over!"),this.startDeath("You lifted your finger!"))),this.isPressed=!1)}initPath(){this.pathSegments=[];const t=Math.ceil(this.height/this.segmentHeight)+40;let e=this.width/2;for(let i=0;i<t;i++){const s=this.height-i*this.segmentHeight;this.pathSegments.push({y:s,centerX:e,width:this.basePathWidth,targetCenterX:e})}}spawnCollectibles(){if(this.gameState==="PLAYING"){if(Math.random()<.025){const t=this.pathSegments[this.pathSegments.length-1];t&&this.stars.push({x:t.centerX+(Math.random()-.5)*t.width*.5,y:t.y,collected:!1,pulse:Math.random()*Math.PI*2,type:"star"})}if(Math.random()<.003&&this.distance>500){const t=this.pathSegments[this.pathSegments.length-1];if(t){const e=Math.random()<.5?"shield":"slowmo";this.stars.push({x:t.centerX+(Math.random()-.5)*t.width*.3,y:t.y,collected:!1,pulse:Math.random()*Math.PI*2,type:e})}}}}startGame(){if(console.log("[startGame] Starting new game"),this.gameState="PLAYING",this.score=0,this.distance=0,this.combo=0,this.maxCombo=0,this.comboTimer=0,this.perfectCenterBonus=0,this.scrollSpeed=0,this.targetScrollSpeed=4,this.trail=[],this.particles=[],this.stars=[],this.floatingTexts=[],this.hue=200,this.targetHue=200,this.wasEverPressed=!1,this.graceTime=this.graceDuration,this.lastMilestone=0,this.milestoneText="",this.milestoneTimer=0,this.dangerLevel=0,this.slowMoFactor=1,this.deathTimer=0,this.shieldActive=!1,this.shieldTimer=0,this.slowMoActive=!1,this.slowMoTimer=0,this.chromaticAberration=0,this.cameraZoom=1,this.targetCameraZoom=1,this.initPath(),this.pathSegments.length>0)for(let i=0;i<this.pathSegments.length;i++){const s=Math.min(1,i/30),a=this.playerX+(this.width/2-this.playerX)*s;this.pathSegments[i].centerX=a,this.pathSegments[i].targetCenterX=a}this.screenFlash=.3,this.screenFlashColor="#4ade80",this.playSound("start"),this.triggerHaptic("medium"),this.startBackgroundMusic();const t=document.getElementById("startScreen");t&&(t.style.display="none");const e=document.getElementById("gameOverScreen");e&&(e.style.display="none")}resetGame(){this.initPath(),this.startGame()}startDeath(t){if(this.gameState!=="DYING"){console.log("[startDeath] Starting death sequence:",t),this.gameState="DYING",this.deathReason=t,this.deathTimer=0,this.slowMoFactor=.08,this.chromaticAberration=15,this.stopBackgroundMusic();for(let e=0;e<100;e++){const i=Math.PI*2*e/100+Math.random()*.3,s=2+Math.random()*10;this.particles.push({x:this.playerX,y:this.playerY,vx:Math.cos(i)*s,vy:Math.sin(i)*s,life:1,maxLife:1,size:2+Math.random()*8,hue:this.hue+Math.random()*60-30,type:"explosion"})}this.particles.push({x:this.playerX,y:this.playerY,vx:0,vy:0,life:1,maxLife:1,size:10,hue:this.hue,type:"ring"}),this.cameraShakeIntensity=35,this.screenFlash=1,this.screenFlashColor="#ff4466",this.playSound("death"),this.triggerHaptic("error")}}finishDeath(){console.log("[finishDeath] Game over"),this.gameState="GAME_OVER",this.submitScore(),setTimeout(()=>{const t=document.getElementById("gameOverScreen"),e=document.getElementById("finalScore"),i=document.getElementById("deathReason"),s=document.getElementById("maxCombo");t&&(t.style.display="flex"),e&&(e.textContent=Math.floor(this.score).toString()),i&&(i.textContent=this.deathReason),s&&(s.textContent="Max Combo: "+this.maxCombo+"x")},200)}submitScore(){console.log("[submitScore] Submitting score:",Math.floor(this.score)),typeof window.submitScore=="function"&&window.submitScore(Math.floor(this.score))}triggerHaptic(t){this.settings.haptics&&typeof window.triggerHaptic=="function"&&window.triggerHaptic(t)}addCameraShake(t){this.cameraShakeIntensity=Math.max(this.cameraShakeIntensity,t)}addFloatingText(t,e,i,s){this.floatingTexts.push({x:t,y:e,text:i,color:s,life:1,scale:1.5})}roundedRect(t,e,i,s,a,h){s<0||a<0||(h=Math.min(h,s/2,a/2),t.beginPath(),t.moveTo(e+h,i),t.lineTo(e+s-h,i),t.quadraticCurveTo(e+s,i,e+s,i+h),t.lineTo(e+s,i+a-h),t.quadraticCurveTo(e+s,i+a,e+s-h,i+a),t.lineTo(e+h,i+a),t.quadraticCurveTo(e,i+a,e,i+a-h),t.lineTo(e,i+h),t.quadraticCurveTo(e,i,e+h,i),t.closePath())}update(t){let e=this.slowMoFactor;this.slowMoActive&&this.gameState==="PLAYING"&&(e*=.5);const i=t*e;if(this.time+=i,this.updateCamera(t),this.updateParticles(i),this.updateTrail(i),this.updateFloatingTexts(i),this.screenFlash*=.88,this.screenFlash<.01&&(this.screenFlash=0),this.chromaticAberration*=.92,this.chromaticAberration<.1&&(this.chromaticAberration=0),this.gameState==="PLAYING"&&(this.slowMoFactor+=(1-this.slowMoFactor)*.08),this.shieldActive&&(this.shieldTimer-=i,this.shieldTimer<=0&&(this.shieldActive=!1,this.addFloatingText(this.playerX,this.playerY-40,"Shield Off","#888"))),this.slowMoActive&&(this.slowMoTimer-=t,this.slowMoTimer<=0&&(this.slowMoActive=!1,this.addFloatingText(this.playerX,this.playerY-40,"Time Normal","#888"))),this.milestoneTimer>0&&(this.milestoneTimer-=i),this.gameState==="DYING"){this.deathTimer+=t,this.slowMoFactor+=(.25-this.slowMoFactor)*.03,this.deathTimer>1e3&&this.finishDeath();return}if(this.gameState!=="PLAYING"||!this.isPressed)return;this.graceTime>0&&(this.graceTime-=i);const s=i/16.67;this.scrollSpeed+=(this.targetScrollSpeed-this.scrollSpeed)*.05,this.distance+=this.scrollSpeed*s;const a=1+this.combo*.15;this.score+=this.scrollSpeed*s*.5*a,this.checkPerfectCenter(),this.targetCameraZoom=1-(this.scrollSpeed-4)/40,this.cameraZoom+=(this.targetCameraZoom-this.cameraZoom)*.02,this.targetScrollSpeed=Math.min(this.maxScrollSpeed,4+this.distance*8e-4),this.comboTimer>0&&(this.comboTimer-=i,this.comboTimer<=0&&(this.combo>0&&this.addFloatingText(this.playerX,this.playerY-50,"Combo Lost!","#ff6b6b"),this.combo=0)),this.targetHue=(200+this.distance*.06)%360,this.hue+=(this.targetHue-this.hue)*.015;for(const h of this.pathSegments)h.y+=this.scrollSpeed*s;for(const h of this.stars)h.y+=this.scrollSpeed*s,h.pulse+=i*.005;for(;this.pathSegments.length>0&&this.pathSegments[0].y>this.height+this.segmentHeight;)this.pathSegments.shift();for(;this.pathSegments.length>0&&this.pathSegments[this.pathSegments.length-1].y>-this.segmentHeight*2;)this.addNewPathSegment();this.stars=this.stars.filter(h=>h.y<this.height+50),this.spawnCollectibles(),this.checkStarCollection(),this.checkCollision(),this.checkMilestones(),this.scrollSpeed>7&&Math.random()<.35&&this.particles.push({x:Math.random()*this.width,y:-20,vx:0,vy:this.scrollSpeed*4,life:1,maxLife:1,size:1+Math.random(),hue:this.hue,type:"speedline"}),this.time-this.lastSparkTime>100&&Math.random()<.15&&(this.spawnWallSparks(),this.lastSparkTime=this.time),this.pulseEffect*=.94}checkPerfectCenter(){const t=this.pathSegments.findIndex(a=>this.playerY>=a.y&&this.playerY<a.y+this.segmentHeight);if(t===-1)return;const e=this.pathSegments[t],i=Math.abs(this.playerX-e.centerX),s=e.width*.1;if(i<s){if(this.perfectCenterBonus+=.1,this.perfectCenterBonus>=10){this.perfectCenterBonus=0,this.score+=25,this.addFloatingText(this.playerX,this.playerY-30,"+25 PERFECT!","#ffd700"),this.playSound("perfect"),this.pulseEffect=.5;for(let a=0;a<8;a++){const h=Math.PI*2*a/8;this.particles.push({x:this.playerX,y:this.playerY,vx:Math.cos(h)*2,vy:Math.sin(h)*2,life:1,maxLife:1,size:2,hue:50,type:"spark"})}}}else this.perfectCenterBonus=Math.max(0,this.perfectCenterBonus-.05)}spawnWallSparks(){const t=this.height/2,e=this.pathSegments.find(a=>Math.abs(a.y-t)<50);if(!e)return;const i=Math.random()<.5?-1:1,s=e.centerX+e.width/2*i;this.particles.push({x:s,y:e.y+Math.random()*30,vx:-i*(1+Math.random()*2),vy:-1-Math.random()*2,life:1,maxLife:1,size:2+Math.random()*2,hue:i>0?(this.hue+50)%360:this.hue,type:"spark"})}updateCamera(t){if(this.cameraShakeIntensity*=.88,this.cameraShakeIntensity<.1&&(this.cameraShakeIntensity=0),this.cameraShakeX=(Math.random()-.5)*this.cameraShakeIntensity,this.cameraShakeY=(Math.random()-.5)*this.cameraShakeIntensity,this.gameState==="PLAYING"||this.gameState==="DYING"){const e=(this.playerX-this.width/2)*.04,i=(this.playerY-this.height/2)*.015;this.cameraOffsetX+=(e-this.cameraOffsetX)*.06,this.cameraOffsetY+=(i-this.cameraOffsetY)*.06}}updateTrail(t){for(const e of this.trail)e.age+=t*.0018;this.trail=this.trail.filter(e=>e.age<1)}updateFloatingTexts(t){for(const e of this.floatingTexts)e.y-=t*.05,e.life-=t*.001,e.scale*=.98;this.floatingTexts=this.floatingTexts.filter(e=>e.life>0)}updateParticles(t){const e=t/16.67;for(const i of this.particles)i.x+=i.vx*e,i.y+=i.vy*e,i.type==="explosion"?(i.vy+=.12*e,i.vx*=.98,i.vy*=.98):i.type==="star"?i.vy-=.04*e:i.type==="spark"?(i.vy+=.05*e,i.vx*=.97):i.type==="ring"&&(i.size+=8*e),i.rotation!==void 0&&i.rotationSpeed!==void 0&&(i.rotation+=i.rotationSpeed*e),i.life-=t*.002;this.particles=this.particles.filter(i=>i.life>0)}addNewPathSegment(){const t=this.pathSegments[this.pathSegments.length-1],e=Math.min(1,this.distance/6e3),i=Math.sin(this.distance*.004)*100*e,s=(Math.random()-.5)*(70+e*140)*.025;let a=t.targetCenterX+s+i*.015;const h=this.basePathWidth/2+50;a=Math.max(h,Math.min(this.width-h,a));const o=t.centerX+(a-t.centerX)*.1,n=this.minPathWidth,l=this.basePathWidth-n,r=this.basePathWidth-l*e*.6;this.pathSegments.push({y:t.y-this.segmentHeight,centerX:o,width:r,targetCenterX:a})}checkStarCollection(){for(const e of this.stars){if(e.collected)continue;const i=this.playerX-e.x,s=this.playerY-e.y;if(Math.sqrt(i*i+s*s)<40){if(e.collected=!0,e.type==="star"){this.combo++,this.maxCombo=Math.max(this.maxCombo,this.combo),this.comboTimer=3500;const h=50*this.combo;this.score+=h,this.addFloatingText(e.x,e.y-20,"+"+h,"#ffd700");for(let o=0;o<15;o++){const n=Math.PI*2*o/15;this.particles.push({x:e.x,y:e.y,vx:Math.cos(n)*(2+Math.random()*2),vy:Math.sin(n)*(2+Math.random()*2)-1,life:1,maxLife:1,size:2+Math.random()*3,hue:50,type:"star"})}this.playSound("collect"),this.triggerHaptic("light"),this.pulseEffect=.8}else if(e.type==="shield"){this.shieldActive=!0,this.shieldTimer=5e3,this.addFloatingText(e.x,e.y-20,"SHIELD!","#4ade80"),this.screenFlash=.3,this.screenFlashColor="#4ade80",this.playSound("powerup"),this.triggerHaptic("success");for(let h=0;h<20;h++){const o=Math.PI*2*h/20;this.particles.push({x:e.x,y:e.y,vx:Math.cos(o)*4,vy:Math.sin(o)*4,life:1,maxLife:1,size:4,hue:140,type:"explosion"})}}else if(e.type==="slowmo"){this.slowMoActive=!0,this.slowMoTimer=4e3,this.addFloatingText(e.x,e.y-20,"SLOW-MO!","#a78bfa"),this.screenFlash=.3,this.screenFlashColor="#a78bfa",this.playSound("powerup"),this.triggerHaptic("success");for(let h=0;h<20;h++){const o=Math.PI*2*h/20;this.particles.push({x:e.x,y:e.y,vx:Math.cos(o)*4,vy:Math.sin(o)*4,life:1,maxLife:1,size:4,hue:280,type:"explosion"})}}}}}checkCollision(){const t=this.pathSegments.findIndex(r=>this.playerY>=r.y&&this.playerY<r.y+this.segmentHeight);if(t===-1)return;const e=this.pathSegments[t],i=e.width/2,s=e.centerX-i,a=e.centerX+i;if(this.playerX<s||this.playerX>a)if(this.graceTime<=0&&!this.shieldActive){console.log("[checkCollision] Hit wall!"),this.startDeath("You touched the wall!");return}else this.shieldActive&&(this.shieldActive=!1,this.shieldTimer=0,this.addFloatingText(this.playerX,this.playerY-40,"Shield Used!","#ff6b6b"),this.addCameraShake(15),this.screenFlash=.4,this.screenFlashColor="#ff6b6b",this.playSound("warning"),this.triggerHaptic("heavy"),this.playerX<s?this.playerX=s+20:this.playerX=a-20);const h=this.playerX-s,o=a-this.playerX,n=Math.min(h,o),l=e.width*.25;if(this.dangerLevel=Math.max(0,1-n/l),this.dangerLevel>.5){if(this.chromaticAberration=Math.max(this.chromaticAberration,this.dangerLevel*4),Math.random()<.5){const r=h<o?s:a;this.particles.push({x:r+(Math.random()-.5)*8,y:this.playerY+(Math.random()-.5)*25,vx:(this.playerX-r)*.1,vy:-2-Math.random()*3,life:1,maxLife:1,size:2+Math.random()*3,hue:0,type:"wall"})}this.dangerLevel>.8&&(this.addCameraShake(3),Math.random()<.1&&this.playSound("warning"),this.triggerHaptic("light"))}}checkMilestones(){const t=Math.floor(this.distance/500)*500;if(t>this.lastMilestone&&t>0){this.lastMilestone=t,this.milestoneText=t+"m",this.milestoneTimer=2e3,this.triggerHaptic("success"),this.playSound("milestone"),this.screenFlash=.5,this.screenFlashColor="#4ade80",this.addCameraShake(10);for(let i=0;i<50;i++){const s=Math.PI*2*i/50,a=3+Math.random()*5;this.particles.push({x:this.width/2,y:100,vx:Math.cos(s)*a,vy:Math.sin(s)*a+2,life:1,maxLife:1,size:3+Math.random()*4,hue:(this.hue+i*7)%360,type:"explosion"})}const e=Math.floor(t/10);this.score+=e,this.addFloatingText(this.width/2,150,"+"+e+" BONUS!","#4ade80")}}render(){const t=this.ctx;t.save();const e=this.width/2,i=this.height/2;t.translate(e,i),t.scale(this.cameraZoom,this.cameraZoom),t.translate(-e,-i),t.translate(this.cameraShakeX+this.cameraOffsetX,this.cameraShakeY+this.cameraOffsetY),this.drawBackground(),this.drawPath(),this.drawStars(),this.drawTrail(),(this.isPressed||this.gameState!=="PLAYING")&&this.drawPlayer(),this.drawParticles(),this.drawFloatingTexts(),t.restore(),this.drawPostProcessing(),(this.gameState==="PLAYING"||this.gameState==="DYING")&&this.drawHUD(),this.gameState==="START"&&this.drawStartOverlay()}drawBackground(){const t=this.ctx,e=t.createRadialGradient(this.width/2,this.height/2,0,this.width/2,this.height/2,this.width),i=(this.hue+180)%360;e.addColorStop(0,"hsl("+i+", 40%, 8%)"),e.addColorStop(.5,"hsl("+(i+20)%360+", 30%, 4%)"),e.addColorStop(1,"hsl("+(i+40)%360+", 20%, 2%)"),t.fillStyle=e,t.fillRect(-100,-100,this.width+200,this.height+200),t.globalAlpha=.08;for(let o=0;o<5;o++){const n=(o*300+this.time*.01)%(this.width+400)-200,l=(o*200+this.time*.008+this.distance*.2)%(this.height+400)-200,r=150+o*50,c=t.createRadialGradient(n,l,0,n,l,r);c.addColorStop(0,"hsl("+(this.hue+o*40)%360+", 60%, 40%)"),c.addColorStop(1,"transparent"),t.fillStyle=c,t.beginPath(),t.arc(n,l,r,0,Math.PI*2),t.fill()}t.globalAlpha=1;const s=50,a=this.distance*.4%s,h=.06+this.scrollSpeed*.006;t.strokeStyle="hsla("+this.hue+", 50%, 40%, "+h+")",t.lineWidth=1;for(let o=-s;o<this.width+s;o+=s){const n=Math.sin((o+this.time*8e-4)*.025)*6;t.beginPath(),t.moveTo(o+n,0),t.lineTo(o-n,this.height),t.stroke()}for(let o=a;o<this.height+s;o+=s)t.beginPath(),t.moveTo(0,o),t.lineTo(this.width,o),t.stroke();t.globalAlpha=.6;for(let o=0;o<40;o++){const n=(o*137.5+this.time*.015)%(this.width+40)-20,l=(o*89.3+this.distance*.25)%(this.height+40)-20,r=Math.sin(this.time*.004+o*2.3)*.5+.5,c=(.8+r*.8)*(1+o%3*.3);t.beginPath(),t.arc(n,l,c,0,Math.PI*2),t.fillStyle="hsl("+(this.hue+o*15)%360+", 70%, "+(50+r*30)+"%)",t.fill()}t.globalAlpha=1}drawPath(){const t=this.ctx;t.beginPath();for(let i=0;i<this.pathSegments.length;i++){const s=this.pathSegments[i],a=s.centerX-s.width/2;i===0?t.moveTo(a,s.y+this.segmentHeight):t.lineTo(a,s.y)}for(let i=this.pathSegments.length-1;i>=0;i--){const s=this.pathSegments[i];t.lineTo(s.centerX+s.width/2,s.y)}t.closePath();const e=t.createLinearGradient(0,0,0,this.height);e.addColorStop(0,"hsla("+this.hue+", 50%, 10%, 0.95)"),e.addColorStop(.5,"hsla("+(this.hue+25)%360+", 45%, 7%, 0.95)"),e.addColorStop(1,"hsla("+(this.hue+50)%360+", 40%, 5%, 0.95)"),t.fillStyle=e,t.fill(),t.shadowColor="hsla("+this.hue+", 100%, 50%, 0.3)",t.shadowBlur=30,t.fill(),t.shadowBlur=0,this.drawWalls()}drawWalls(){const t=this.ctx,e=this.dangerLevel>.5?(Math.sin(this.time*.025)+1)*.5:0,i=55+e*25;for(let s=3;s>=0;s--){const a=4+s*8,h=(.4-s*.1)*(1+e*.5);t.beginPath();for(let n=0;n<this.pathSegments.length;n++){const l=this.pathSegments[n],r=l.centerX-l.width/2;n===0?t.moveTo(r,l.y+this.segmentHeight):t.lineTo(r,l.y)}t.strokeStyle="hsla("+this.hue+", 100%, "+i+"%, "+h+")",t.lineWidth=a,t.lineCap="round",t.lineJoin="round",t.stroke();const o=(this.hue+50)%360;t.beginPath();for(let n=0;n<this.pathSegments.length;n++){const l=this.pathSegments[n],r=l.centerX+l.width/2;n===0?t.moveTo(r,l.y+this.segmentHeight):t.lineTo(r,l.y)}t.strokeStyle="hsla("+o+", 100%, "+i+"%, "+h+")",t.stroke()}if(this.scrollSpeed>5){const s=Math.min(.6,(this.scrollSpeed-5)/10),a=this.time*.02%50;t.setLineDash([5,45]),t.lineDashOffset=-a,t.beginPath();for(let h=0;h<this.pathSegments.length;h++){const o=this.pathSegments[h],n=o.centerX-o.width/2;h===0?t.moveTo(n,o.y+this.segmentHeight):t.lineTo(n,o.y)}t.strokeStyle="hsla("+this.hue+", 100%, 80%, "+s+")",t.lineWidth=2,t.stroke(),t.beginPath();for(let h=0;h<this.pathSegments.length;h++){const o=this.pathSegments[h],n=o.centerX+o.width/2;h===0?t.moveTo(n,o.y+this.segmentHeight):t.lineTo(n,o.y)}t.strokeStyle="hsla("+(this.hue+50)%360+", 100%, 80%, "+s+")",t.stroke(),t.setLineDash([])}}drawStars(){const t=this.ctx;for(const e of this.stars){if(e.collected)continue;const i=Math.sin(e.pulse)*.3+1,s=(e.type==="star"?14:18)*i,a=e.type==="star"?50:e.type==="shield"?140:280,h=t.createRadialGradient(e.x,e.y,0,e.x,e.y,s*2.5);if(h.addColorStop(0,"hsla("+a+", 100%, 70%, 0.8)"),h.addColorStop(.4,"hsla("+a+", 100%, 60%, 0.3)"),h.addColorStop(1,"transparent"),t.fillStyle=h,t.beginPath(),t.arc(e.x,e.y,s*2.5,0,Math.PI*2),t.fill(),t.save(),t.translate(e.x,e.y),t.rotate(this.time*.002),e.type==="star"){t.beginPath();for(let o=0;o<5;o++){const n=o*Math.PI*2/5-Math.PI/2,l=Math.cos(n)*s,r=Math.sin(n)*s,c=n+Math.PI/5,d=Math.cos(c)*s*.4,m=Math.sin(c)*s*.4;o===0?t.moveTo(l,r):t.lineTo(l,r),t.lineTo(d,m)}t.closePath(),t.fillStyle="#ffd700",t.fill(),t.strokeStyle="#fff",t.lineWidth=1.5,t.stroke()}else t.beginPath(),t.arc(0,0,s*.8,0,Math.PI*2),t.fillStyle=e.type==="shield"?"#4ade80":"#a78bfa",t.fill(),t.strokeStyle="#fff",t.lineWidth=2,t.stroke(),t.fillStyle="#fff",t.font="bold "+s*.8+"px sans-serif",t.textAlign="center",t.textBaseline="middle",t.fillText(e.type==="shield"?"S":"T",0,1);t.restore()}}drawTrail(){const t=this.ctx;if(!(this.trail.length<2)){if(this.shieldActive){t.globalAlpha=.3+Math.sin(this.time*.01)*.1;for(let e=1;e<this.trail.length;e++){const i=this.trail[e],s=(1-i.age)*.5;t.beginPath(),t.arc(i.x,i.y,25,0,Math.PI*2),t.fillStyle="hsla(140, 100%, 50%, "+s+")",t.fill()}t.globalAlpha=1}for(let e=1;e<this.trail.length;e++){const i=this.trail[e-1],s=this.trail[e],a=(1-s.age)*.9,h=s.size*(1-s.age*.4);t.beginPath(),t.moveTo(i.x,i.y),t.lineTo(s.x,s.y),t.strokeStyle="hsla("+this.hue+", 100%, 60%, "+a*.35+")",t.lineWidth=h*2.5,t.lineCap="round",t.stroke(),t.strokeStyle="hsla("+this.hue+", 100%, 70%, "+a+")",t.lineWidth=h,t.stroke(),t.strokeStyle="hsla("+this.hue+", 100%, 90%, "+a*.8+")",t.lineWidth=h*.35,t.stroke()}}}drawPlayer(){const t=this.ctx,e=this.playerX,i=this.playerY,s=Math.min(1,this.scrollSpeed/10);if(this.shieldActive){const n=Math.sin(this.time*.008)*.3+.7;t.beginPath(),t.arc(e,i,35+n*10,0,Math.PI*2),t.strokeStyle="hsla(140, 100%, 60%, "+.5*n+")",t.lineWidth=4,t.stroke(),t.beginPath(),t.arc(e,i,30+n*8,0,Math.PI*2),t.strokeStyle="hsla(140, 100%, 70%, 0.3)",t.lineWidth=2,t.stroke()}if(this.dangerLevel>.3&&!this.shieldActive){const n=Math.sin(this.time*.025)*.5+.5;t.beginPath(),t.arc(e,i,40+n*15,0,Math.PI*2),t.strokeStyle="hsla(0, 100%, 50%, "+this.dangerLevel*.6*n+")",t.lineWidth=3,t.stroke()}const a=50+s*25,h=t.createRadialGradient(e,i,0,e,i,a);h.addColorStop(0,"hsla("+this.hue+", 100%, 70%, 0.7)"),h.addColorStop(.3,"hsla("+this.hue+", 100%, 60%, 0.3)"),h.addColorStop(1,"transparent"),t.fillStyle=h,t.beginPath(),t.arc(e,i,a,0,Math.PI*2),t.fill();const o=t.createRadialGradient(e-4,i-4,0,e,i,16);if(o.addColorStop(0,"#fff"),o.addColorStop(.4,"hsl("+this.hue+", 100%, 80%)"),o.addColorStop(1,"hsl("+this.hue+", 100%, 50%)"),t.beginPath(),t.arc(e,i,16,0,Math.PI*2),t.fillStyle=o,t.fill(),this.isPressed&&this.gameState==="PLAYING"){const n=(Math.sin(this.time*.007)+1)*.5;t.beginPath(),t.arc(e,i,24+n*14,0,Math.PI*2),t.strokeStyle="hsla("+this.hue+", 100%, 70%, "+(.6-n*.4)+")",t.lineWidth=2,t.stroke()}if(this.combo>0){const n=1+Math.sin(this.time*.01)*.1;t.save(),t.translate(e,i-40),t.scale(n,n),t.font="bold 16px 'Orbitron', sans-serif",t.fillStyle="#ffd700",t.textAlign="center",t.shadowColor="#ffd700",t.shadowBlur=10,t.fillText(this.combo+"x",0,0),t.restore()}if(this.perfectCenterBonus>3){const n=Math.min(1,(this.perfectCenterBonus-3)/7);t.beginPath(),t.arc(e,i,8,0,Math.PI*2),t.fillStyle="hsla(50, 100%, 70%, "+n+")",t.fill()}}drawParticles(){const t=this.ctx;for(const e of this.particles){const i=e.life/e.maxLife;if(e.type==="speedline")t.beginPath(),t.moveTo(e.x,e.y),t.lineTo(e.x,e.y+35*i),t.strokeStyle="hsla("+e.hue+", 80%, 60%, "+i*.4+")",t.lineWidth=e.size,t.stroke();else if(e.type==="ring")t.beginPath(),t.arc(e.x,e.y,e.size,0,Math.PI*2),t.strokeStyle="hsla("+e.hue+", 100%, 70%, "+i*.5+")",t.lineWidth=3,t.stroke();else{const s=e.size*i;t.beginPath(),t.arc(e.x,e.y,s*2,0,Math.PI*2),t.fillStyle="hsla("+e.hue+", 100%, 60%, "+i*.25+")",t.fill(),t.beginPath(),t.arc(e.x,e.y,s,0,Math.PI*2),t.fillStyle="hsla("+e.hue+", 100%, 70%, "+i+")",t.fill()}}}drawFloatingTexts(){const t=this.ctx;for(const e of this.floatingTexts)t.save(),t.translate(e.x,e.y),t.scale(e.scale,e.scale),t.globalAlpha=e.life,t.font="bold 18px 'Orbitron', sans-serif",t.fillStyle=e.color,t.textAlign="center",t.shadowColor=e.color,t.shadowBlur=10,t.fillText(e.text,0,0),t.restore()}drawPostProcessing(){const t=this.ctx;this.screenFlash>0&&(t.fillStyle=this.screenFlashColor,t.globalAlpha=this.screenFlash*.45,t.fillRect(0,0,this.width,this.height),t.globalAlpha=1),this.chromaticAberration>.5&&(t.globalCompositeOperation="screen",t.globalAlpha=this.chromaticAberration*.015,t.fillStyle="#ff0000",t.fillRect(-this.chromaticAberration,0,this.width,this.height),t.fillStyle="#0000ff",t.fillRect(this.chromaticAberration,0,this.width,this.height),t.globalCompositeOperation="source-over",t.globalAlpha=1),this.slowMoActive&&(t.fillStyle="hsla(280, 50%, 20%, 0.15)",t.fillRect(0,0,this.width,this.height));const e=t.createRadialGradient(this.width/2,this.height/2,this.width*.25,this.width/2,this.height/2,this.width*.85);if(e.addColorStop(0,"rgba(0, 0, 0, 0)"),e.addColorStop(.6,"rgba(0, 0, 0, 0.15)"),e.addColorStop(1,"rgba(0, 0, 0, 0.6)"),t.fillStyle=e,t.fillRect(0,0,this.width,this.height),this.dangerLevel>.3&&!this.shieldActive){const i=t.createRadialGradient(this.width/2,this.height/2,this.width*.15,this.width/2,this.height/2,this.width*.55);i.addColorStop(0,"transparent"),i.addColorStop(1,"rgba(255, 0, 0, "+this.dangerLevel*.35+")"),t.fillStyle=i,t.fillRect(0,0,this.width,this.height)}this.pulseEffect>0&&(t.fillStyle="hsla(50, 100%, 70%, "+this.pulseEffect*.12+")",t.fillRect(0,0,this.width,this.height))}drawHUD(){const t=this.ctx,e=this.isMobile?80:25;if(t.save(),t.font="bold 36px 'Orbitron', sans-serif",t.textAlign="center",t.shadowColor="rgba(255, 255, 255, 0.5)",t.shadowBlur=15,t.fillStyle="#fff",t.fillText(Math.floor(this.score).toString(),this.width/2,e+35),t.restore(),t.font="14px 'Space Mono', monospace",t.fillStyle="rgba(255, 255, 255, 0.5)",t.textAlign="center",t.fillText(Math.floor(this.distance)+"m",this.width/2,e+55),this.graceTime>0){const h=this.graceTime/this.graceDuration,o=160,n=8,l=(this.width-o)/2,r=e+72;t.fillStyle="rgba(0, 0, 0, 0.5)",this.roundedRect(t,l-2,r-2,o+4,n+4,6),t.fill();const c=t.createLinearGradient(l,0,l+o*h,0);c.addColorStop(0,"#4ade80"),c.addColorStop(1,"#22c55e"),t.fillStyle=c,this.roundedRect(t,l,r,o*h,n,4),t.fill(),t.font="bold 10px 'Space Mono', monospace",t.fillStyle="#4ade80",t.fillText("SAFE ZONE",this.width/2,r+22)}if(this.milestoneTimer>0){const h=Math.min(1,this.milestoneTimer/500),o=1+(1-Math.min(1,this.milestoneTimer/300))*.3;t.save(),t.translate(this.width/2,this.height*.25),t.scale(o,o),t.globalAlpha=h,t.font="bold 48px 'Orbitron', sans-serif",t.fillStyle="#4ade80",t.shadowColor="#4ade80",t.shadowBlur=20,t.textAlign="center",t.fillText(this.milestoneText,0,0),t.restore()}const i=this.height-60;let s=30;if(this.shieldActive){const h=this.shieldTimer/5e3;t.fillStyle="rgba(74, 222, 128, 0.3)",t.beginPath(),t.arc(s,i,22,0,Math.PI*2),t.fill(),t.strokeStyle="#4ade80",t.lineWidth=3,t.beginPath(),t.arc(s,i,22,-Math.PI/2,-Math.PI/2+Math.PI*2*h),t.stroke(),t.font="bold 14px sans-serif",t.fillStyle="#fff",t.textAlign="center",t.fillText("S",s,i+5),s+=55}if(this.slowMoActive){const h=this.slowMoTimer/4e3;t.fillStyle="rgba(167, 139, 250, 0.3)",t.beginPath(),t.arc(s,i,22,0,Math.PI*2),t.fill(),t.strokeStyle="#a78bfa",t.lineWidth=3,t.beginPath(),t.arc(s,i,22,-Math.PI/2,-Math.PI/2+Math.PI*2*h),t.stroke(),t.font="bold 14px sans-serif",t.fillStyle="#fff",t.textAlign="center",t.fillText("T",s,i+5)}const a=(this.scrollSpeed-4)/(this.maxScrollSpeed-4);if(a>0){const l=this.height/2-60;t.fillStyle="rgba(255, 255, 255, 0.08)",this.roundedRect(t,20,l,6,120,3),t.fill();const r=t.createLinearGradient(0,l+120,0,l);r.addColorStop(0,"hsl("+this.hue+", 100%, 50%)"),r.addColorStop(1,"hsl("+(this.hue+60)%360+", 100%, 70%)"),t.fillStyle=r;const c=120*Math.min(1,a);this.roundedRect(t,20,l+120-c,6,c,3),t.fill()}if(this.combo>0&&this.comboTimer>0){const h=this.comboTimer/3500,o=80,n=this.width/2-o/2,l=e+92;t.fillStyle="rgba(255, 215, 0, 0.2)",this.roundedRect(t,n,l,o,4,2),t.fill(),t.fillStyle="#ffd700",this.roundedRect(t,n,l,o*h,4,2),t.fill()}}drawStartOverlay(){const t=this.ctx;t.fillStyle="rgba(5, 5, 15, 0.9)",t.fillRect(0,0,this.width,this.height);for(let o=0;o<60;o++){const n=(o*137.5+this.time*.025)%(this.width+40)-20,l=(o*89.3+this.time*.018)%(this.height+40)-20,r=1.5+Math.sin(this.time*.003+o)*.6,c=.25+Math.sin(this.time*.002+o*.5)*.15;t.beginPath(),t.arc(n,l,r,0,Math.PI*2),t.fillStyle="hsla("+(this.hue+o*6)%360+", 80%, 60%, "+c+")",t.fill()}const e=this.height*.36;t.save();const i=Math.sin(this.time*.003)*.3+.7;t.font="bold 56px 'Orbitron', sans-serif",t.textAlign="center",t.shadowColor="hsl("+this.hue+", 100%, 60%)",t.shadowBlur=35*i,t.fillStyle="hsl("+this.hue+", 100%, 70%)",t.fillText("FINGER FLOW",this.width/2,e),t.shadowBlur=0,t.fillStyle="#fff",t.fillText("FINGER FLOW",this.width/2,e),t.restore(),t.font="18px 'Space Mono', monospace",t.fillStyle="rgba(255, 255, 255, 0.7)",t.fillText("Don't lift your finger!",this.width/2,e+40);const s=this.height*.52,a=[["Hold to play","Navigate the path"],["Collect stars","Never let go"]];t.font="14px 'Space Mono', monospace",a.forEach((o,n)=>{o.forEach((l,r)=>{const c=this.width/2+(r-.5)*140,d=s+n*35,m=.5+Math.sin(this.time*.003+n+r)*.2;t.fillStyle="rgba(255, 255, 255, "+m+")",t.fillText(l,c,d)})});const h=(Math.sin(this.time*.004)+1)*.5;t.save(),t.font="bold 26px 'Orbitron', sans-serif",t.shadowColor="hsl("+this.hue+", 100%, 60%)",t.shadowBlur=25*h,t.fillStyle="hsla("+this.hue+", 100%, 70%, "+(.6+h*.4)+")",t.fillText("TOUCH TO START",this.width/2,this.height*.76),t.restore(),this.drawAnimatedFinger(this.width/2,this.height*.87)}drawAnimatedFinger(t,e){const i=this.ctx,s=Math.sin(this.time*.005)*10,a=1+Math.sin(this.time*.003)*.08;i.save(),i.translate(t,e+s),i.scale(a,a),i.beginPath(),i.ellipse(0,0,18,30,0,0,Math.PI*2),i.fillStyle="rgba(255, 255, 255, 0.15)",i.fill(),i.strokeStyle="rgba(255, 255, 255, 0.4)",i.lineWidth=2,i.stroke(),i.beginPath(),i.arc(0,18,8,0,Math.PI*2),i.fillStyle="hsl("+this.hue+", 100%, 70%)",i.fill();for(let h=0;h<3;h++){const o=(this.time*.003+h*.33)%1,n=18+o*45,l=(1-o)*.4;i.beginPath(),i.arc(0,18,n,0,Math.PI*2),i.strokeStyle="hsla("+this.hue+", 100%, 70%, "+l+")",i.lineWidth=2,i.stroke()}i.restore()}gameLoop(){const t=performance.now(),e=Math.min(t-this.lastTime,50);this.lastTime=t,this.update(e),this.render(),requestAnimationFrame(()=>this.gameLoop())}}document.addEventListener("DOMContentLoaded",()=>{new f});</script>
</head>
<body>
  <canvas id="gameCanvas"></canvas>

  <!-- Settings Button -->
  <button id="settingsBtn" aria-label="Settings">
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
    </svg>
  </button>

  <!-- Settings Panel -->
  <div id="settingsPanel">
    <button id="closeSettings">&times;</button>
    <h2>Settings</h2>
    
    <div class="settings-row">
      <label>Music</label>
      <div class="toggle">
        <input type="checkbox" id="musicToggle" checked>
        <span class="toggle-slider"></span>
      </div>
    </div>
    
    <div class="settings-row">
      <label>Sound FX</label>
      <div class="toggle">
        <input type="checkbox" id="fxToggle" checked>
        <span class="toggle-slider"></span>
      </div>
    </div>
    
    <div class="settings-row">
      <label>Haptics</label>
      <div class="toggle">
        <input type="checkbox" id="hapticsToggle" checked>
        <span class="toggle-slider"></span>
      </div>
    </div>
  </div>

  <!-- Game Over Screen -->
  <div id="gameOverScreen">
    <div class="glow-line top"></div>
    <h1>GAME OVER</h1>
    <p id="deathReason">You touched the wall!</p>
    <div id="finalScore">0</div>
    <p class="score-label">Final Score</p>
    <p id="maxCombo">Max Combo: 0x</p>
    <p class="restart-hint">TAP TO RESTART</p>
    <div class="glow-line bottom"></div>
  </div>

</body>
</html>
