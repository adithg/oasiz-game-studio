<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no, minimal-ui">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Paper Plane Asteroid Survivor</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Caveat:wght@400;500;600;700&family=Patrick+Hand&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            overflow: hidden;
            width: 100%;
            height: 100%;
            background: #1a1a2e;
            font-family: 'Patrick Hand', 'Caveat', cursive;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Game Container - constrained on desktop */

        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            max-width: 480px;
            max-height: 850px;
            background: #f5f5dc;
            overflow: hidden;
            border-radius: 24px;
            border: 6px solid #2d2d2d;
            box-shadow: 0 0 0 4px #4a4a4a, 0 25px 60px rgba(0, 0, 0, 0.5);
        }

        /* Mobile: fullscreen, no border */

        @media (pointer: coarse) {
            #game-container {
                max-width: none;
                max-height: none;
                border: none;
                border-radius: 0;
                box-shadow: none;
            }
            html, body {
                background: #f5f5dc;
            }
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }

        /* ============= OVERLAYS ============= */

        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            pointer-events: none;
            background: rgba(245, 245, 220, 0.85);
        }

        .overlay.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .overlay:not(.hidden) {
            pointer-events: auto;
        }

        .content {
            text-align: center;
            padding: 30px;
            max-width: 90%;
        }

        /* ============= BUTTONS ============= */

        .btn {
            background: #fff;
            color: #2d2d2d;
            border: 3px solid #2d2d2d;
            padding: 14px 40px;
            font-family: 'Patrick Hand', cursive;
            font-size: 1.4rem;
            cursor: pointer;
            border-radius: 8px;
            box-shadow: 4px 4px 0 #2d2d2d;
            transition: all 0.1s ease;
            position: relative;
        }

        .btn:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 #2d2d2d;
        }

        .btn:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0 #2d2d2d;
        }

        .btn-secondary {
            background: transparent;
            border: 2px dashed #6d6d6d;
            color: #6d6d6d;
            box-shadow: none;
        }

        .btn-secondary:hover {
            background: rgba(0,0,0,0.05);
            box-shadow: none;
            transform: none;
        }

        /* ============= DAMAGE OVERLAY ============= */

        #damageOverlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(ellipse at center, transparent 40%, rgba(255, 50, 50, 0.3) 100%);
            pointer-events: none;
            opacity: 0;
            z-index: 100;
            transition: opacity 0.15s ease-out;
        }

        #damageOverlay.active {
            opacity: 1;
            animation: damageFlash 0.3s ease-out;
        }

        @keyframes damageFlash {
            0% { opacity: 0.8; background: radial-gradient(ellipse at center, rgba(255, 100, 100, 0.2) 0%, rgba(255, 50, 50, 0.5) 100%); }
            50% { opacity: 1; }
            100% { opacity: 0; }
        }

        /* ============= BOSS ANNOUNCEMENT ============= */

        #bossAnnouncement {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            opacity: 0;
            z-index: 200;
            background: radial-gradient(ellipse at center, rgba(0, 0, 0, 0.3) 0%, rgba(0, 0, 0, 0.6) 100%);
            transition: opacity 0.3s ease;
        }

        #bossAnnouncement.active {
            opacity: 1;
            animation: bossShake 0.5s ease-out;
        }

        .boss-text {
            font-family: 'Architects Daughter', cursive;
            font-size: 3.5rem;
            font-weight: bold;
            color: #ff4444;
            text-shadow: 
                3px 3px 0 #000,
                -1px -1px 0 #000,
                1px -1px 0 #000,
                -1px 1px 0 #000,
                0 0 20px rgba(255, 68, 68, 0.8);
            letter-spacing: 4px;
            animation: bossPulse 0.3s ease-in-out infinite alternate;
        }

        @keyframes bossShake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); }
            20%, 40%, 60%, 80% { transform: translateX(8px); }
        }

        @keyframes bossPulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.05); }
        }

        @media (pointer: coarse) {
            .boss-text {
                font-size: 2.5rem;
            }
        }

        /* ============= HUD ============= */

        #hud {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 45px 75px 10px 75px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            z-index: 5;
            pointer-events: none;
        }

        @media (pointer: coarse) {
            #hud {
                padding-top: 120px;
            }
        }

        .hud-left, .hud-right {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .hud-center {
            text-align: center;
        }

        .hud-lives {
            display: flex;
            justify-content: center;
            gap: 6px;
            margin-bottom: 8px;
        }

        .life-heart {
            font-size: 1.4rem;
            transition: transform 0.2s ease, opacity 0.2s ease;
        }

        .life-heart.filled {
            color: #ff4d4d;
            text-shadow: 0 0 6px rgba(255, 77, 77, 0.5);
        }

        .life-heart.empty {
            color: #ccc;
            opacity: 0.4;
        }

        @media (pointer: coarse) {
            .life-heart {
                font-size: 1.6rem;
            }
        }

        .hud-label {
            font-size: 0.9rem;
            color: #6d6d6d;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .hud-value {
            font-size: 2rem;
            font-weight: 700;
            color: #2d2d2d;
            font-family: 'Caveat', cursive;
        }

        .hud-small {
            font-size: 0.85rem;
            color: #888;
        }

        /* Progress Bar */

        .progress-bar-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            min-width: 120px;
        }

        .progress-bar-bg {
            width: 100%;
            height: 12px;
            background: #e8e4dc;
            border: 2px solid #4a4a4a;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.15);
        }

        .progress-bar-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #7cb342, #8bc34a);
            border-radius: 4px;
            transition: width 0.2s ease-out;
        }

        .progress-text {
            font-size: 0.9rem;
            color: #4a4a4a;
            font-family: 'Caveat', cursive;
            font-weight: 600;
        }

        @media (pointer: coarse) {
            .progress-bar-container {
                min-width: 100px;
            }
            .progress-bar-bg {
                height: 10px;
            }
        }

        /* Pause Button */

        #pauseBtn {
            position: absolute;
            top: 45px;
            right: 20px;
            width: 44px;
            height: 44px;
            background: rgba(255,255,255,0.8);
            border: 2px solid #2d2d2d;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 15;
            pointer-events: auto;
        }

        @media (pointer: coarse) {
            #pauseBtn {
                top: 120px;
            }
        }

        #pauseBtn svg {
            width: 20px;
            height: 20px;
            fill: #2d2d2d;
        }

        /* Settings Button */

        #settingsBtn {
            position: absolute;
            top: 45px;
            left: 20px;
            width: 44px;
            height: 44px;
            background: rgba(255,255,255,0.8);
            border: 2px solid #2d2d2d;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 15;
        }

        @media (pointer: coarse) {
            #settingsBtn {
                top: 120px;
            }
        }

        #settingsBtn svg {
            width: 20px;
            height: 20px;
            fill: #2d2d2d;
        }

        /* ============= UPGRADE DOTS ============= */

        .upgrade-indicators {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 30px;
            z-index: 5;
            pointer-events: none;
        }

        .upgrade-dots {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .upgrade-dots .label {
            font-size: 0.7rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .dots-row {
            display: flex;
            gap: 4px;
        }

        .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 2px solid #2d2d2d;
            background: transparent;
            transition: background 0.3s ease;
        }

        .dot.filled {
            background: #2d2d2d;
        }

        /* ============= START SCREEN ============= */

        #startScreen .title {
            font-family: 'Caveat', cursive;
            font-size: 3rem;
            font-weight: 700;
            color: #2d2d2d;
            margin-bottom: 10px;
            letter-spacing: 2px;
        }

        #startScreen .subtitle {
            font-size: 1.2rem;
            color: #6d6d6d;
            margin-bottom: 20px;
        }

        /* Demo Animation Container */

        .demo-container {
            width: 280px;
            height: 200px;
            background: rgba(255,255,255,0.6);
            border: 3px solid #2d2d2d;
            border-radius: 16px;
            margin: 0 auto 25px auto;
            box-shadow: 4px 4px 0 #2d2d2d;
            overflow: hidden;
            position: relative;
        }

        #demoCanvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* Start Screen Buttons */

        .start-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: center;
        }

        .btn-planes {
            background: transparent;
            border: 2px dashed #6d6d6d;
            color: #6d6d6d;
            padding: 10px 25px;
            font-size: 1.1rem;
        }

        .btn-planes:hover {
            background: rgba(0,0,0,0.05);
            box-shadow: none;
            transform: none;
        }

        .selected-plane-label {
            font-size: 0.9rem;
            color: #888;
            margin-top: 5px;
        }

        .selected-plane-name {
            font-weight: 600;
            color: #2d2d2d;
        }

        /* ============= GALLERY OVERLAY ============= */

        #galleryScreen {
            background: rgba(245, 245, 220, 0.95);
        }

        #galleryScreen .content {
            max-width: 900px;
        }

        .plane-select-title {
            font-family: 'Caveat', cursive;
            font-size: 2.5rem;
            color: #2d2d2d;
            margin-bottom: 25px;
        }

        .plane-selection {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 30px;
        }

        .plane-card {
            background: #fff;
            border: 3px solid #2d2d2d;
            border-radius: 12px;
            padding: 15px 12px;
            width: 110px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 3px 3px 0 #2d2d2d;
        }

        .plane-card:hover {
            transform: translateY(-3px);
            box-shadow: 5px 5px 0 #2d2d2d;
        }

        .plane-card.selected {
            background: #fffde7;
            border-color: #f9a825;
            box-shadow: 3px 3px 0 #f9a825;
        }

        .plane-icon {
            font-size: 1.4rem;
            margin: 0 auto 8px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #d0d0c0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #2d2d2d;
        }

        .gallery-content {
            max-height: 80vh;
            overflow-y: auto;
        }

        .gallery-section {
            margin-bottom: 28px;
            text-align: left;
        }

        .gallery-title {
            font-size: 1.3rem;
            color: #2d2d2d;
            margin-bottom: 14px;
            border-bottom: 2px solid #d4d4c4;
            padding-bottom: 6px;
        }

        .boss-gallery {
            display: flex;
            justify-content: center;
        }

        .boss-card {
            background: #fff;
            border: 2px solid #d0d0c0;
            padding: 16px;
            border-radius: 12px;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
        }

        .boss-name {
            font-size: 1.3rem;
            margin-bottom: 6px;
            color: #2d2d2d;
        }

        .boss-desc {
            color: #555;
            font-size: 0.95rem;
        }

        .modifier-gallery {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }

        .modifier-chip {
            background: #fff;
            border: 1px solid #d0d0c0;
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 0.85rem;
            color: #2d2d2d;
        }

        /* ============= ITEM CHOICE SCREEN ============= */

        .item-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 18px;
        }

        .item-card {
            background: #fff;
            border: 2px solid #d0d0c0;
            border-radius: 16px;
            padding: 18px;
            text-align: left;
            box-shadow: 0 8px 18px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .item-card.hidden {
            display: none;
        }

        .item-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 22px rgba(0, 0, 0, 0.12);
        }

        .item-card.cursed {
            border-color: #8b3a3a;
            box-shadow: 0 0 18px rgba(139, 58, 58, 0.25);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .item-category {
            font-size: 0.7rem;
            letter-spacing: 2px;
            color: #6d6d6d;
        }

        .item-curse {
            font-size: 0.7rem;
            color: #b43c3c;
            letter-spacing: 1px;
        }

        .item-name {
            font-size: 1.2rem;
            margin-bottom: 8px;
            color: #2d2d2d;
        }

        .item-desc {
            font-size: 0.9rem;
            color: #5d5d5d;
            line-height: 1.4;
        }

        /* ============= ITEM INVENTORY ============= */

        .item-inventory {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            padding: 0 12px;
            z-index: 6;
            pointer-events: none;
        }

        .item-inventory.hidden {
            display: none;
        }

        .item-chip {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #d0d0c0;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 0.75rem;
            color: #2d2d2d;
            white-space: nowrap;
        }

        .item-chip.cursed {
            background: rgba(80, 30, 30, 0.85);
            border-color: #8b3a3a;
            color: #ffd1d1;
        }

        .hud-shield {
            font-size: 0.8rem;
            color: #4b6cb7;
            margin-bottom: 4px;
            min-height: 1em;
        }

        .plane-name {
            font-size: 0.9rem;
            font-weight: 600;
            color: #2d2d2d;
            margin-bottom: 5px;
        }

        .plane-quirk {
            font-size: 0.7rem;
            color: #888;
            line-height: 1.3;
        }

        /* ============= UPGRADE SCREEN ============= */

        #upgradeScreen {
            background: rgba(245, 245, 220, 0.95);
        }

        .upgrade-title {
            font-family: 'Caveat', cursive;
            font-size: 2.5rem;
            color: #2d2d2d;
            margin-bottom: 10px;
        }

        .upgrade-timer {
            font-size: 1.2rem;
            color: #888;
            margin-bottom: 30px;
        }

        .upgrade-timer span {
            font-weight: 700;
            color: #2d2d2d;
        }

        .upgrade-cards {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .upgrade-card {
            background: #fff;
            border: 3px solid #2d2d2d;
            border-radius: 12px;
            padding: 20px 15px;
            width: 130px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 4px 4px 0 #2d2d2d;
        }

        .upgrade-card:hover {
            transform: translateY(-5px);
            box-shadow: 6px 8px 0 #2d2d2d;
        }

        .upgrade-card.maxed {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .upgrade-card.maxed:hover {
            transform: none;
            box-shadow: 4px 4px 0 #2d2d2d;
        }

        .upgrade-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #f5f5dc;
            border: 2px solid #2d2d2d;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
            font-size: 1.3rem;
            font-weight: 700;
        }

        .upgrade-tree-name {
            font-size: 0.75rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 4px;
        }

        .upgrade-tier {
            font-size: 0.7rem;
            color: #6d6d6d;
            margin-bottom: 8px;
        }

        .upgrade-name {
            font-size: 1rem;
            font-weight: 600;
            color: #2d2d2d;
            margin-bottom: 6px;
        }

        .upgrade-desc {
            font-size: 0.7rem;
            color: #666;
            line-height: 1.4;
        }

        /* ============= PAUSE SCREEN ============= */

        #pauseScreen {
            background: rgba(0, 0, 0, 0.4);
        }

        #pauseScreen .content {
            background: #fff;
            border: 4px solid #2d2d2d;
            border-radius: 16px;
            box-shadow: 6px 6px 0 #2d2d2d;
            padding: 40px;
        }

        .pause-title {
            font-family: 'Caveat', cursive;
            font-size: 2.5rem;
            color: #2d2d2d;
            margin-bottom: 30px;
        }

        .pause-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* ============= GAME OVER SCREEN ============= */

        #gameOverScreen .game-over-title {
            font-family: 'Caveat', cursive;
            font-size: 3rem;
            color: #2d2d2d;
            margin-bottom: 30px;
        }

        .final-stats {
            background: #fff;
            border: 3px solid #2d2d2d;
            border-radius: 12px;
            padding: 25px 40px;
            margin-bottom: 30px;
            box-shadow: 4px 4px 0 #2d2d2d;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dashed #ccc;
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-label {
            font-size: 1rem;
            color: #6d6d6d;
        }

        .stat-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: #2d2d2d;
            font-family: 'Caveat', cursive;
        }

        .upgrade-summary {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px dashed #ccc;
        }

        .summary-item {
            text-align: center;
        }

        .summary-label {
            font-size: 0.7rem;
            color: #888;
            text-transform: uppercase;
        }

        .summary-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: #2d2d2d;
        }

        .game-over-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* ============= SETTINGS MODAL ============= */

        #settingsModal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            border: 4px solid #2d2d2d;
            border-radius: 16px;
            padding: 30px 40px;
            z-index: 100;
            box-shadow: 6px 6px 0 #2d2d2d;
            min-width: 280px;
        }

        #settingsModal.hidden {
            display: none;
        }

        .settings-title {
            font-family: 'Caveat', cursive;
            font-size: 2rem;
            color: #2d2d2d;
            margin-bottom: 25px;
            text-align: center;
        }

        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px dashed #ddd;
        }

        .settings-row:last-of-type {
            border-bottom: none;
        }

        .settings-label {
            font-size: 1.1rem;
            color: #2d2d2d;
        }

        .toggle {
            width: 50px;
            height: 28px;
            background: #ddd;
            border-radius: 14px;
            position: relative;
            cursor: pointer;
            transition: background 0.2s ease;
            border: 2px solid #2d2d2d;
        }

        .toggle.active {
            background: #8bc34a;
        }

        .toggle::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: #fff;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.2s ease;
            border: 2px solid #2d2d2d;
        }

        .toggle.active::after {
            transform: translateX(22px);
        }

        .settings-close {
            margin-top: 25px;
            width: 100%;
        }

        /* ============= RESPONSIVE ============= */

        @media (max-width: 500px) {
            .plane-selection {
                gap: 10px;
            }
            .plane-card {
                width: 100px;
                padding: 15px 10px;
            }
            .plane-icon {
                font-size: 2rem;
            }
            .upgrade-card {
                width: 110px;
                padding: 15px 10px;
            }
            #startScreen .title {
                font-size: 2.2rem;
            }
        }
    </style>
  <script type="module" crossorigin>(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const i of a)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(a){const i={};return a.integrity&&(i.integrity=a.integrity),a.referrerPolicy&&(i.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?i.credentials="include":a.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(a){if(a.ep)return;a.ep=!0;const i=t(a);fetch(a.href,i)}})();const n={PLAYER_Y_RATIO:.85,PLAYER_WIDTH:50,PLAYER_HEIGHT:60,PLAYER_SPEED:8,PLAYER_FIRE_RATE:333,BULLET_SPEED:12,BULLET_POOL_SIZE:200,ASTEROID_POOL_SIZE:100,ASTEROID_SIZES:{large:{radius:58,health:4,speed:2,coins:15},medium:{radius:42,health:2,speed:2.8,coins:8},small:{radius:28,health:1,speed:3.5,coins:3}},SPAWN_INTERVAL_START:1800,SPAWN_INTERVAL_MIN:350,BOSS_HEALTH:60,BOSS_RADIUS:120,BOSS_THROW_INTERVAL:3e3,BOSS_ASTEROID_HEALTH:10,BOSS_MAX_THROWS:5,BOSS_Y_POSITION:180,DRONE_ORBIT_RADIUS:60,PARTICLE_POOL_SIZE:500,SPEED_INCREASE_INTERVAL:6e4,HEALTH_INCREASE_INTERVAL:6e4,BACKGROUND_SCROLL_SPEED:50,GRID_SIZE:40,PAPER_BG:"#f5f5dc",GRID_LINE:"#d4d4c4",PENCIL_DARK:"#2d2d2d",PENCIL_MEDIUM:"#4a4a4a",PENCIL_LIGHT:"#6d6d6d",COIN_GOLD:"#ffd700",FONT_FAMILY:"Caveat, cursive"};function S(f,e,t){return f+(e-f)*t}function b(f,e,t){return Math.max(e,Math.min(t,f))}function v(f,e){return f+Math.random()*(e-f)}function p(f,e,t,s){return Math.sqrt((t-f)**2+(s-e)**2)}function E(f){return 1+2.70158*Math.pow(f-1,3)+1.70158*Math.pow(f-1,2)}class I{listeners=new Map;on(e,t){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t)}off(e,t){const s=this.listeners.get(e);if(s){const a=s.indexOf(t);a!==-1&&s.splice(a,1)}}emit(e,t){const s=this.listeners.get(e);s&&s.forEach(a=>a(t))}}class T{pool=[];createFn;resetFn;constructor(e,t,s=0){this.createFn=e,this.resetFn=t;for(let a=0;a<s;a++)this.pool.push(e())}acquire(){return this.pool.length>0?this.pool.pop():this.createFn()}release(e){this.resetFn(e),this.pool.push(e)}reset(){this.pool=[]}}class A{ctx=null;masterGain=null;musicGain=null;sfxGain=null;initialized=!1;settings;constructor(e){this.settings=e,console.log("[AudioManager] Created")}init(){if(!this.initialized)try{this.ctx=new(window.AudioContext||window.webkitAudioContext),this.masterGain=this.ctx.createGain(),this.masterGain.gain.value=.5,this.masterGain.connect(this.ctx.destination),this.musicGain=this.ctx.createGain(),this.musicGain.gain.value=.3,this.musicGain.connect(this.masterGain),this.sfxGain=this.ctx.createGain(),this.sfxGain.gain.value=.5,this.sfxGain.connect(this.masterGain),this.initialized=!0,console.log("[AudioManager.init] Audio context initialized")}catch(e){console.warn("[AudioManager.init] Failed:",e)}}playShoot(){if(!this.ctx||!this.sfxGain||!this.settings.fx)return;const e=this.ctx.currentTime,t=this.ctx.createOscillator(),s=this.ctx.createGain();t.type="square",t.frequency.setValueAtTime(800,e),t.frequency.exponentialRampToValueAtTime(200,e+.05),s.gain.setValueAtTime(.1,e),s.gain.exponentialRampToValueAtTime(.01,e+.05),t.connect(s),s.connect(this.sfxGain),t.start(e),t.stop(e+.06)}playHit(){if(!this.ctx||!this.sfxGain||!this.settings.fx)return;const e=this.ctx.currentTime,t=this.ctx.createOscillator(),s=this.ctx.createGain();t.type="sawtooth",t.frequency.setValueAtTime(150,e),t.frequency.exponentialRampToValueAtTime(50,e+.1),s.gain.setValueAtTime(.15,e),s.gain.exponentialRampToValueAtTime(.01,e+.1),t.connect(s),s.connect(this.sfxGain),t.start(e),t.stop(e+.12)}playDestroy(e){if(!this.ctx||!this.sfxGain||!this.settings.fx)return;const t=this.ctx.currentTime,s=e==="large"?80:e==="medium"?120:200,a=this.ctx.sampleRate*.2,i=this.ctx.createBuffer(1,a,this.ctx.sampleRate),o=i.getChannelData(0);for(let d=0;d<a;d++)o[d]=(Math.random()*2-1)*Math.exp(-d/(this.ctx.sampleRate*.05));const r=this.ctx.createBufferSource();r.buffer=i;const l=this.ctx.createBiquadFilter();l.type="bandpass",l.frequency.value=s*4,l.Q.value=1;const c=this.ctx.createGain();c.gain.setValueAtTime(.2,t),c.gain.exponentialRampToValueAtTime(.01,t+.15),r.connect(l),l.connect(c),c.connect(this.sfxGain),r.start(t)}playCoin(){if(!this.ctx||!this.sfxGain||!this.settings.fx)return;const e=this.ctx.currentTime,t=this.ctx.createOscillator(),s=this.ctx.createGain();t.type="sine",t.frequency.setValueAtTime(880,e),t.frequency.setValueAtTime(1100,e+.05),s.gain.setValueAtTime(.1,e),s.gain.exponentialRampToValueAtTime(.01,e+.15),t.connect(s),s.connect(this.sfxGain),t.start(e),t.stop(e+.16)}playUpgrade(){if(!this.ctx||!this.sfxGain||!this.settings.fx)return;const e=this.ctx.currentTime;[523,659,784,1047].forEach((s,a)=>{const i=this.ctx.createOscillator(),o=this.ctx.createGain();i.type="triangle",i.frequency.value=s,o.gain.setValueAtTime(.08,e+a*.08),o.gain.exponentialRampToValueAtTime(.01,e+a*.08+.15),i.connect(o),o.connect(this.sfxGain),i.start(e+a*.08),i.stop(e+a*.08+.2)})}playGameOver(){if(!this.ctx||!this.sfxGain||!this.settings.fx)return;const e=this.ctx.currentTime,t=this.ctx.createOscillator(),s=this.ctx.createGain();t.type="sawtooth",t.frequency.setValueAtTime(300,e),t.frequency.exponentialRampToValueAtTime(80,e+.5),s.gain.setValueAtTime(.15,e),s.gain.linearRampToValueAtTime(.1,e+.2),s.gain.exponentialRampToValueAtTime(.01,e+.5);const a=this.ctx.createBiquadFilter();a.type="lowpass",a.frequency.setValueAtTime(1e3,e),a.frequency.exponentialRampToValueAtTime(200,e+.4),t.connect(a),a.connect(s),s.connect(this.sfxGain),t.start(e),t.stop(e+.6)}triggerHaptic(e){this.settings.haptics&&typeof window.triggerHaptic=="function"&&window.triggerHaptic(e)}}class C{particles=[];pool;constructor(){this.pool=new T(()=>({x:0,y:0,vx:0,vy:0,life:0,maxLife:1,size:4,color:"#fff",type:"spark",rotation:0,rotationSpeed:0}),e=>{e.life=0},n.PARTICLE_POOL_SIZE)}emit(e,t,s,a,i="spark"){for(let o=0;o<a;o++){const r=this.pool.acquire(),l=Math.random()*Math.PI*2,c=i==="explosion"?3+Math.random()*5:1+Math.random()*3;r.x=e,r.y=t,r.vx=Math.cos(l)*c,r.vy=Math.sin(l)*c,r.life=1,r.maxLife=1,r.size=i==="paper"?8+Math.random()*12:i==="explosion"?6+Math.random()*8:3+Math.random()*4,r.color=s,r.type=i,r.rotation=Math.random()*Math.PI*2,r.rotationSpeed=(Math.random()-.5)*.3,this.particles.push(r)}}update(e){for(let t=this.particles.length-1;t>=0;t--){const s=this.particles[t];s.x+=s.vx*e*60,s.y+=s.vy*e*60,s.vy+=.1*e*60,s.rotation+=s.rotationSpeed*e*60,s.life-=(s.type==="paper"?.015:.025)*e*60,s.life<=0&&(this.pool.release(s),this.particles.splice(t,1))}}draw(e){for(const t of this.particles){if(e.save(),e.globalAlpha=t.life*.8,e.translate(t.x,t.y),e.rotate(t.rotation),t.type==="paper"){e.fillStyle=t.color,e.beginPath();const s=t.size*t.life;e.moveTo(-s/2,-s/3),e.lineTo(s/2,-s/4),e.lineTo(s/3,s/3),e.lineTo(-s/3,s/2),e.closePath(),e.fill(),e.strokeStyle=n.PENCIL_LIGHT,e.lineWidth=1,e.stroke()}else t.type,e.fillStyle=t.color,e.beginPath(),e.arc(0,0,t.size*t.life,0,Math.PI*2),e.fill();e.restore()}}clear(){for(const e of this.particles)this.pool.release(e);this.particles=[]}}class w{texts=[];add(e,t,s,a="#fff",i=20){this.texts.push({x:e,y:t,text:s,life:1,color:a,size:i})}update(e){for(let t=this.texts.length-1;t>=0;t--){const s=this.texts[t];s.y-=40*e,s.life-=.02*e*60,s.life<=0&&this.texts.splice(t,1)}}draw(e){for(const t of this.texts)e.save(),e.globalAlpha=t.life,e.font="700 "+t.size*E(Math.min(1,(1-t.life)*3+.3))+"px Caveat, cursive",e.textAlign="center",e.textBaseline="middle",e.fillStyle="rgba(0,0,0,0.3)",e.fillText(t.text,t.x+2,t.y+2),e.fillStyle=t.color,e.fillText(t.text,t.x,t.y),e.restore()}clear(){this.texts=[]}}const y={damage:1,fireRateMs:n.PLAYER_FIRE_RATE,bulletSpeed:n.BULLET_SPEED,moveSpeed:n.PLAYER_SPEED,pierce:0,shots:1,spread:0,maxLives:3,bulletSize:1},B=[{id:"zenith_hat",name:"Zenith's Spare Hat",description:"Bullets that hit summon a star strike for half damage.",category:"bullet",isCursed:!1,effects:{starOnHit:.5},bulletShape:"star"},{id:"yellow_gem",name:"Yellow Gem",description:"Summon an orbiting buddy that fires weak homing shots.",category:"buddy",isCursed:!1,effects:{turretBuddies:1,homingStrength:.4}},{id:"wildfire_can",name:"Wildfire's Can of Totally Legal Flammables",description:"Charged power replaced with a blazing aura trail.",category:"bullet",isCursed:!1,stats:{damageMult:1.2,fireRateMult:.8},effects:{fireTrail:!0}},{id:"whole_milk",name:"Whole Milk",description:"Damage way up, fire rate way down.",category:"stat",isCursed:!1,stats:{damageMult:3,pierceFlat:5,fireRateMult:.5,bulletSpeedMult:.7}},{id:"voodoo_doll",name:"Voodoo Doll",description:"Damage up. Hits echo to nearby asteroids of the same size.",category:"bullet",isCursed:!0,stats:{damageFlat:5},effects:{voodooOnHit:.6}},{id:"violet_petal",name:"Violet's Petal",description:"A flower bud blocks incoming hits.",category:"shield",isCursed:!0,effects:{shieldCharges:1}},{id:"unstable_core",name:"Unstable Power Core",description:"Huge stats, but max health becomes 1.",category:"stat",isCursed:!1,stats:{damageFlat:10,moveSpeedFlat:40,pierceFlat:1,bulletSpeedMult:1.5,fireRateMult:1.5,maxLivesAdd:-2}},{id:"uncommon_sweet",name:"Uncommon Sweet",description:"All stats up.",category:"stat",isCursed:!1,stats:{maxLivesAdd:2,damageFlat:3,moveSpeedFlat:10,bulletSpeedMult:1.2,fireRateMult:1.3}},{id:"ultra_octagon",name:"Ultra Octagon",description:"Speed up.",category:"stat",isCursed:!1,stats:{moveSpeedFlat:30}},{id:"tyrant_crown",name:"Tyrant's Crown",description:"Shots slow but aggressively seek targets.",category:"bullet",isCursed:!0,stats:{fireRateMult:.8,bulletSpeedMult:.6},effects:{homingStrength:.8}},{id:"pho_drone_bay",name:"Pho's Drone Bay",description:"Launch an aggressive drone that never stops hunting.",category:"buddy",isCursed:!1,effects:{turretBuddies:1}},{id:"dei_beam_buddy",name:"Dei's Beam Buddy",description:"A buddy fires piercing beam bursts.",category:"buddy",isCursed:!1,effects:{turretBuddies:1,lightning:!0}},{id:"turret_bullets",name:"Turret Bullets",description:"Bullets can split into stationary turrets on impact.",category:"bullet",isCursed:!1,effects:{splitOnHit:1}},{id:"turret_buddy",name:"Turret Buddy",description:"An orbiting buddy shoots nearby enemies.",category:"buddy",isCursed:!1,effects:{turretBuddies:1}},{id:"trigun",name:"Trigun",description:"Triple shot with a wide spread.",category:"bullet",isCursed:!0,stats:{shotsAdd:2,spreadAdd:24}},{id:"tidal_wave",name:"Tidal Wave",description:"Moving fires extra bullets upward.",category:"special",isCursed:!1,effects:{tidalWave:!0}},{id:"tesla_coil",name:"Tesla Coil",description:"Electric arcs chain between targets.",category:"bullet",isCursed:!1,effects:{lightning:!0}},{id:"tank_plating",name:"Tank Plating",description:"Health up, speed down.",category:"stat",isCursed:!1,stats:{maxLivesAdd:3,moveSpeedFlat:-20}},{id:"super_glue",name:"Super Glue",description:"Bullets stick and keep damaging enemies.",category:"bullet",isCursed:!1,effects:{sticky:!0}},{id:"stumpy_ukulele",name:"Stumpy's Ukulele",description:"Notes weave through the air and pierce once more.",category:"bullet",isCursed:!1,stats:{pierceFlat:1},effects:{waveBullets:!0},bulletShape:"note"},{id:"spreadshot",name:"Spreadshot",description:"Five shots in a barrier spread.",category:"bullet",isCursed:!0,stats:{shotsAdd:4,spreadAdd:60,fireRateMult:.7}},{id:"spray_paint",name:"Spray Paint",description:"Fire rate up, bullet speed down.",category:"stat",isCursed:!1,stats:{fireRateMult:1.3,bulletSpeedMult:.8}},{id:"split_bullets",name:"Split Bullets",description:"Bullets split into two on impact.",category:"bullet",isCursed:!0,effects:{splitOnHit:2}},{id:"spicy_cheezo",name:"Spicy Cheezo Sushi",description:"Damage up and a full heal.",category:"stat",isCursed:!1,stats:{damageFlat:3}},{id:"snowball",name:"Snowball",description:"Bullets grow stronger the longer they fly.",category:"bullet",isCursed:!0,stats:{bulletSpeedMult:.6},effects:{snowball:!0,snowballMax:2}},{id:"shield_projector",name:"Shield Projector",description:"Project a thinner shield that recharges quickly.",category:"shield",isCursed:!1,effects:{shieldCharges:1}},{id:"shield_buddy",name:"Shield Buddy",description:"A buddy blocks incoming asteroids.",category:"shield",isCursed:!1,effects:{shieldBuddies:1}},{id:"shellcore",name:"Shellcore",description:"Fire rate up, health down.",category:"stat",isCursed:!1,stats:{fireRateMult:1.3,maxLivesAdd:-1}},{id:"sharps_turrets",name:"Sharp's Turrets",description:"Two extra turret buddies join the fight.",category:"buddy",isCursed:!1,effects:{turretBuddies:2}},{id:"sharp_dart",name:"Sharp Dart",description:"Piercing up.",category:"stat",isCursed:!1,stats:{pierceFlat:2}},{id:"creepy_gunpowder",name:"Creepy Gunpowder",description:"Enemies explode on death.",category:"bullet",isCursed:!1,effects:{creepyGunpowder:!0}},{id:"cracked_overcharger",name:"Cracked Overcharger",description:"Damage up.",category:"stat",isCursed:!1,stats:{damageFlat:4}},{id:"coolant",name:"Coolant",description:"Balanced boost to all stats.",category:"stat",isCursed:!1,stats:{damageFlat:3,fireRateMult:1.1,moveSpeedFlat:10,maxLivesAdd:1}},{id:"coffee",name:"Coffee",description:"Speed and fire rate up.",category:"stat",isCursed:!1,stats:{moveSpeedFlat:15,fireRateMult:1.1}},{id:"castle_crusher",name:"Castle Crusher",description:"Every third volley is devastating.",category:"bullet",isCursed:!1,effects:{castleCrusher:!0}},{id:"carnage_engine",name:"Carnage Engine",description:"Hits ramp damage up to a deadly peak.",category:"stat",isCursed:!0,stats:{moveSpeedFlat:20},effects:{carnageEngine:!0}},{id:"cannon",name:"Cannon",description:"Damage up, bullet speed down.",category:"stat",isCursed:!1,stats:{damageFlat:5,bulletSpeedMult:.8}},{id:"burst_laser",name:"Burst Laser",description:"Fires in bursts of three.",category:"bullet",isCursed:!1,stats:{fireRateMult:.55},effects:{burstFire:3}},{id:"bullet_teleporter",name:"Bullet Teleporter",description:"Bullets spawn from your cursor.",category:"bullet",isCursed:!1,effects:{teleportShots:!0}},{id:"bubble_bullets",name:"Bubble Bullets",description:"Bubbles pop and home toward targets.",category:"bullet",isCursed:!0,effects:{homingStrength:.6},bulletShape:"bubble"},{id:"broken_capacitor",name:"Broken Capacitor",description:"Fire rate up.",category:"stat",isCursed:!1,stats:{fireRateMult:1.2}},{id:"blackhole",name:"Blackhole",description:"Bullets pull asteroids slightly inward.",category:"bullet",isCursed:!1,effects:{homingStrength:.25}},{id:"bay_blade",name:"Bay Blade",description:"Spinning shots with slower speed.",category:"bullet",isCursed:!1,stats:{bulletSpeedMult:.7},effects:{waveBullets:!0}},{id:"bandaid",name:"Bandaid",description:"Health and speed up.",category:"stat",isCursed:!1,stats:{maxLivesAdd:1,moveSpeedFlat:10}},{id:"almond_milk",name:"Almond Milk",description:"Extreme fire rate, low damage.",category:"stat",isCursed:!1,stats:{fireRateMult:4,damageMult:.35}},{id:"cyclotron",name:"Cyclotron",description:"Cycling shot patterns and speeds.",category:"bullet",isCursed:!1,stats:{fireRateMult:.75},effects:{cyclotron:!0}},{id:"rubber_band_ball",name:"Rubber Band Ball",description:"Bullets bounce based on piercing.",category:"bullet",isCursed:!1,stats:{pierceFlat:1},effects:{bounceCount:1}},{id:"remote_control",name:"Remote Control",description:"Bullets accelerate toward your aim.",category:"bullet",isCursed:!0,effects:{homingStrength:.9}},{id:"reinforced_core",name:"Reinforced Core",description:"Longer invincibility after hits.",category:"shield",isCursed:!1,stats:{invincibilityBonus:2}},{id:"reaper_pearl",name:"Reaper Pearl",description:"Massive damage with a small heal chance.",category:"stat",isCursed:!0,stats:{damageFlat:10}},{id:"rat_buddy",name:"Rat Buddy",description:"A rat buddy drops cheese for massive buffs.",category:"buddy",isCursed:!1,effects:{ratBuddies:1}},{id:"rail_gun",name:"Rail Gun",description:"Slow but extremely powerful shots.",category:"bullet",isCursed:!1,stats:{damageMult:4,bulletSpeedMult:2,fireRateMult:.5,pierceFlat:5}},{id:"prism_buddy",name:"Prism Buddy",description:"Bullets split when passing a prism.",category:"buddy",isCursed:!1,effects:{prismBuddies:1}},{id:"phase_bullets",name:"Phase Bullets",description:"Bullets loop across screen edges.",category:"bullet",isCursed:!1,stats:{pierceFlat:1},effects:{loopBullets:!0}},{id:"overcharged_engine",name:"Overcharged Engine",description:"Speed builds over time and boosts fire rate.",category:"special",isCursed:!1,effects:{momentum:!0}},{id:"origami_clover",name:"Origami Clover",description:"Enemies drop more paperclips.",category:"special",isCursed:!1,stats:{coinMult:1.33}},{id:"neo_crt",name:"Neo's CRT",description:"A mirrored buddy fires opposite you.",category:"buddy",isCursed:!1,effects:{mirrorBuddies:1}},{id:"multibarrel",name:"Multibarrel",description:"Rapid fire with a messy spread.",category:"stat",isCursed:!1,stats:{fireRateMult:1.4,damageFlat:-3,spreadAdd:6}},{id:"momentum",name:"Momentum",description:"Damage scales with your speed.",category:"stat",isCursed:!1,stats:{moveSpeedFlat:30},effects:{momentum:!0}},{id:"mirror_bullets",name:"Mirror Bullets",description:"Shots echo from the opposite edge.",category:"bullet",isCursed:!0,effects:{mirrorShots:!0}},{id:"minigun",name:"Minigun",description:"Sustained firing increases fire rate and spread.",category:"stat",isCursed:!0,stats:{fireRateMult:.8},effects:{minigun:!0}},{id:"magnet",name:"Magnet",description:"Bullets home in on asteroids.",category:"bullet",isCursed:!1,effects:{homingStrength:.6}},{id:"mag_coil",name:"Mag Coil",description:"Piercing and bullet speed up.",category:"stat",isCursed:!1,stats:{pierceFlat:1,bulletSpeedMult:1.3}},{id:"loop_bullets",name:"Loop Bullets",description:"Bullets loop around the screen edges.",category:"bullet",isCursed:!1,effects:{loopBullets:!0}},{id:"linked_shield",name:"Linked Shield",description:"Gain an additional shield charge.",category:"shield",isCursed:!1,effects:{shieldCharges:1}},{id:"lightweight_chassis",name:"Lightweight Chassis",description:"Speed and fire rate up, max health down.",category:"stat",isCursed:!1,stats:{fireRateMult:1.1,moveSpeedFlat:30,bulletSpeedMult:1.2,maxLivesAdd:-1}},{id:"lightspeed_bullets",name:"Lightspeed Bullets",description:"Bullet speed way up.",category:"stat",isCursed:!1,stats:{bulletSpeedMult:2}},{id:"rocket",name:"Rocket",description:"Explosive rounds with slower speed.",category:"bullet",isCursed:!0,stats:{fireRateMult:.8,bulletSpeedMult:.5},effects:{explosive:!0},bulletShape:"rocket"},{id:"ironplate_potion",name:"Ironplate Potion",description:"Health up.",category:"stat",isCursed:!1,stats:{maxLivesAdd:2}},{id:"hero_bow",name:"Hero Bow",description:"Fire rate and bullet speed up.",category:"stat",isCursed:!1,stats:{fireRateMult:1.15,bulletSpeedMult:1.3}},{id:"heckfire_bullets",name:"Heckfire Bullets",description:"Bullets leave burning trails.",category:"bullet",isCursed:!0,effects:{fireTrail:!0}},{id:"heavy_shots",name:"Heavy Shots",description:"Bullets fall under heavy gravity.",category:"bullet",isCursed:!1,effects:{gravityBullets:!0}},{id:"gro_mush",name:"Gro Mush",description:"Damage up, speed down.",category:"stat",isCursed:!1,stats:{damageFlat:5,moveSpeedFlat:-20}},{id:"forbidden_gummi",name:"Forbidden Gummi",description:"All stats up with a full heal.",category:"stat",isCursed:!0,stats:{damageFlat:8,fireRateMult:1.5,moveSpeedFlat:20,bulletSpeedMult:1.5,maxLivesAdd:2}},{id:"flask_cannon",name:"Fla(s)k Cannon",description:"Adds extra random bullets on fire.",category:"bullet",isCursed:!1,stats:{shotsAdd:1,spreadAdd:20}},{id:"firework_bullets",name:"Firework Bullets",description:"Bullets burst into smaller shots on hit.",category:"bullet",isCursed:!0,effects:{splitOnHit:3,explosive:!0}},{id:"fanciful_pants",name:"Fanciful Pants",description:"Speed up.",category:"stat",isCursed:!1,stats:{moveSpeedFlat:25}},{id:"eraser",name:"Eraser",description:"Damage and fire rate up.",category:"stat",isCursed:!1,stats:{damageFlat:3,fireRateMult:1.1}},{id:"energy_drink",name:"Energy Drink",description:"Speed multiplier up.",category:"stat",isCursed:!1,stats:{moveSpeedMult:1.5}},{id:"empty_dragon_egg",name:"Empty Dragon Egg",description:"Gain damage for each item acquired.",category:"stat",isCursed:!1},{id:"drill_bullets",name:"Drill Bullets",description:"Piercing up, damage ramps after hits.",category:"bullet",isCursed:!0,stats:{pierceFlat:3}},{id:"drag_bullets",name:"Drag Bullets",description:"Bullets slow down over time, fire rate up.",category:"bullet",isCursed:!1,stats:{fireRateMult:1.3},effects:{dragBullets:!0}},{id:"detonator",name:"Detonator",description:"Enemies explode into extra bullets when they die.",category:"bullet",isCursed:!1,effects:{detonator:!0}},{id:"cursed_bullets",name:"Cursed Bullets",description:"Bullets burn with a dark aura.",category:"bullet",isCursed:!0,stats:{damageMult:1.2},effects:{fireTrail:!0}},{id:"xl_ammo_box",name:"XL Ammo Box",description:"Fire rate up, speed down.",category:"stat",isCursed:!1,stats:{fireRateMult:1.3,moveSpeedFlat:-15}},{id:"accelerometer",name:"Accelerometer",description:"Bullets accelerate endlessly.",category:"bullet",isCursed:!1,stats:{pierceFlat:1},effects:{accelerateBullets:!0}},{id:"broken_pipe",name:"Broken Pipe",description:"Damage up.",category:"stat",isCursed:!1,stats:{damageFlat:4}},{id:"bullet_charm",name:"Bullet Charm",description:"More bullets on screen increase your power.",category:"special",isCursed:!1},{id:"elastic_cables",name:"Elastic Cables",description:"Damage scales with bullet speed.",category:"special",isCursed:!1},{id:"fractal_bullets",name:"Fractal Bullets",description:"Bullets split repeatedly on impact.",category:"bullet",isCursed:!0,effects:{splitOnHit:2}},{id:"friendly_snail",name:"Friendly Snail",description:"Damage and fire rate up, bullet speed down.",category:"stat",isCursed:!1,stats:{damageFlat:3,fireRateMult:1.2,bulletSpeedMult:.5}},{id:"hot_stuff",name:"Hot Stuff",description:"Bullets shed shrapnel as they fly.",category:"bullet",isCursed:!0,effects:{fireTrail:!0}},{id:"lightning_bottle",name:"Lightning Bottle",description:"Zig-zagging lightning shots.",category:"bullet",isCursed:!1,effects:{waveBullets:!0,lightning:!0},bulletShape:"bolt"},{id:"mark_ii",name:"Mark II",description:"Double shot with smaller spread.",category:"bullet",isCursed:!1,stats:{shotsAdd:1,spreadAdd:8,fireRateMult:.8}}],x=new Map(B.map(f=>[f.id,f]));class P{canvas;ctx;gameContainer;eventBus;particles;floatingText;audio;bulletPool;asteroidPool;bullets=[];asteroids=[];drones=[];orbitals=[];gameState="START";selectedPlane="dart";playerX=0;playerY=0;playerVelocityX=0;playerVelocityY=0;targetX=0;targetY=0;spinAngle=0;spinDirection=0;lastPlayerX=0;lives=3;maxLives=3;damageTimer=0;damageFlashTimer=0;isInvincible=!1;boss=null;bossDefeated=!1;bossAnnouncementTimer=0;survivalTime=0;coins=0;score=0;fireTimer=0;spawnTimer=0;destroyedCount=0;totalUpgrades=0;itemsOwned=[];currentItemChoices=[];currentStats={...y};statModifiers={damageFlat:0,damageMult:1,fireRateMult:1,bulletSpeedMult:1,moveSpeedFlat:0,moveSpeedMult:1,pierceFlat:0,shotsAdd:0,spreadAdd:0,maxLivesAdd:0,bulletSizeMult:1,invincibilityBonus:0,coinMult:1};itemEffects={starOnHit:0,splitOnHit:0,bounceCount:0,loopBullets:!1,homingStrength:0,snowball:!1,snowballMax:1,sticky:!1,fireTrail:!1,lightning:!1,explosive:!1,mirrorShots:!1,teleportShots:!1,waveBullets:!1,dragBullets:!1,accelerateBullets:!1,gravityBullets:!1,voodooOnHit:0,creepyGunpowder:!1,detonator:!1,castleCrusher:!1,tidalWave:!1,momentum:!1,carnageEngine:!1,minigun:!1,cyclotron:!1,burstFire:0,turretBuddies:0,shieldBuddies:0,ratBuddies:0,prismBuddies:0,mirrorBuddies:0,shieldCharges:0,bulletShape:null};dynamicDamageMult=1;dynamicFireRateMult=1;dynamicMoveSpeedMult=1;shieldCharges=0;maxShieldCharges=0;itemDamageBuff=0;itemDamageBuffTimer=0;minigunHeat=0;cyclotronIndex=0;castleCrusherCounter=0;tidalWaveTimer=0;cheeseBuffTimer=0;cheeseDamageMult=1;regenTimer=0;ratDropTimer=0;difficultyLevel=0;healthBonus=0;speedMultiplier=1;w=0;h=0;isMobile=!1;bgOffset=0;screenShake={x:0,y:0,intensity:0};keysDown=new Set;touchX=null;touchY=null;mouseX=null;mouseY=null;isDragging=!1;settings;lastTime=0;asteroidIdCounter=0;upgradeAutoSelectTimer=0;demoCanvas=null;demoCtx=null;demoPlaneX=0;demoPlaneY=0;demoPlaneTargetX=0;demoPlaneDirection=1;demoBullets=[];demoAsteroids=[];demoParticles=[];demoFireTimer=0;demoSpawnTimer=0;demoBgOffset=0;constructor(){console.log("[PaperPlaneGame] Initializing"),this.canvas=document.getElementById("gameCanvas"),this.ctx=this.canvas.getContext("2d"),this.gameContainer=document.getElementById("game-container"),this.eventBus=new I,this.particles=new C,this.floatingText=new w,this.settings={music:localStorage.getItem("paperPlane_music")!=="false",fx:localStorage.getItem("paperPlane_fx")!=="false",haptics:localStorage.getItem("paperPlane_haptics")!=="false"},this.audio=new A(this.settings),this.isMobile=window.matchMedia("(pointer: coarse)").matches,this.demoCanvas=document.getElementById("demoCanvas"),this.demoCanvas&&(this.demoCtx=this.demoCanvas.getContext("2d"),this.initDemoAnimation()),this.bulletPool=new T(()=>({x:0,y:0,vx:0,vy:0,damage:1,pierceRemaining:0,explosive:!1,chainLightning:!1,active:!1,fromDrone:!1,age:0,maxAge:3,size:1,color:n.PENCIL_DARK,shape:"line",wobblePhase:0,bounceRemaining:0,loop:!1,homingStrength:0,snowball:!1,snowballMax:1,sticky:!1,stuckToId:-1,stuckOffsetX:0,stuckOffsetY:0,drag:0,acceleration:0,gravity:0,splitOnHit:0,trailTimer:0,jitterOffset:0,prismSplit:!1}),e=>{e.active=!1,e.fromDrone=!1,e.age=0,e.maxAge=3,e.stuckToId=-1,e.trailTimer=0,e.prismSplit=!1},n.BULLET_POOL_SIZE),this.asteroidPool=new T(()=>({id:0,size:"medium",health:1,maxHealth:1,x:0,y:0,vx:0,vy:0,rotation:0,rotationSpeed:0,active:!1,hitFlash:0,isBossAsteroid:!1}),e=>{e.active=!1,e.isBossAsteroid=!1},n.ASTEROID_POOL_SIZE),this.setupEventListeners(),this.setupGameEvents(),this.resizeCanvas(),window.addEventListener("resize",()=>this.resizeCanvas()),requestAnimationFrame(e=>this.gameLoop(e))}setupEventListeners(){window.addEventListener("keydown",e=>{this.keysDown.add(e.key),e.key==="Escape"&&this.gameState==="PLAYING"?this.pauseGame():e.key==="Escape"&&this.gameState==="PAUSED"&&this.resumeGame()}),window.addEventListener("keyup",e=>{this.keysDown.delete(e.key)}),this.canvas.addEventListener("touchstart",e=>{e.preventDefault(),(this.gameState==="PLAYING"||this.gameState==="BOSS")&&(this.isDragging=!0,this.touchX=this.getRelativeX(e.touches[0].clientX),this.touchY=this.getRelativeY(e.touches[0].clientY))}),this.canvas.addEventListener("touchmove",e=>{e.preventDefault(),this.isDragging&&(this.gameState==="PLAYING"||this.gameState==="BOSS")&&(this.touchX=this.getRelativeX(e.touches[0].clientX),this.touchY=this.getRelativeY(e.touches[0].clientY))}),this.canvas.addEventListener("touchend",e=>{e.preventDefault(),this.isDragging=!1,this.targetX=this.playerX,this.targetY=this.playerY,this.touchX=null,this.touchY=null}),this.canvas.addEventListener("mousemove",e=>{(this.gameState==="PLAYING"||this.gameState==="BOSS")&&!this.isMobile&&(this.mouseX=this.getRelativeX(e.clientX),this.mouseY=this.getRelativeY(e.clientY))}),this.canvas.addEventListener("mouseleave",()=>{this.mouseX=null,this.mouseY=null}),document.getElementById("startButton")?.addEventListener("click",()=>{this.audio.triggerHaptic("light"),this.startGame()}),document.getElementById("restartButton")?.addEventListener("click",()=>{this.audio.triggerHaptic("light"),this.startGame()}),document.getElementById("menuButton")?.addEventListener("click",()=>{this.audio.triggerHaptic("light"),this.showStartScreen()}),document.getElementById("pauseBtn")?.addEventListener("click",()=>{this.audio.triggerHaptic("light"),this.pauseGame()}),document.getElementById("resumeButton")?.addEventListener("click",()=>{this.audio.triggerHaptic("light"),this.resumeGame()}),document.getElementById("pauseRestartBtn")?.addEventListener("click",()=>{this.audio.triggerHaptic("light"),this.startGame()}),document.getElementById("pauseMenuBtn")?.addEventListener("click",()=>{this.audio.triggerHaptic("light"),this.showStartScreen()}),document.getElementById("settingsBtn")?.addEventListener("click",()=>{this.audio.triggerHaptic("light"),document.getElementById("settingsModal")?.classList.remove("hidden")}),document.getElementById("settingsClose")?.addEventListener("click",()=>{this.audio.triggerHaptic("light"),document.getElementById("settingsModal")?.classList.add("hidden")}),this.setupSettingToggle("musicToggle","music"),this.setupSettingToggle("fxToggle","fx"),this.setupSettingToggle("hapticToggle","haptics"),document.getElementById("galleryButton")?.addEventListener("click",()=>{this.audio.triggerHaptic("light"),this.showGalleryScreen()}),document.getElementById("backFromGalleryBtn")?.addEventListener("click",()=>{this.audio.triggerHaptic("light"),this.hideGalleryScreen()}),document.querySelectorAll(".plane-card").forEach(e=>{e.addEventListener("click",()=>{this.audio.triggerHaptic("light");const t=e.getAttribute("data-plane");this.selectPlane(t),this.hideGalleryScreen()})}),document.querySelectorAll(".item-card").forEach(e=>{e.addEventListener("click",()=>{if(this.gameState!=="UPGRADE")return;this.audio.triggerHaptic("medium");const t=e.getAttribute("data-item-id");t&&this.selectItem(t)})})}setupSettingToggle(e,t){const s=document.getElementById(e);s&&(s.classList.toggle("active",this.settings[t]),s.addEventListener("click",()=>{this.settings[t]=!this.settings[t],s.classList.toggle("active",this.settings[t]),localStorage.setItem("paperPlane_"+t,this.settings[t].toString()),this.audio.triggerHaptic("light")}))}setupGameEvents(){this.eventBus.on("ASTEROID_DESTROYED",e=>{const{asteroid:t,coins:s}=e;console.log("[Event] ASTEROID_DESTROYED",t.size,"coins:",s),this.coins+=s,this.audio.playDestroy(t.size),this.audio.playCoin(),this.audio.triggerHaptic(t.size==="large"?"heavy":"medium"),this.particles.emit(t.x,t.y,n.PAPER_BG,12,"paper"),this.particles.emit(t.x,t.y,n.PENCIL_DARK,8,"explosion"),this.floatingText.add(t.x,t.y,"+"+s,n.COIN_GOLD,24);const a=t.size==="large"?.5:t.size==="medium"?.3:.15;this.triggerScreenShake(a),this.gameState!=="BOSS"&&(this.destroyedCount++,this.updateProgressBar(),this.destroyedCount>=this.getAsteroidsForNextUpgrade()&&this.gameState==="PLAYING"&&(console.log("[Game] Triggering upgrade after",this.destroyedCount,"asteroids destroyed"),this.showUpgradeScreen()))}),this.eventBus.on("ASTEROID_HIT",e=>{const{asteroid:t,damage:s}=e;this.audio.playHit(),this.audio.triggerHaptic("light"),t.hitFlash=.2,this.particles.emit(t.x,t.y,n.PENCIL_LIGHT,4,"spark")}),this.eventBus.on("PLAYER_HIT",()=>{this.isInvincible||(this.lives--,console.log("[Event] PLAYER_HIT - Lives remaining:",this.lives),this.lives<=0?this.gameOver():this.triggerDamageEffect())}),this.eventBus.on("UPGRADE_ROUND_START",()=>{console.log("[Event] UPGRADE_ROUND_START"),this.showUpgradeScreen()}),this.eventBus.on("ON_FIRE",e=>{if(!this.hasItem("flask_cannon"))return;const t=e.stats,s=Math.floor(v(1,4));for(let a=0;a<s;a++){const i=-Math.PI/2+v(-.4,.4);this.spawnBullet(i,t,.5,0,.8)}}),this.eventBus.on("ON_MOVE",e=>{if(!this.itemEffects.tidalWave)return;const{speed:t}=e;t<2||(this.tidalWaveTimer-=t*2,this.tidalWaveTimer<=0&&(this.spawnBullet(-Math.PI/2,this.currentStats,.4,0,.9),this.tidalWaveTimer=Math.max(80,260-t*10)))})}selectPlane(e){console.log("[selectPlane]",e),this.selectedPlane=e,document.querySelectorAll(".plane-card").forEach(t=>{t.classList.toggle("selected",t.getAttribute("data-plane")===e)})}showGalleryScreen(){console.log("[showGalleryScreen]"),document.getElementById("startScreen")?.classList.add("hidden"),document.getElementById("galleryScreen")?.classList.remove("hidden")}hideGalleryScreen(){console.log("[hideGalleryScreen]"),document.getElementById("galleryScreen")?.classList.add("hidden"),document.getElementById("startScreen")?.classList.remove("hidden")}resizeCanvas(){this.w=this.gameContainer.clientWidth,this.h=this.gameContainer.clientHeight,this.canvas.width=this.w,this.canvas.height=this.h,this.playerX===0&&(this.playerX=this.w/2,this.playerY=this.h*n.PLAYER_Y_RATIO,this.targetX=this.w/2,this.targetY=this.h*n.PLAYER_Y_RATIO),console.log("[resizeCanvas]",this.w,"x",this.h)}getRelativeX(e){const t=this.gameContainer.getBoundingClientRect();return e-t.left}getRelativeY(e){const t=this.gameContainer.getBoundingClientRect();return e-t.top}startGame(){console.log("[startGame] Plane:",this.selectedPlane),this.audio.init(),this.gameState="PLAYING",this.survivalTime=0,this.coins=0,this.score=0,this.fireTimer=0,this.spawnTimer=0,this.destroyedCount=0,this.totalUpgrades=0,this.difficultyLevel=0,this.healthBonus=0,this.speedMultiplier=1,this.itemsOwned=[],this.currentItemChoices=[],this.statModifiers={damageFlat:0,damageMult:1,fireRateMult:1,bulletSpeedMult:1,moveSpeedFlat:0,moveSpeedMult:1,pierceFlat:0,shotsAdd:0,spreadAdd:0,maxLivesAdd:0,bulletSizeMult:1,invincibilityBonus:0,coinMult:1},this.itemEffects={starOnHit:0,splitOnHit:0,bounceCount:0,loopBullets:!1,homingStrength:0,snowball:!1,snowballMax:1,sticky:!1,fireTrail:!1,lightning:!1,explosive:!1,mirrorShots:!1,teleportShots:!1,waveBullets:!1,dragBullets:!1,accelerateBullets:!1,gravityBullets:!1,voodooOnHit:0,creepyGunpowder:!1,detonator:!1,castleCrusher:!1,tidalWave:!1,momentum:!1,carnageEngine:!1,minigun:!1,cyclotron:!1,burstFire:0,turretBuddies:0,shieldBuddies:0,ratBuddies:0,prismBuddies:0,mirrorBuddies:0,shieldCharges:0,bulletShape:null},this.dynamicDamageMult=1,this.dynamicFireRateMult=1,this.dynamicMoveSpeedMult=1,this.itemDamageBuff=0,this.itemDamageBuffTimer=0,this.minigunHeat=0,this.cyclotronIndex=0,this.castleCrusherCounter=0,this.tidalWaveTimer=0,this.cheeseBuffTimer=0,this.cheeseDamageMult=1,this.regenTimer=0,this.ratDropTimer=0,this.maxLives=y.maxLives,this.lives=this.maxLives,this.damageTimer=0,this.damageFlashTimer=0,this.isInvincible=!1,this.shieldCharges=0,this.maxShieldCharges=0,this.boss=null,this.bossDefeated=!1,this.bossAnnouncementTimer=0,this.updateLivesDisplay(),this.playerX=this.w/2,this.playerY=this.h*n.PLAYER_Y_RATIO,this.targetX=this.w/2,this.targetY=this.h*n.PLAYER_Y_RATIO,this.playerVelocityX=0,this.playerVelocityY=0,this.spinAngle=0,this.spinDirection=0,this.lastPlayerX=this.w/2,this.mouseX=null,this.mouseY=null,this.touchX=null,this.touchY=null;for(const e of this.bullets)this.bulletPool.release(e);this.bullets=[];for(const e of this.asteroids)this.asteroidPool.release(e);this.asteroids=[],this.drones=[],this.orbitals=[],this.particles.clear(),this.floatingText.clear(),document.getElementById("startScreen")?.classList.add("hidden"),document.getElementById("gameOverScreen")?.classList.add("hidden"),document.getElementById("pauseScreen")?.classList.add("hidden"),document.getElementById("upgradeScreen")?.classList.add("hidden"),document.getElementById("galleryScreen")?.classList.add("hidden"),document.getElementById("hud")?.classList.remove("hidden"),document.getElementById("pauseBtn")?.classList.remove("hidden"),document.getElementById("itemInventory")?.classList.remove("hidden"),this.updateHUD(),this.recalculateItemState(),this.updateProgressBar()}showStartScreen(){console.log("[showStartScreen]"),this.gameState="START",document.getElementById("startScreen")?.classList.remove("hidden"),document.getElementById("gameOverScreen")?.classList.add("hidden"),document.getElementById("pauseScreen")?.classList.add("hidden"),document.getElementById("upgradeScreen")?.classList.add("hidden"),document.getElementById("galleryScreen")?.classList.add("hidden"),document.getElementById("hud")?.classList.add("hidden"),document.getElementById("pauseBtn")?.classList.add("hidden"),document.getElementById("itemInventory")?.classList.add("hidden"),this.initDemoAnimation()}pauseGame(){this.gameState==="PLAYING"&&(console.log("[pauseGame]"),this.gameState="PAUSED",document.getElementById("pauseScreen")?.classList.remove("hidden"))}resumeGame(){this.gameState==="PAUSED"&&(console.log("[resumeGame]"),this.gameState="PLAYING",document.getElementById("pauseScreen")?.classList.add("hidden"))}gameOver(){console.log("[gameOver] Time:",(this.survivalTime/1e3).toFixed(1),"s, Coins:",this.coins),this.gameState="GAME_OVER",this.audio.playGameOver(),this.audio.triggerHaptic("error");const e=Math.floor(this.survivalTime/1e3);typeof window.submitScore=="function"&&(window.submitScore(e),console.log("[gameOver] Score submitted:",e));const t=Math.floor(this.survivalTime/6e4),s=Math.floor(this.survivalTime%6e4/1e3);document.getElementById("finalTime").textContent=t+":"+s.toString().padStart(2,"0"),document.getElementById("finalCoins").textContent=this.coins.toString();const a=this.itemsOwned.filter(i=>x.get(i)?.isCursed).length;document.getElementById("summaryItems").textContent=this.itemsOwned.length.toString(),document.getElementById("summaryCursed").textContent=a.toString(),document.getElementById("hud")?.classList.add("hidden"),document.getElementById("pauseBtn")?.classList.add("hidden"),document.getElementById("itemInventory")?.classList.add("hidden"),document.getElementById("gameOverScreen")?.classList.remove("hidden")}showUpgradeScreen(){if(this.gameState==="UPGRADE")return;console.log("[showUpgradeScreen]"),this.gameState="UPGRADE",this.upgradeAutoSelectTimer=5e3,this.rollItemChoices(),document.querySelectorAll(".item-card").forEach((t,s)=>{const a=this.currentItemChoices[s];if(!a){t.classList.add("hidden");return}t.classList.remove("hidden"),t.classList.toggle("cursed",a.isCursed),t.setAttribute("data-item-id",a.id);const i=t.querySelector(".item-name"),o=t.querySelector(".item-desc"),r=t.querySelector(".item-category"),l=t.querySelector(".item-curse");i&&(i.textContent=a.name),o&&(o.textContent=a.description),r&&(r.textContent=a.category.toUpperCase()),l&&(l.textContent=a.isCursed?"CURSED":"")}),document.getElementById("upgradeScreen")?.classList.remove("hidden"),this.updateUpgradeTimer()}selectItem(e){if(this.gameState!=="UPGRADE")return;const t=this.currentItemChoices.findIndex(s=>s.id===e);t!==-1&&this.applyItemChoice(t)}startBossFight(){console.log("[startBossFight] Boss fight starting!");for(const t of this.asteroids)t.active=!1,this.asteroidPool.release(t);this.asteroids=[],this.bossAnnouncementTimer=2.5;const e=document.getElementById("bossAnnouncement");e&&e.classList.add("active"),this.boss={x:this.w/2,y:-120,targetY:n.BOSS_Y_POSITION,health:n.BOSS_HEALTH,maxHealth:n.BOSS_HEALTH,rotation:0,throwCount:0,throwTimer:2e3,active:!0,entering:!0,defeated:!1,pulsePhase:0},this.gameState="BOSS",this.audio.triggerHaptic("heavy")}applyUpgrade(e,t){console.log("[applyUpgrade] Deprecated:",e,t)}updateUpgradeTimer(){const e=document.getElementById("upgradeTimer");e&&(e.textContent=Math.ceil(this.upgradeAutoSelectTimer/1e3).toString())}updateHUD(){const e=Math.floor(this.survivalTime/6e4),t=Math.floor(this.survivalTime%6e4/1e3);document.getElementById("timeDisplay").textContent=e+":"+t.toString().padStart(2,"0"),document.getElementById("coinDisplay").textContent=this.coins.toString(),this.updateShieldUI()}getAsteroidsForNextUpgrade(){const e=[6,12,12,14,16];return this.totalUpgrades<e.length?e[this.totalUpgrades]:16}updateProgressBar(){const e=this.getAsteroidsForNextUpgrade(),t=Math.min(this.destroyedCount/e,1),s=document.getElementById("progressFill");s&&(s.style.width=t*100+"%");const a=document.getElementById("progressText");a&&(a.textContent=this.destroyedCount+"/"+e)}hasItem(e){return this.itemsOwned.includes(e)}recalculateItemState(){const e={damageFlat:0,damageMult:1,fireRateMult:1,bulletSpeedMult:1,moveSpeedFlat:0,moveSpeedMult:1,pierceFlat:0,shotsAdd:0,spreadAdd:0,maxLivesAdd:0,bulletSizeMult:1,invincibilityBonus:0,coinMult:1},t={starOnHit:0,splitOnHit:0,bounceCount:0,loopBullets:!1,homingStrength:0,snowball:!1,snowballMax:1,sticky:!1,fireTrail:!1,lightning:!1,explosive:!1,mirrorShots:!1,teleportShots:!1,waveBullets:!1,dragBullets:!1,accelerateBullets:!1,gravityBullets:!1,voodooOnHit:0,creepyGunpowder:!1,detonator:!1,castleCrusher:!1,tidalWave:!1,momentum:!1,carnageEngine:!1,minigun:!1,cyclotron:!1,burstFire:0,turretBuddies:0,shieldBuddies:0,ratBuddies:0,prismBuddies:0,mirrorBuddies:0,shieldCharges:0,bulletShape:null};let s=null;for(const a of this.itemsOwned){const i=x.get(a);i&&(i.stats&&(i.stats.damageFlat&&(e.damageFlat+=i.stats.damageFlat),i.stats.damageMult&&(e.damageMult*=i.stats.damageMult),i.stats.fireRateMult&&(e.fireRateMult*=i.stats.fireRateMult),i.stats.bulletSpeedMult&&(e.bulletSpeedMult*=i.stats.bulletSpeedMult),i.stats.moveSpeedFlat&&(e.moveSpeedFlat+=i.stats.moveSpeedFlat),i.stats.moveSpeedMult&&(e.moveSpeedMult*=i.stats.moveSpeedMult),i.stats.pierceFlat&&(e.pierceFlat+=i.stats.pierceFlat),i.stats.shotsAdd&&(e.shotsAdd+=i.stats.shotsAdd),i.stats.spreadAdd&&(e.spreadAdd+=i.stats.spreadAdd),i.stats.maxLivesAdd&&(e.maxLivesAdd+=i.stats.maxLivesAdd),i.stats.bulletSizeMult&&(e.bulletSizeMult*=i.stats.bulletSizeMult),i.stats.invincibilityBonus&&(e.invincibilityBonus+=i.stats.invincibilityBonus),i.stats.coinMult&&(e.coinMult*=i.stats.coinMult)),i.effects&&(i.effects.starOnHit&&(t.starOnHit+=i.effects.starOnHit),i.effects.splitOnHit&&(t.splitOnHit+=i.effects.splitOnHit),i.effects.bounceCount&&(t.bounceCount+=i.effects.bounceCount),i.effects.loopBullets&&(t.loopBullets=!0),i.effects.homingStrength&&(t.homingStrength=Math.max(t.homingStrength,i.effects.homingStrength)),i.effects.snowball&&(t.snowball=!0),i.effects.snowballMax&&(t.snowballMax=Math.max(t.snowballMax,i.effects.snowballMax)),i.effects.sticky&&(t.sticky=!0),i.effects.fireTrail&&(t.fireTrail=!0),i.effects.lightning&&(t.lightning=!0),i.effects.explosive&&(t.explosive=!0),i.effects.mirrorShots&&(t.mirrorShots=!0),i.effects.teleportShots&&(t.teleportShots=!0),i.effects.waveBullets&&(t.waveBullets=!0),i.effects.dragBullets&&(t.dragBullets=!0),i.effects.accelerateBullets&&(t.accelerateBullets=!0),i.effects.gravityBullets&&(t.gravityBullets=!0),i.effects.voodooOnHit&&(t.voodooOnHit+=i.effects.voodooOnHit),i.effects.creepyGunpowder&&(t.creepyGunpowder=!0),i.effects.detonator&&(t.detonator=!0),i.effects.castleCrusher&&(t.castleCrusher=!0),i.effects.tidalWave&&(t.tidalWave=!0),i.effects.momentum&&(t.momentum=!0),i.effects.carnageEngine&&(t.carnageEngine=!0),i.effects.minigun&&(t.minigun=!0),i.effects.cyclotron&&(t.cyclotron=!0),i.effects.burstFire&&(t.burstFire=Math.max(t.burstFire,i.effects.burstFire)),i.effects.turretBuddies&&(t.turretBuddies+=i.effects.turretBuddies),i.effects.shieldBuddies&&(t.shieldBuddies+=i.effects.shieldBuddies),i.effects.ratBuddies&&(t.ratBuddies+=i.effects.ratBuddies),i.effects.prismBuddies&&(t.prismBuddies+=i.effects.prismBuddies),i.effects.mirrorBuddies&&(t.mirrorBuddies+=i.effects.mirrorBuddies),i.effects.shieldCharges&&(t.shieldCharges+=i.effects.shieldCharges),i.effects.bulletShape&&(s=i.effects.bulletShape)),i.bulletShape&&(s=i.bulletShape))}this.hasItem("empty_dragon_egg")&&(e.damageFlat+=this.itemsOwned.length),this.statModifiers=e,this.itemEffects=t,this.itemEffects.bulletShape=s,this.maxLives=Math.max(1,Math.floor(y.maxLives+e.maxLivesAdd)),this.lives=Math.min(this.lives,this.maxLives),this.maxShieldCharges=t.shieldCharges,this.maxShieldCharges>0&&(this.shieldCharges=Math.max(this.shieldCharges,this.maxShieldCharges)),this.updateCurrentStats(),this.rebuildDronesFromItems(),this.rebuildOrbitalsFromItems(),this.updateInventoryUI(),this.updateShieldUI()}updateCurrentStats(){const e=this.hasItem("bullet_charm")?1+Math.min(1,this.bullets.length/40):1,t=(y.damage+this.statModifiers.damageFlat)*this.statModifiers.damageMult*this.dynamicDamageMult*e,s=y.bulletSpeed*this.statModifiers.bulletSpeedMult*e,a=this.statModifiers.fireRateMult*this.dynamicFireRateMult*e,i=(y.moveSpeed+this.statModifiers.moveSpeedFlat)*this.statModifiers.moveSpeedMult*this.dynamicMoveSpeedMult*e;let o=Math.max(.2,t);if(this.hasItem("elastic_cables")){const r=b(s/y.bulletSpeed,1,2);o*=r}this.currentStats={damage:o,fireRateMs:y.fireRateMs/Math.max(.2,a),bulletSpeed:s,moveSpeed:i,pierce:y.pierce+this.statModifiers.pierceFlat,shots:Math.max(1,y.shots+this.statModifiers.shotsAdd),spread:Math.max(0,y.spread+this.statModifiers.spreadAdd),maxLives:this.maxLives,bulletSize:y.bulletSize*this.statModifiers.bulletSizeMult}}updateDynamicModifiers(e){if(this.dynamicDamageMult=1,this.dynamicFireRateMult=1,this.dynamicMoveSpeedMult=1,this.itemEffects.minigun&&(this.minigunHeat=Math.max(0,this.minigunHeat-e*.2),this.dynamicFireRateMult*=1+this.minigunHeat*2),this.itemEffects.carnageEngine&&(this.itemDamageBuffTimer>0?this.itemDamageBuffTimer-=e:this.itemDamageBuff=Math.max(0,this.itemDamageBuff-e*.2),this.dynamicDamageMult*=1+this.itemDamageBuff),this.itemEffects.momentum){const t=Math.hypot(this.playerVelocityX,this.playerVelocityY),s=b(t/200,0,1);this.dynamicDamageMult*=1+s,this.dynamicFireRateMult*=1+s*.4,this.dynamicMoveSpeedMult*=1+s*.3}this.cheeseBuffTimer>0&&(this.cheeseBuffTimer-=e,this.cheeseBuffTimer<=0&&(this.cheeseBuffTimer=0,this.cheeseDamageMult=1),this.dynamicDamageMult*=this.cheeseDamageMult),this.updateCurrentStats()}updateItemBehaviors(e){this.itemEffects.ratBuddies>0&&(this.ratDropTimer-=e*1e3,this.ratDropTimer<=0&&(this.ratDropTimer=v(9e3,14e3),this.cheeseBuffTimer=4,this.cheeseDamageMult=3.2,this.floatingText.add(this.playerX,this.playerY-40,"Cheese!","#ffd27d",2)))}updateShieldUI(){const e=document.getElementById("shieldDisplay");if(e){if(this.maxShieldCharges<=0){e.textContent="";return}e.textContent="Shield "+this.shieldCharges+"/"+this.maxShieldCharges}}updateInventoryUI(){const e=document.getElementById("itemInventory");if(e){e.innerHTML="";for(const t of this.itemsOwned){const s=x.get(t);if(!s)continue;const a=document.createElement("div");a.className="item-chip"+(s.isCursed?" cursed":""),a.textContent=s.name,e.appendChild(a)}}}rebuildDronesFromItems(){this.drones=[];const e=this.itemEffects.turretBuddies+this.itemEffects.mirrorBuddies;if(!(e<=0))for(let t=0;t<e;t++)this.drones.push({x:this.playerX,y:this.playerY,targetX:this.playerX,targetY:this.playerY,wanderTimer:0,fireTimer:v(200,800),facingAngle:-Math.PI/2,active:!0})}rebuildOrbitalsFromItems(){this.orbitals=[];const e=this.itemEffects.shieldBuddies+this.itemEffects.prismBuddies+this.itemEffects.ratBuddies;if(e<=0)return;const t=n.DRONE_ORBIT_RADIUS*1.4;let s=0;const a=(i,o,r)=>{for(let l=0;l<o;l++){const c=(s+l)/Math.max(1,e)*Math.PI*2;this.orbitals.push({type:i,angle:c,radius:t+r,x:this.playerX,y:this.playerY,timer:0})}s+=o};a("shield",this.itemEffects.shieldBuddies,0),a("prism",this.itemEffects.prismBuddies,20),a("rat",this.itemEffects.ratBuddies,35)}updateOrbitals(e){if(this.orbitals.length!==0)for(const t of this.orbitals){const s=t.type==="shield"?1.2:t.type==="prism"?.9:.6;if(t.angle+=e*s,t.x=this.playerX+Math.cos(t.angle)*t.radius,t.y=this.playerY+Math.sin(t.angle)*t.radius,t.type==="shield")for(const a of this.asteroids){const i=n.ASTEROID_SIZES[a.size];p(t.x,t.y,a.x,a.y)<i.radius+10&&(a.health-=1,a.hitFlash=.2,a.health<=0&&this.handleAsteroidDestroyed(a))}if(t.type==="prism")for(const a of this.bullets){if(a.prismSplit)continue;p(t.x,t.y,a.x,a.y)<18&&(a.prismSplit=!0,this.spawnSplitBullets(a,3))}}}drawOrbitals(){if(this.orbitals.length===0)return;const e=this.ctx;for(const t of this.orbitals)e.save(),e.translate(t.x,t.y),t.type==="shield"?(e.strokeStyle="#66aaff",e.lineWidth=2,e.beginPath(),e.arc(0,0,10,0,Math.PI*2),e.stroke()):t.type==="prism"?(e.strokeStyle="#cc88ff",e.lineWidth=2,e.beginPath(),e.moveTo(0,-8),e.lineTo(7,6),e.lineTo(-7,6),e.closePath(),e.stroke()):(e.strokeStyle="#ffd27d",e.lineWidth=2,e.beginPath(),e.arc(0,0,8,0,Math.PI*2),e.stroke()),e.restore()}rollItemChoices(){const e=B.filter(i=>!this.itemsOwned.includes(i.id)),t=e.length>=3?e:B,s=[],a=new Set;for(;s.length<3&&a.size<t.length;){const i=t[Math.floor(Math.random()*t.length)];a.has(i.id)||(a.add(i.id),s.push(i))}this.currentItemChoices=s}applyItemChoice(e){const t=this.currentItemChoices[e];t&&(this.acquireItem(t.id),this.audio.playUpgrade(),this.audio.triggerHaptic("success"),this.destroyedCount=0,this.totalUpgrades++,document.getElementById("upgradeScreen")?.classList.add("hidden"),this.totalUpgrades===2&&!this.bossDefeated?(console.log("[applyItemChoice] Triggering boss fight after 2nd upgrade"),this.startBossFight()):(this.gameState="PLAYING",this.updateProgressBar()))}acquireItem(e){if(this.itemsOwned.includes(e))return;const t=x.get(e);t&&(console.log("[acquireItem]",t.name),this.itemsOwned.push(e),this.recalculateItemState(),this.floatingText.add(this.playerX,this.playerY-60,t.name,"#2d2d2d",1.6),(e==="spicy_cheezo"||e==="forbidden_gummi")&&(this.lives=this.maxLives),e==="ironplate_potion"&&(this.lives=Math.min(this.lives+2,this.maxLives)),this.updateLivesDisplay(),this.updateHUD())}updateLivesDisplay(){const e=document.getElementById("livesDisplay");if(e){e.innerHTML="";for(let t=0;t<this.maxLives;t++){const s=document.createElement("span");s.className="life-heart"+(t<this.lives?" filled":" empty"),s.innerHTML="&#9829;",e.appendChild(s)}}}triggerDamageEffect(){console.log("[triggerDamageEffect] Starting damage animation"),this.isInvincible=!0,this.damageTimer=1.5+this.statModifiers.invincibilityBonus,this.damageFlashTimer=0;const e=document.getElementById("damageOverlay");e&&(e.classList.add("active"),setTimeout(()=>{e.classList.remove("active")},300)),this.updateLivesDisplay(),this.audio.triggerHaptic("error"),this.triggerScreenShake(8),this.eventBus.emit("ON_DAMAGE",{lives:this.lives})}updateDamageState(e){this.isInvincible&&(this.damageTimer-=e,this.damageFlashTimer+=e*12,this.damageTimer<=0&&(this.isInvincible=!1,this.damageTimer=0,this.damageFlashTimer=0))}triggerScreenShake(e){this.screenShake.intensity=Math.max(this.screenShake.intensity,e)}updatePlayer(e){const t=n.PLAYER_WIDTH/2+10,s=100,a=60,i=this.currentStats.moveSpeed,o=this.playerX,r=this.playerY;if(!this.isMobile&&this.mouseX!==null&&this.mouseY!==null?(this.targetX=this.mouseX,this.targetY=this.mouseY-30):this.isMobile&&this.isDragging&&this.touchX!==null&&this.touchY!==null?(this.targetX=this.touchX,this.targetY=this.touchY-80):!this.isMobile&&this.mouseX===null&&((this.keysDown.has("ArrowLeft")||this.keysDown.has("a")||this.keysDown.has("A"))&&(this.targetX=this.playerX-i*e*60),(this.keysDown.has("ArrowRight")||this.keysDown.has("d")||this.keysDown.has("D"))&&(this.targetX=this.playerX+i*e*60),(this.keysDown.has("ArrowUp")||this.keysDown.has("w")||this.keysDown.has("W"))&&(this.targetY=this.playerY-i*e*60),(this.keysDown.has("ArrowDown")||this.keysDown.has("s")||this.keysDown.has("S"))&&(this.targetY=this.playerY+i*e*60)),this.targetX=b(this.targetX,t,this.w-t),this.targetY=b(this.targetY,s,this.h-a),this.selectedPlane==="glider")this.playerVelocityX=S(this.playerVelocityX,this.targetX-this.playerX,.12),this.playerVelocityY=S(this.playerVelocityY,this.targetY-this.playerY,.12),this.playerX+=this.playerVelocityX,this.playerY+=this.playerVelocityY;else{const u=this.mouseX!==null||this.isDragging?.25:.3;this.playerX=S(this.playerX,this.targetX,u),this.playerY=S(this.playerY,this.targetY,u)}this.playerX=b(this.playerX,t,this.w-t),this.playerY=b(this.playerY,s,this.h-a),this.playerVelocityX=this.playerX-o,this.playerVelocityY=this.playerY-r;const l=Math.hypot(this.playerVelocityX,this.playerVelocityY);l>.5&&this.eventBus.emit("ON_MOVE",{speed:l});const c=this.playerX-this.lastPlayerX;this.spinDirection===0&&Math.abs(c)>8&&(this.spinDirection=c>0?1:-1,this.spinAngle=0,this.audio.triggerHaptic("medium")),this.spinDirection!==0&&(this.spinAngle+=this.spinDirection*.35*e*60,Math.abs(this.spinAngle)>=Math.PI*2&&(this.spinAngle=0,this.spinDirection=0)),this.lastPlayerX=this.playerX}fireBullets(){this.itemEffects.minigun&&(this.minigunHeat=b(this.minigunHeat+.08,0,1));const e=this.currentStats;let t=e.shots,s=e.spread,a=1;if(this.itemEffects.minigun&&(s+=this.minigunHeat*12),this.itemEffects.cyclotron){const g=[{shots:1,spread:0,speed:1},{shots:3,spread:24,speed:.9},{shots:5,spread:60,speed:.8},{shots:2,spread:12,speed:1.15}],h=g[this.cyclotronIndex%g.length];t=Math.max(t,h.shots),s=Math.max(s,h.spread),a=h.speed,this.cyclotronIndex++}const i=-Math.PI/2,o=i-s/2*Math.PI/180,r=t>1?s*Math.PI/180/(t-1):0,l=this.itemEffects.castleCrusher?this.castleCrusherCounter%3===2:!1;this.itemEffects.castleCrusher&&this.castleCrusherCounter++;const c=l?2.5:1,d=l?2:0,u=this.itemEffects.burstFire>0?this.itemEffects.burstFire:1;for(let g=0;g<t;g++){let h=t===1?i:o+r*g;this.selectedPlane==="bomber"&&(h+=(Math.random()-.5)*4*Math.PI/180);for(let m=0;m<u;m++){const M=h+(m-(u-1)/2)*.02;this.spawnBullet(M,e,c,d,a)}}this.audio.playShoot(),this.eventBus.emit("ON_FIRE",{stats:this.currentStats})}getShotOrigin(){if(this.itemEffects.teleportShots){const e=this.isMobile?this.touchX:this.mouseX,t=this.isMobile?this.touchY:this.mouseY;if(e!==null&&t!==null)return{x:e,y:t}}return{x:this.playerX,y:this.playerY-n.PLAYER_HEIGHT/2}}spawnBullet(e,t,s,a,i,o=!1){const r=this.getShotOrigin(),l=this.bulletPool.acquire();if(l.x=r.x,l.y=r.y,l.vx=Math.cos(e)*t.bulletSpeed*i,l.vy=Math.sin(e)*t.bulletSpeed*i,l.damage=t.damage*s,l.pierceRemaining=t.pierce+a,l.explosive=this.itemEffects.explosive,l.chainLightning=this.itemEffects.lightning,l.active=!0,l.fromDrone=!1,l.age=0,l.maxAge=3.2,l.size=t.bulletSize,l.color=this.itemEffects.bulletShape==="star"?"#ffd27d":this.itemEffects.bulletShape==="bolt"?"#55ccff":this.itemEffects.bulletShape==="rocket"?"#ff9966":this.itemEffects.bulletShape==="bubble"?"#77ccee":n.PENCIL_DARK,l.shape=this.itemEffects.bulletShape??"line",l.wobblePhase=Math.random()*Math.PI*2,l.bounceRemaining=this.itemEffects.bounceCount,l.loop=this.itemEffects.loopBullets,l.homingStrength=this.itemEffects.homingStrength,l.snowball=this.itemEffects.snowball,l.snowballMax=this.itemEffects.snowballMax,l.sticky=this.itemEffects.sticky,l.stuckToId=-1,l.drag=this.itemEffects.dragBullets?.012:0,l.acceleration=this.itemEffects.accelerateBullets?.02:0,l.gravity=this.itemEffects.gravityBullets?.12:0,l.splitOnHit=this.itemEffects.splitOnHit,l.trailTimer=0,l.jitterOffset=v(-1.5,1.5),l.prismSplit=!1,this.bullets.push(l),this.itemEffects.mirrorShots&&!o){const c=e+Math.PI,d=this.bulletPool.acquire();d.x=this.w-r.x,d.y=r.y,d.vx=Math.cos(c)*t.bulletSpeed*i,d.vy=Math.sin(c)*t.bulletSpeed*i,d.damage=t.damage*s,d.pierceRemaining=t.pierce+a,d.explosive=this.itemEffects.explosive,d.chainLightning=this.itemEffects.lightning,d.active=!0,d.fromDrone=!1,d.age=0,d.maxAge=3.2,d.size=t.bulletSize,d.color=l.color,d.shape=l.shape,d.wobblePhase=l.wobblePhase,d.bounceRemaining=l.bounceRemaining,d.loop=l.loop,d.homingStrength=l.homingStrength,d.snowball=l.snowball,d.snowballMax=l.snowballMax,d.sticky=l.sticky,d.stuckToId=-1,d.drag=l.drag,d.acceleration=l.acceleration,d.gravity=l.gravity,d.splitOnHit=l.splitOnHit,d.trailTimer=0,d.jitterOffset=l.jitterOffset,d.prismSplit=!1,this.bullets.push(d)}return l}updateBullets(e){for(let t=this.bullets.length-1;t>=0;t--){const s=this.bullets[t];if(!s.active){this.bulletPool.release(s),this.bullets.splice(t,1);continue}if(s.age+=e,s.age>s.maxAge){this.bulletPool.release(s),this.bullets.splice(t,1);continue}if(s.sticky&&s.stuckToId>=0){const a=this.asteroids.find(i=>i.id===s.stuckToId);if(!a){this.bulletPool.release(s),this.bullets.splice(t,1);continue}s.x=a.x+s.stuckOffsetX,s.y=a.y+s.stuckOffsetY,s.trailTimer+=e,s.trailTimer>=.35&&(s.trailTimer=0,a.health-=s.damage*.35,a.hitFlash=.2,a.health<=0&&this.handleAsteroidDestroyed(a));continue}if(s.snowball){const a=1+Math.min(1,s.age/1.2)*(s.snowballMax-1);s.size=this.currentStats.bulletSize*a}if(s.homingStrength>0&&this.asteroids.length>0){const a=this.findNearestAsteroid(s.x,s.y,400);if(a){const i=a.x-s.x,o=a.y-s.y,r=Math.max(1,Math.sqrt(i*i+o*o)),l=s.homingStrength*e*60;s.vx=S(s.vx,i/r*this.currentStats.bulletSpeed,l),s.vy=S(s.vy,o/r*this.currentStats.bulletSpeed,l)}}if(s.acceleration>0){const a=Math.atan2(s.vy,s.vx),o=Math.sqrt(s.vx*s.vx+s.vy*s.vy)*(1+s.acceleration*e*60);s.vx=Math.cos(a)*o,s.vy=Math.sin(a)*o}if(s.drag>0){const a=Math.max(0,1-s.drag*e*60);s.vx*=a,s.vy*=a}if(s.gravity>0&&(s.vy+=s.gravity*e*60),this.itemEffects.waveBullets||s.shape==="note"||s.shape==="bolt"){s.wobblePhase+=e*8;const a=Math.sin(s.wobblePhase)*.6;s.x+=a}if(s.x+=s.vx*e*60,s.y+=s.vy*e*60,s.bounceRemaining>0&&!s.loop){const a=s.x<10||s.x>this.w-10,i=s.y<10||s.y>this.h-10;a&&(s.vx*=-1,s.bounceRemaining-=1),i&&(s.vy*=-1,s.bounceRemaining-=1)}this.itemEffects.fireTrail&&(s.trailTimer+=e,s.trailTimer>=.12&&(s.trailTimer=0,this.particles.emit(s.x,s.y,"#ff6644",2,"spark"))),s.loop?(s.x<-30&&(s.x=this.w+30),s.x>this.w+30&&(s.x=-30),s.y<-30&&(s.y=this.h+30),s.y>this.h+30&&(s.y=-30)):(s.y<-80||s.y>this.h+80||s.x<-80||s.x>this.w+80)&&(this.bulletPool.release(s),this.bullets.splice(t,1))}}findNearestAsteroid(e,t,s){let a=null,i=s;for(const o of this.asteroids){if(!o.active)continue;const r=p(e,t,o.x,o.y);r<i&&(i=r,a=o)}return a}spawnStarStrike(e,t,s){if(this.itemEffects.starOnHit<=0)return;const a=this.bulletPool.acquire(),i=b(e+v(-80,80),20,this.w-20),o=-40,r=Math.atan2(t-o,e-i);a.x=i,a.y=o,a.vx=Math.cos(r)*this.currentStats.bulletSpeed*1.4,a.vy=Math.sin(r)*this.currentStats.bulletSpeed*1.4,a.damage=s*this.itemEffects.starOnHit,a.pierceRemaining=0,a.explosive=!1,a.chainLightning=!1,a.active=!0,a.fromDrone=!1,a.age=0,a.maxAge=2.5,a.size=this.currentStats.bulletSize*.8,a.color="#ffd27d",a.shape="star",a.wobblePhase=0,a.bounceRemaining=0,a.loop=!1,a.homingStrength=0,a.snowball=!1,a.snowballMax=1,a.sticky=!1,a.stuckToId=-1,a.drag=0,a.acceleration=0,a.gravity=0,a.splitOnHit=0,a.trailTimer=0,a.jitterOffset=v(-1.2,1.2),a.prismSplit=!1,this.bullets.push(a)}spawnSplitBullets(e,t){const s=Math.atan2(e.vy,e.vx),a=.5;for(let i=0;i<t;i++){const o=t===1?0:S(-a,a,i/(t-1)),r=s+o,l=this.spawnBullet(r,this.currentStats,.6,0,.9);l.splitOnHit=Math.max(0,e.splitOnHit-1)}}handleAsteroidDestroyed(e,t){if(!e.active)return;e.active=!1;const s=n.ASTEROID_SIZES[e.size],a=Math.round(s.coins*this.statModifiers.coinMult);if(this.eventBus.emit("ASTEROID_DESTROYED",{asteroid:e,coins:a}),this.eventBus.emit("ON_KILL",{asteroid:e,sourceBullet:t}),e.isBossAsteroid||this.splitAsteroid(e),(t?.explosive||this.itemEffects.creepyGunpowder)&&this.handleExplosion(e.x,e.y,2,80),(t?.chainLightning||this.itemEffects.lightning)&&this.handleChainLightning(e.x,e.y,3,2),this.itemEffects.detonator)for(let i=0;i<3;i++){const o=i/3*Math.PI*2,r=this.spawnBullet(o,this.currentStats,.4,0,.7);r.age=.5}this.hasItem("reaper_pearl")&&Math.random()<.01&&(this.lives=Math.min(this.maxLives,this.lives+1),this.updateLivesDisplay());for(let i=this.bullets.length-1;i>=0;i--){const o=this.bullets[i];o.stuckToId===e.id&&(this.bulletPool.release(o),this.bullets.splice(i,1))}this.asteroidPool.release(e),this.asteroids=this.asteroids.filter(i=>i.id!==e.id)}spawnAsteroid(e,t,s,a,i){if(!e){const l=this.survivalTime/6e4,c=Math.min(.45,.2+l*.05),d=Math.min(.4,.35+l*.02),u=Math.random();u<c?e="large":u<c+d?e="medium":e="small"}const o=n.ASTEROID_SIZES[e],r=this.asteroidPool.acquire();r.id=++this.asteroidIdCounter,r.size=e,r.maxHealth=o.health+this.healthBonus,r.health=r.maxHealth,r.x=t??v(o.radius*.5,this.w-o.radius*.5),r.y=s??-o.radius-10,r.vx=a??v(-1.5,1.5),r.vy=i??o.speed*this.speedMultiplier,r.rotation=Math.random()*Math.PI*2,r.rotationSpeed=(Math.random()-.5)*.03,r.active=!0,r.hitFlash=0,r.isBossAsteroid=!1,this.asteroids.push(r)}updateAsteroids(e){for(let t=this.asteroids.length-1;t>=0;t--){const s=this.asteroids[t];s.x+=s.vx*e*60,s.y+=s.vy*e*60,s.rotation+=s.rotationSpeed*e*60;const a=n.ASTEROID_SIZES[s.size].speed*.5;s.vy<a&&(s.vy+=.08*e*60),s.hitFlash>0&&(s.hitFlash-=e);const i=n.ASTEROID_SIZES[s.size];s.x<0?(s.x=0,s.vx=Math.abs(s.vx)*.9):s.x>this.w&&(s.x=this.w,s.vx=-Math.abs(s.vx)*.9),s.y>this.h+i.radius+50&&(this.asteroidPool.release(s),this.asteroids.splice(t,1))}}updateDrones(e){if(this.drones.length===0)return;const t=this.currentStats.fireRateMs*1.6,s=Math.max(.3,this.currentStats.damage*.33),a=this.itemEffects.shieldBuddies>0,i=this.currentStats.pierce>0?1:0,o=n.DRONE_ORBIT_RADIUS*1.5,r=25;for(const l of this.drones){if(l.wanderTimer-=e*1e3,l.wanderTimer<=0){const h=n.DRONE_ORBIT_RADIUS*.8,m=Math.random()*Math.PI*2;l.targetX=this.playerX+Math.cos(m)*(20+Math.random()*h),l.targetY=this.playerY+Math.sin(m)*(20+Math.random()*h),l.wanderTimer=400+Math.random()*600}const c=p(l.targetX,l.targetY,this.playerX,this.playerY);if(c>o){const h=Math.atan2(this.playerY-l.targetY,this.playerX-l.targetX);l.targetX+=Math.cos(h)*(c-o),l.targetY+=Math.sin(h)*(c-o)}l.x=S(l.x,l.targetX,.08),l.y=S(l.y,l.targetY,.08);const d=p(l.x,l.y,this.playerX,this.playerY);if(d>o){const h=Math.atan2(this.playerY-l.y,this.playerX-l.x);l.x=this.playerX-Math.cos(h)*o,l.y=this.playerY-Math.sin(h)*o}else if(d<r){const h=Math.atan2(l.y-this.playerY,l.x-this.playerX);l.x=this.playerX+Math.cos(h)*r,l.y=this.playerY+Math.sin(h)*r}let u=null,g=-1/0;for(const h of this.asteroids){let M=-p(l.x,l.y,h.x,h.y);h.health>=4&&(M+=200),a&&h.y>this.playerY-100&&(M+=300),M>g&&(g=M,u=h)}if(u){let m=Math.atan2(u.y-l.y,u.x-l.x)-l.facingAngle;for(;m>Math.PI;)m-=Math.PI*2;for(;m<-Math.PI;)m+=Math.PI*2;l.facingAngle+=m*.15}else{let h=-Math.PI/2-l.facingAngle;for(;h>Math.PI;)h-=Math.PI*2;for(;h<-Math.PI;)h+=Math.PI*2;l.facingAngle+=h*.1}if(l.fireTimer-=e*1e3,l.fireTimer<=0&&u){const h=this.bulletPool.acquire();h.x=l.x,h.y=l.y,h.vx=Math.cos(l.facingAngle)*this.currentStats.bulletSpeed*.8,h.vy=Math.sin(l.facingAngle)*this.currentStats.bulletSpeed*.8,h.damage=s,h.pierceRemaining=i,h.explosive=!1,h.chainLightning=this.itemEffects.lightning,h.active=!0,h.fromDrone=!0,h.age=0,h.maxAge=2.2,h.size=this.currentStats.bulletSize*.8,h.color=n.PENCIL_DARK,h.shape="line",h.wobblePhase=Math.random()*Math.PI*2,h.bounceRemaining=0,h.loop=!1,h.homingStrength=this.itemEffects.homingStrength*.6,h.snowball=!1,h.snowballMax=1,h.sticky=!1,h.stuckToId=-1,h.drag=0,h.acceleration=0,h.gravity=0,h.splitOnHit=0,h.trailTimer=0,h.jitterOffset=v(-1,1),h.prismSplit=!1,this.bullets.push(h),l.fireTimer=t}else l.fireTimer<=0&&(l.fireTimer=t)}}checkCollisions(){for(let e=this.bullets.length-1;e>=0;e--){const t=this.bullets[e];if(t.active)for(let s=this.asteroids.length-1;s>=0;s--){const a=this.asteroids[s];if(!a.active)continue;const i=n.ASTEROID_SIZES[a.size],o=p(t.x,t.y,a.x,a.y);if(o<i.radius+5){const r=t.snowball?1+Math.min(1,t.age/1.2)*(t.snowballMax-1):1,l=t.damage*r;if(a.health-=l,a.hitFlash=.15,this.eventBus.emit("ASTEROID_HIT",{asteroid:a,damage:l}),this.eventBus.emit("ON_HIT",{asteroid:a,bullet:t,damage:l}),this.itemEffects.carnageEngine&&(this.itemDamageBuff=b(this.itemDamageBuff+.05,0,1),this.itemDamageBuffTimer=2.5),this.itemEffects.voodooOnHit>0)for(const c of this.asteroids){if(c.id===a.id||c.size!==a.size)continue;p(a.x,a.y,c.x,c.y)<i.radius*2.2&&(c.health-=l*this.itemEffects.voodooOnHit,c.hitFlash=.1,c.health<=0&&this.handleAsteroidDestroyed(c,t))}if(this.itemEffects.starOnHit>0&&this.spawnStarStrike(a.x,a.y,l),t.splitOnHit>0&&this.spawnSplitBullets(t,Math.min(2,t.splitOnHit)),t.sticky&&t.stuckToId===-1&&(t.stuckToId=a.id,t.stuckOffsetX=t.x-a.x,t.stuckOffsetY=t.y-a.y),a.health<=0&&this.handleAsteroidDestroyed(a,t),t.bounceRemaining>0){const c=(t.x-a.x)/Math.max(1,o),d=(t.y-a.y)/Math.max(1,o),u=t.vx*c+t.vy*d;t.vx=t.vx-2*u*c,t.vy=t.vy-2*u*d,t.bounceRemaining-=1;break}if(t.pierceRemaining>0)t.pierceRemaining--;else if(!t.sticky){this.bulletPool.release(t),this.bullets.splice(e,1);break}}}}for(const e of this.asteroids){const t=n.ASTEROID_SIZES[e.size];if(p(this.playerX,this.playerY,e.x,e.y)<t.radius+n.PLAYER_WIDTH/3){if(this.shieldCharges>0){this.shieldCharges--,this.updateShieldUI(),e.health-=1,e.hitFlash=.2,e.health<=0&&this.handleAsteroidDestroyed(e),this.triggerScreenShake(4);return}this.eventBus.emit("PLAYER_HIT",{});return}}}splitAsteroid(e){if(e.size==="small")return;const t=e.size==="large"?"medium":"small",s=n.ASTEROID_SIZES[t];for(let a=0;a<2;a++){const i=a===0?-1:1;s.speed*this.speedMultiplier;const o=(2.5+Math.random()*1.5)*i,r=-(1.5+Math.random()*2);this.spawnAsteroid(t,e.x+i*15,e.y,o,r)}}handleExplosion(e,t,s,a){this.particles.emit(e,t,"#ff6600",15,"explosion"),this.triggerScreenShake(.4);for(const i of this.asteroids)p(e,t,i.x,i.y)<a&&(i.health-=s,i.health<=0&&this.handleAsteroidDestroyed(i))}handleChainLightning(e,t,s,a){const i=[];for(let o=0;o<s;o++){let r=null,l=1/0;for(const c of this.asteroids){if(i.includes(c))continue;const d=p(e,t,c.x,c.y);d<150&&d<l&&(l=d,r=c)}if(r){if(!r.active)continue;i.push(r),r.health-=a,r.hitFlash=.15,this.particles.emit(r.x,r.y,"#00ffff",6,"spark"),r.health<=0&&this.handleAsteroidDestroyed(r),e=r.x,t=r.y}}}updateDifficulty(e){this.survivalTime+=e*1e3;const t=Math.min(2,1+Math.floor(this.survivalTime/n.SPEED_INCREASE_INTERVAL)*.05);t!==this.speedMultiplier&&(this.speedMultiplier=t,console.log("[updateDifficulty] Speed multiplier:",this.speedMultiplier));const s=Math.floor(this.survivalTime/n.HEALTH_INCREASE_INTERVAL);s!==this.healthBonus&&(this.healthBonus=s,console.log("[updateDifficulty] Health bonus:",this.healthBonus))}updateBossAnnouncement(e){if(this.bossAnnouncementTimer>0&&(this.bossAnnouncementTimer-=e,this.bossAnnouncementTimer<=0)){const t=document.getElementById("bossAnnouncement");t&&t.classList.remove("active")}}updateBoss(e){!this.boss||!this.boss.active||(this.boss.entering&&(this.boss.y=S(this.boss.y,this.boss.targetY,.03),Math.abs(this.boss.y-this.boss.targetY)<2&&(this.boss.y=this.boss.targetY,this.boss.entering=!1,console.log("[updateBoss] Boss finished entering"))),this.boss.rotation+=e*.3,this.boss.pulsePhase+=e*2,!this.boss.entering&&this.boss.throwCount<n.BOSS_MAX_THROWS&&(this.boss.throwTimer-=e*1e3,this.boss.throwTimer<=0&&(this.bossThrowAsteroid(),this.boss.throwCount++,this.boss.throwTimer=n.BOSS_THROW_INTERVAL,console.log("[updateBoss] Boss threw asteroid",this.boss.throwCount,"/",n.BOSS_MAX_THROWS))))}bossThrowAsteroid(){if(!this.boss)return;const e=this.playerX-this.boss.x,t=this.playerY-this.boss.y,s=Math.sqrt(e*e+t*t),a=3.5,i=e/s*a,o=t/s*a,r=this.asteroidPool.acquire();r&&(r.id=++this.asteroidIdCounter,r.size="large",r.maxHealth=n.BOSS_ASTEROID_HEALTH,r.health=n.BOSS_ASTEROID_HEALTH,r.x=this.boss.x,r.y=this.boss.y+n.BOSS_RADIUS*.8,r.vx=i,r.vy=o,r.rotation=Math.random()*Math.PI*2,r.rotationSpeed=v(-2,2),r.active=!0,r.hitFlash=0,r.isBossAsteroid=!0,this.asteroids.push(r),this.audio.triggerHaptic("medium"))}checkBossCollisions(){if(!(!this.boss||!this.boss.active||this.boss.entering))for(let e=this.bullets.length-1;e>=0;e--){const t=this.bullets[e];if(!t.active)continue;if(p(t.x,t.y,this.boss.x,this.boss.y)<n.BOSS_RADIUS){const a=t.snowball?1+Math.min(1,t.age/1.2)*(t.snowballMax-1):1,i=t.damage*a;t.active=!1,this.bulletPool.release(t),this.bullets.splice(e,1),this.boss.health-=i,this.particles.emit(t.x,t.y,n.PENCIL_DARK,5,"spark"),this.audio.playHit(),this.triggerScreenShake(2),console.log("[checkBossCollisions] Boss hit! Health:",this.boss.health),this.itemEffects.starOnHit>0&&this.spawnStarStrike(this.boss.x,this.boss.y,i),this.boss.health<=0&&this.defeatBoss()}}}defeatBoss(){if(!this.boss)return;console.log("[defeatBoss] Boss defeated!"),this.particles.emit(this.boss.x,this.boss.y,n.PENCIL_DARK,30,"explosion"),this.particles.emit(this.boss.x,this.boss.y,"#ff6644",20,"spark"),this.particles.emit(this.boss.x,this.boss.y,n.PAPER_BG,25,"paper");const e=50;this.coins+=e,this.score+=e*10,this.floatingText.add(this.boss.x,this.boss.y,"+"+e,"#ffcc00",2),this.boss.active=!1,this.boss.defeated=!0,this.bossDefeated=!0,this.asteroids.forEach(t=>{t.isBossAsteroid&&(t.active=!1)}),this.audio.playUpgrade(),this.audio.triggerHaptic("success"),this.triggerScreenShake(15),setTimeout(()=>{this.gameState="PLAYING",this.updateProgressBar(),console.log("[defeatBoss] Resuming normal gameplay")},1e3)}drawBackground(){const e=this.ctx;e.fillStyle=n.PAPER_BG,e.fillRect(0,0,this.w,this.h),this.bgOffset=(this.bgOffset+n.BACKGROUND_SCROLL_SPEED*.016)%n.GRID_SIZE,e.strokeStyle=n.GRID_LINE,e.lineWidth=1;for(let t=0;t<this.w;t+=n.GRID_SIZE)e.beginPath(),e.moveTo(t,0),e.lineTo(t,this.h),e.stroke();for(let t=this.bgOffset;t<this.h+n.GRID_SIZE;t+=n.GRID_SIZE)e.beginPath(),e.moveTo(0,t),e.lineTo(this.w,t),e.stroke();e.strokeStyle="#ffaaaa",e.lineWidth=2,e.beginPath(),e.moveTo(60,0),e.lineTo(60,this.h),e.stroke()}drawPlayer(){const e=this.ctx,t=this.playerX,s=this.playerY;if(this.isInvincible&&Math.floor(this.damageFlashTimer)%2===1)return;e.save(),e.translate(t,s);const a=(this.targetX-this.playerX)*.01;if(e.rotate(b(a,-.3,.3)),this.spinDirection!==0){const o=Math.cos(this.spinAngle);e.scale(o,1)}const i=this.isInvincible?.7:1;e.globalAlpha=i,e.strokeStyle=this.isInvincible?"#ff6666":n.PENCIL_DARK,e.lineWidth=2,e.fillStyle=this.isInvincible?"#ffcccc":"#ffffff",this.selectedPlane==="dart"?(e.beginPath(),e.moveTo(0,-30),e.lineTo(-20,25),e.lineTo(0,15),e.lineTo(20,25),e.closePath(),e.fill(),e.stroke(),e.beginPath(),e.moveTo(0,-30),e.lineTo(0,15),e.stroke()):this.selectedPlane==="glider"?(e.beginPath(),e.moveTo(0,-25),e.lineTo(-35,20),e.lineTo(-25,25),e.lineTo(0,10),e.lineTo(25,25),e.lineTo(35,20),e.closePath(),e.fill(),e.stroke(),e.beginPath(),e.moveTo(-18,22),e.lineTo(0,-20),e.lineTo(18,22),e.stroke()):(e.beginPath(),e.moveTo(0,-20),e.lineTo(-25,15),e.lineTo(-20,25),e.lineTo(0,20),e.lineTo(20,25),e.lineTo(25,15),e.closePath(),e.fill(),e.stroke(),e.fillStyle="#f8f8f8",e.beginPath(),e.moveTo(-8,-15),e.lineTo(8,-15),e.lineTo(10,20),e.lineTo(-10,20),e.closePath(),e.fill(),e.stroke()),e.restore()}drawDrones(){if(this.drones.length===0)return;const e=this.ctx;for(const t of this.drones)e.save(),e.translate(t.x,t.y),e.rotate(t.facingAngle+Math.PI/2),e.strokeStyle=n.PENCIL_DARK,e.lineWidth=1.5,e.fillStyle="#f0f0f0",e.beginPath(),e.moveTo(0,-10),e.lineTo(-8,8),e.lineTo(0,4),e.lineTo(8,8),e.closePath(),e.fill(),e.stroke(),e.restore()}drawBullets(){const e=this.ctx;for(const t of this.bullets){if(e.save(),e.translate(t.x,t.y),e.rotate(Math.atan2(t.vy,t.vx)+Math.PI/2),t.shape==="note")e.fillStyle="#3b2f2f",e.strokeStyle=n.PENCIL_DARK,e.lineWidth=2,e.beginPath(),e.ellipse(0,6,5*t.size,4*t.size,.2,0,Math.PI*2),e.fill(),e.stroke(),e.beginPath(),e.moveTo(3,-14*t.size),e.lineTo(3,2*t.size),e.stroke(),e.beginPath(),e.arc(6,-14*t.size,4*t.size,Math.PI,Math.PI*1.6),e.stroke();else if(t.shape==="star"){e.fillStyle=t.color,e.strokeStyle=n.PENCIL_DARK,e.lineWidth=2,e.beginPath();for(let s=0;s<5;s++){const a=s*2*Math.PI/5-Math.PI/2,i=8*t.size,o=4*t.size,r=Math.cos(a)*i,l=Math.sin(a)*i,c=Math.cos(a+Math.PI/5)*o,d=Math.sin(a+Math.PI/5)*o;s===0?e.moveTo(r,l):e.lineTo(r,l),e.lineTo(c,d)}e.closePath(),e.fill(),e.stroke()}else t.shape==="bolt"?(e.strokeStyle=t.color,e.lineWidth=3,e.lineCap="round",e.beginPath(),e.moveTo(-4,-10),e.lineTo(2,-2),e.lineTo(-2,2),e.lineTo(4,10),e.stroke()):t.shape==="rocket"?(e.fillStyle=t.color,e.strokeStyle=n.PENCIL_DARK,e.lineWidth=2,e.beginPath(),e.moveTo(0,-12*t.size),e.lineTo(-5*t.size,8*t.size),e.lineTo(5*t.size,8*t.size),e.closePath(),e.fill(),e.stroke(),e.fillStyle="#ffcc66",e.beginPath(),e.moveTo(0,10*t.size),e.lineTo(-3*t.size,15*t.size),e.lineTo(3*t.size,15*t.size),e.closePath(),e.fill()):t.shape==="bubble"?(e.strokeStyle=t.color,e.lineWidth=2,e.beginPath(),e.arc(0,0,8*t.size,0,Math.PI*2),e.stroke(),e.beginPath(),e.arc(3*t.size,-4*t.size,2*t.size,0,Math.PI*2),e.stroke()):(e.strokeStyle=t.color,e.lineWidth=t.fromDrone?2:3,e.lineCap="round",e.beginPath(),e.moveTo(t.jitterOffset*.5,-10*t.size),e.lineTo(-t.jitterOffset*.5,10*t.size),e.stroke());e.restore()}}drawAsteroids(){const e=this.ctx;for(const t of this.asteroids){const s=n.ASTEROID_SIZES[t.size];e.save(),e.translate(t.x,t.y),e.rotate(t.rotation),t.hitFlash>0&&(e.globalAlpha=.5+t.hitFlash*2),e.fillStyle="#e8e8e0",e.strokeStyle=n.PENCIL_DARK,e.lineWidth=2,e.beginPath();const a=8;for(let i=0;i<a;i++){const o=i/a*Math.PI*2,r=.8+Math.sin(t.id*100+i*50)*.3,l=s.radius*r;i===0?e.moveTo(Math.cos(o)*l,Math.sin(o)*l):e.lineTo(Math.cos(o)*l,Math.sin(o)*l)}e.closePath(),e.fill(),e.stroke(),t.isBossAsteroid&&(e.fillStyle=n.PENCIL_DARK,e.font="bold 18px "+n.FONT_FAMILY,e.textAlign="center",e.textBaseline="middle",e.fillText(t.health.toString(),0,2)),e.strokeStyle=n.PENCIL_LIGHT,e.lineWidth=1;for(let i=0;i<3;i++){const o=(t.id*37+i*120)*(Math.PI/180),r=o+.5;e.beginPath(),e.moveTo(Math.cos(o)*s.radius*.3,Math.sin(o)*s.radius*.3),e.lineTo(Math.cos(r)*s.radius*.7,Math.sin(r)*s.radius*.7),e.stroke()}e.rotate(-t.rotation),e.font="bold "+s.radius*.6+"px Caveat, cursive",e.textAlign="center",e.textBaseline="middle",e.fillStyle=n.PENCIL_DARK,e.fillText(t.health.toString(),0,0),e.restore()}}initDemoAnimation(){if(!this.demoCanvas)return;console.log("[initDemoAnimation]");const e=this.demoCanvas.parentElement;e&&(this.demoCanvas.width=e.clientWidth,this.demoCanvas.height=e.clientHeight),this.demoPlaneX=this.demoCanvas.width/2,this.demoPlaneY=this.demoCanvas.height-35,this.demoPlaneTargetX=this.demoPlaneX,this.demoPlaneDirection=1,this.demoBullets=[],this.demoAsteroids=[],this.demoParticles=[]}updateDemoAnimation(e){if(!this.demoCanvas||!this.demoCtx)return;const t=this.demoCanvas.width,s=this.demoCanvas.height;this.demoBgOffset=(this.demoBgOffset+30*e)%25,Math.random()<.02&&(this.demoPlaneTargetX=40+Math.random()*(t-80)),this.demoPlaneX=S(this.demoPlaneX,this.demoPlaneTargetX,.05),this.demoFireTimer-=e*1e3,this.demoFireTimer<=0&&(this.demoBullets.push({x:this.demoPlaneX,y:this.demoPlaneY-15,vy:-6,active:!0}),this.demoFireTimer=200),this.demoSpawnTimer-=e*1e3,this.demoSpawnTimer<=0&&(this.demoAsteroids.push({x:30+Math.random()*(t-60),y:-25,vx:(Math.random()-.5)*2,vy:1.8+Math.random()*1.2,radius:18+Math.random()*12,rotation:Math.random()*Math.PI*2,rotationSpeed:(Math.random()-.5)*.05,health:2,active:!0}),this.demoSpawnTimer=800+Math.random()*400);for(let a=this.demoBullets.length-1;a>=0;a--){const i=this.demoBullets[a];i.y+=i.vy,i.y<-10&&this.demoBullets.splice(a,1)}for(let a=this.demoAsteroids.length-1;a>=0;a--){const i=this.demoAsteroids[a];i.x+=i.vx,i.y+=i.vy,i.rotation+=i.rotationSpeed,i.x-i.radius<0?(i.x=i.radius,i.vx=Math.abs(i.vx)):i.x+i.radius>t&&(i.x=t-i.radius,i.vx=-Math.abs(i.vx)),i.y>s+30&&this.demoAsteroids.splice(a,1)}for(let a=this.demoParticles.length-1;a>=0;a--){const i=this.demoParticles[a];i.x+=i.vx,i.y+=i.vy,i.vy+=.15,i.life-=.04,i.life<=0&&this.demoParticles.splice(a,1)}for(let a=this.demoBullets.length-1;a>=0;a--){const i=this.demoBullets[a];for(let o=this.demoAsteroids.length-1;o>=0;o--){const r=this.demoAsteroids[o];if(Math.sqrt((i.x-r.x)**2+(i.y-r.y)**2)<r.radius+4){if(r.health--,this.demoBullets.splice(a,1),r.health<=0){for(let c=0;c<6;c++){const d=Math.random()*Math.PI*2,u=1+Math.random()*2;this.demoParticles.push({x:r.x,y:r.y,vx:Math.cos(d)*u,vy:Math.sin(d)*u,life:1,size:3+Math.random()*4})}this.demoAsteroids.splice(o,1)}break}}}}renderDemoAnimation(){if(!this.demoCanvas||!this.demoCtx)return;const e=this.demoCtx,t=this.demoCanvas.width,s=this.demoCanvas.height;e.fillStyle="#f5f5dc",e.fillRect(0,0,t,s),e.strokeStyle="#d4d4c4",e.lineWidth=1;for(let i=0;i<t;i+=25)e.beginPath(),e.moveTo(i,0),e.lineTo(i,s),e.stroke();for(let i=this.demoBgOffset;i<s+25;i+=25)e.beginPath(),e.moveTo(0,i),e.lineTo(t,i),e.stroke();for(const i of this.demoAsteroids){e.save(),e.translate(i.x,i.y),e.rotate(i.rotation),e.fillStyle="#e8e8e0",e.strokeStyle="#2d2d2d",e.lineWidth=1.5,e.beginPath();for(let o=0;o<6;o++){const r=o/6*Math.PI*2,l=.85+Math.sin(o*47)*.2,c=i.radius*l;o===0?e.moveTo(Math.cos(r)*c,Math.sin(r)*c):e.lineTo(Math.cos(r)*c,Math.sin(r)*c)}e.closePath(),e.fill(),e.stroke(),e.restore()}e.strokeStyle="#2d2d2d",e.lineWidth=2,e.lineCap="round";for(const i of this.demoBullets)e.beginPath(),e.moveTo(i.x,i.y-6),e.lineTo(i.x,i.y+6),e.stroke();for(const i of this.demoParticles)e.globalAlpha=i.life,e.fillStyle="#2d2d2d",e.beginPath(),e.arc(i.x,i.y,i.size*i.life,0,Math.PI*2),e.fill();e.globalAlpha=1,e.save(),e.translate(this.demoPlaneX,this.demoPlaneY);const a=(this.demoPlaneTargetX-this.demoPlaneX)*.015;e.rotate(b(a,-.25,.25)),e.strokeStyle="#2d2d2d",e.lineWidth=1.5,e.fillStyle="#ffffff",e.beginPath(),e.moveTo(0,-18),e.lineTo(-12,14),e.lineTo(0,8),e.lineTo(12,14),e.closePath(),e.fill(),e.stroke(),e.beginPath(),e.moveTo(0,-18),e.lineTo(0,8),e.stroke(),e.restore()}gameLoop(e){const t=Math.min((e-this.lastTime)/1e3,.1);this.lastTime=e,this.update(t),this.render(),this.gameState==="START"&&(this.updateDemoAnimation(t),this.renderDemoAnimation()),requestAnimationFrame(s=>this.gameLoop(s))}update(e){if(this.screenShake.intensity>0&&(this.screenShake.x=(Math.random()-.5)*this.screenShake.intensity*15,this.screenShake.y=(Math.random()-.5)*this.screenShake.intensity*15,this.screenShake.intensity*=.9,this.screenShake.intensity<.01&&(this.screenShake.intensity=0,this.screenShake.x=0,this.screenShake.y=0)),this.particles.update(e),this.floatingText.update(e),this.gameState==="PLAYING"){this.updateDynamicModifiers(e),this.updateItemBehaviors(e),this.updatePlayer(e),this.updateDamageState(e),this.updateDrones(e),this.updateOrbitals(e),this.updateBullets(e),this.updateAsteroids(e),this.checkCollisions(),this.updateDifficulty(e);const t=this.currentStats.fireRateMs;this.fireTimer-=e*1e3,this.fireTimer<=0&&(this.fireBullets(),this.fireTimer=t);const s=Math.max(n.SPAWN_INTERVAL_MIN,n.SPAWN_INTERVAL_START-this.survivalTime*.02);this.spawnTimer-=e*1e3,this.spawnTimer<=0&&(this.spawnAsteroid(),this.spawnTimer=s),this.updateHUD()}else if(this.gameState==="UPGRADE"){if(this.upgradeAutoSelectTimer-=e*1e3,this.updateUpgradeTimer(),this.upgradeAutoSelectTimer<=0&&this.currentItemChoices.length>0){const t=Math.floor(Math.random()*this.currentItemChoices.length);this.applyItemChoice(t)}}else if(this.gameState==="BOSS"){this.updateBossAnnouncement(e),this.updateDynamicModifiers(e),this.updateItemBehaviors(e),this.updatePlayer(e),this.updateDamageState(e),this.updateDrones(e),this.updateOrbitals(e),this.updateBullets(e),this.updateAsteroids(e),this.updateBoss(e),this.checkBossCollisions(),this.checkCollisions();const t=this.currentStats.fireRateMs;this.fireTimer-=e*1e3,this.fireTimer<=0&&(this.fireBullets(),this.fireTimer=t),this.updateHUD()}}render(){const e=this.ctx;e.save(),e.translate(this.screenShake.x,this.screenShake.y),this.drawBackground(),(this.gameState==="PLAYING"||this.gameState==="PAUSED"||this.gameState==="UPGRADE"||this.gameState==="GAME_OVER"||this.gameState==="BOSS")&&(this.drawAsteroids(),this.drawBullets(),this.drawDrones(),this.drawOrbitals(),this.drawPlayer(),this.particles.draw(e),this.floatingText.draw(e),this.gameState==="BOSS"&&this.boss&&this.boss.active&&this.drawBoss()),e.restore()}drawBoss(){if(!this.boss)return;const e=this.ctx,t=this.boss.x,s=this.boss.y,a=n.BOSS_RADIUS,i=1+Math.sin(this.boss.pulsePhase)*.03,o=a*i;e.save(),e.translate(t,s),e.rotate(this.boss.rotation),e.beginPath(),e.strokeStyle=n.PENCIL_DARK,e.lineWidth=3,e.fillStyle="#e8e0d5";const r=16,l=[.92,.85,.88,.95,.82,.9,.87,.93,.84,.91,.86,.94,.83,.89,.96,.88,.92];for(let u=0;u<=r;u++){const g=u/r*Math.PI*2,h=o*l[u],m=Math.cos(g)*h,M=Math.sin(g)*h;u===0?e.moveTo(m,M):e.lineTo(m,M)}e.closePath(),e.fill(),e.stroke();const c=[{x:-35,y:-25,r:22},{x:40,y:10,r:18},{x:-15,y:35,r:25},{x:25,y:-40,r:15},{x:-50,y:15,r:12}];e.strokeStyle=n.PENCIL_MEDIUM,e.lineWidth=2;for(const u of c)e.beginPath(),e.ellipse(u.x,u.y,u.r,u.r*.8,.3,0,Math.PI*2),e.stroke(),e.beginPath(),e.ellipse(u.x+3,u.y+3,u.r*.6,u.r*.5,.3,0,Math.PI*2),e.stroke();e.strokeStyle=n.PENCIL_LIGHT,e.lineWidth=1;const d=[{angle:.4,length:35},{angle:1.2,length:42},{angle:2,length:28},{angle:2.8,length:38},{angle:3.6,length:45},{angle:4.4,length:32},{angle:5.2,length:40},{angle:5.9,length:30}];for(const u of d)e.beginPath(),e.moveTo(Math.cos(u.angle)*30,Math.sin(u.angle)*30),e.lineTo(Math.cos(u.angle)*(30+u.length),Math.sin(u.angle)*(30+u.length)),e.stroke();e.restore(),this.drawBossHealthBar(t,s-o-25)}drawBossHealthBar(e,t){if(!this.boss)return;const s=this.ctx,a=160,i=12,o=this.boss.health/this.boss.maxHealth;s.fillStyle="rgba(0, 0, 0, 0.3)",s.fillRect(e-a/2,t,a,i);const r=o>.5?"#44cc44":o>.25?"#cccc44":"#cc4444";s.fillStyle=r,s.fillRect(e-a/2,t,a*o,i),s.strokeStyle=n.PENCIL_DARK,s.lineWidth=2,s.strokeRect(e-a/2,t,a,i),s.fillStyle=n.PENCIL_DARK,s.font="bold 10px "+n.FONT_FAMILY,s.textAlign="center",s.fillText(this.boss.health+"/"+this.boss.maxHealth,e,t+i+12)}}window.addEventListener("DOMContentLoaded",()=>{console.log("[main] Initializing Paper Plane Asteroid Survivor"),new P});</script>
</head>
<body>
    <div id="game-container">
        <canvas id="gameCanvas"></canvas>

        <!-- Damage Overlay -->
        <div id="damageOverlay"></div>

        <!-- Boss Announcement -->
        <div id="bossAnnouncement">
            <div class="boss-text">BOSS INCOMING</div>
        </div>

        <!-- HUD -->
        <div id="hud" class="hidden">
            <div class="hud-left">
                <div class="hud-label">Time</div>
                <div class="hud-value" id="timeDisplay">0:00</div>
            </div>
            <div class="hud-center">
                <div class="hud-lives" id="livesDisplay"></div>
                <div class="hud-shield" id="shieldDisplay"></div>
                <div class="progress-bar-container">
                    <div class="progress-bar-bg">
                        <div class="progress-bar-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">0/6</div>
                </div>
            </div>
            <div class="hud-right">
                <div class="hud-label">Coins</div>
                <div class="hud-value" id="coinDisplay">0</div>
            </div>
        </div>

        <!-- Item Inventory -->
        <div id="itemInventory" class="item-inventory hidden"></div>

        <!-- Pause Button -->
        <button id="pauseBtn" class="hidden">
            <svg viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
        </button>

        <!-- Settings Button -->
        <button id="settingsBtn">
            <svg viewBox="0 0 24 24">
                <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
            </svg>
        </button>

        <!-- Start Screen -->
        <div id="startScreen" class="overlay">
            <div class="content">
                <h1 class="title">Paper Plane</h1>
                <p class="subtitle">Asteroid Survivor</p>

                <div class="demo-container">
                    <canvas id="demoCanvas"></canvas>
                </div>

                <div class="start-buttons">
                    <button class="btn" id="startButton">Start Flight</button>
                    <button class="btn btn-secondary" id="galleryButton">Gallery</button>
                </div>
            </div>
        </div>

        <!-- Gallery Screen -->
        <div id="galleryScreen" class="overlay hidden">
            <div class="content gallery-content">
                <h2 class="plane-select-title">Gallery</h2>

                <div class="gallery-section">
                    <h3 class="gallery-title">Planes</h3>
                    <div class="plane-selection">
                        <div class="plane-card selected" data-plane="dart">
                            <div class="plane-icon">D</div>
                            <div class="plane-name">The Dart</div>
                            <div class="plane-quirk">Precise aim, perfectly straight shots</div>
                        </div>
                        <div class="plane-card" data-plane="glider">
                            <div class="plane-icon">G</div>
                            <div class="plane-name">The Glider</div>
                            <div class="plane-quirk">Floaty movement with momentum drift</div>
                        </div>
                        <div class="plane-card" data-plane="bomber">
                            <div class="plane-icon">B</div>
                            <div class="plane-name">Dart Bomber</div>
                            <div class="plane-quirk">Twitchy controls, sketchy aim spread</div>
                        </div>
                    </div>
                </div>

                <div class="gallery-section">
                    <h3 class="gallery-title">Bosses</h3>
                    <div class="boss-gallery">
                        <div class="boss-card">
                            <div class="boss-name">Mother Asteroid</div>
                            <div class="boss-desc">A massive crumpled asteroid that hurls 10 HP chunks at you.</div>
                        </div>
                    </div>
                </div>

                <div class="gallery-section">
                    <h3 class="gallery-title">Modifiers</h3>
                    <div class="modifier-gallery">
                        <div class="modifier-chip">Zenith's Spare Hat</div>
                        <div class="modifier-chip">Whole Milk</div>
                        <div class="modifier-chip">Split Bullets</div>
                        <div class="modifier-chip">Heckfire Bullets</div>
                        <div class="modifier-chip">Rubber Band Ball</div>
                        <div class="modifier-chip">Turret Buddy</div>
                        <div class="modifier-chip">Snowball</div>
                        <div class="modifier-chip">Tesla Coil</div>
                    </div>
                </div>

                <button class="btn btn-secondary" id="backFromGalleryBtn">Back</button>
            </div>
        </div>

        <!-- Upgrade Screen -->
        <div id="upgradeScreen" class="overlay hidden">
            <div class="content">
                <h2 class="upgrade-title">Choose Item</h2>
                <p class="upgrade-timer">Auto-select in <span id="upgradeTimer">5</span>s</p>

                <div class="item-cards">
                    <div class="item-card" data-item-id="">
                        <div class="item-header">
                            <div class="item-category">BULLET</div>
                            <div class="item-curse"></div>
                        </div>
                        <div class="item-name">Item Name</div>
                        <div class="item-desc">Description</div>
                    </div>
                    <div class="item-card" data-item-id="">
                        <div class="item-header">
                            <div class="item-category">STAT</div>
                            <div class="item-curse"></div>
                        </div>
                        <div class="item-name">Item Name</div>
                        <div class="item-desc">Description</div>
                    </div>
                    <div class="item-card" data-item-id="">
                        <div class="item-header">
                            <div class="item-category">BUDDY</div>
                            <div class="item-curse"></div>
                        </div>
                        <div class="item-name">Item Name</div>
                        <div class="item-desc">Description</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pause Screen -->
        <div id="pauseScreen" class="overlay hidden">
            <div class="content">
                <h2 class="pause-title">Paused</h2>
                <div class="pause-buttons">
                    <button class="btn" id="resumeButton">Resume</button>
                    <button class="btn btn-secondary" id="pauseRestartBtn">Restart</button>
                    <button class="btn btn-secondary" id="pauseMenuBtn">Menu</button>
                </div>
            </div>
        </div>

        <!-- Game Over Screen -->
        <div id="gameOverScreen" class="overlay hidden">
            <div class="content">
                <h2 class="game-over-title">Flight Ended</h2>

                <div class="final-stats">
                    <div class="stat-row">
                        <span class="stat-label">Survival Time</span>
                        <span class="stat-value" id="finalTime">0:00</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Coins Collected</span>
                        <span class="stat-value" id="finalCoins">0</span>
                    </div>
                    <div class="upgrade-summary">
                        <div class="summary-item">
                            <div class="summary-value" id="summaryItems">0</div>
                            <div class="summary-label">Items</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value" id="summaryCursed">0</div>
                            <div class="summary-label">Cursed</div>
                        </div>
                    </div>
                </div>

                <div class="game-over-buttons">
                    <button class="btn" id="restartButton">Fly Again</button>
                    <button class="btn btn-secondary" id="menuButton">Menu</button>
                </div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settingsModal" class="hidden">
            <h3 class="settings-title">Settings</h3>
            <div class="settings-row">
                <span class="settings-label">Music</span>
                <div class="toggle active" id="musicToggle"></div>
            </div>
            <div class="settings-row">
                <span class="settings-label">Sound FX</span>
                <div class="toggle active" id="fxToggle"></div>
            </div>
            <div class="settings-row">
                <span class="settings-label">Haptics</span>
                <div class="toggle active" id="hapticToggle"></div>
            </div>
            <button class="btn settings-close" id="settingsClose">Done</button>
        </div>
    </div>

</body>
</html>
