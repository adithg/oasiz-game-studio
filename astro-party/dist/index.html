<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Astro Party</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Exo+2:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #0a0a12;
      font-family: 'Exo 2', sans-serif;
      touch-action: none;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }

    canvas {
      display: block;
      position: absolute;
      top: 0;
      left: 0;
    }

    /* Color Scheme */
    :root {
      --cyan: #00f0ff;
      --magenta: #ff00aa;
      --yellow: #ffee00;
      --green: #00ff88;
      --orange: #ff6600;
      --bg-dark: #0a0a12;
      --bg-panel: rgba(10, 10, 18, 0.9);
    }

    /* Overlays */
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 100;
      pointer-events: none;
    }

    .overlay.hidden {
      visibility: hidden;
      opacity: 0;
    }

    .overlay > * {
      pointer-events: auto;
    }

    /* Start Screen */
    #startScreen {
      background: radial-gradient(ellipse at center, rgba(0, 100, 150, 0.3) 0%, rgba(10, 10, 18, 0.95) 70%);
    }

    .game-title {
      font-family: 'Orbitron', sans-serif;
      font-size: clamp(3rem, 12vw, 7rem);
      font-weight: 900;
      color: var(--cyan);
      text-shadow: 
        0 0 20px var(--cyan),
        0 0 40px var(--cyan),
        0 0 80px rgba(0, 240, 255, 0.5);
      letter-spacing: 0.1em;
      margin-bottom: 0.5rem;
      animation: titlePulse 2s ease-in-out infinite;
    }

    @keyframes titlePulse {
      0%, 100% { text-shadow: 0 0 20px var(--cyan), 0 0 40px var(--cyan), 0 0 80px rgba(0, 240, 255, 0.5); }
      50% { text-shadow: 0 0 30px var(--cyan), 0 0 60px var(--cyan), 0 0 120px rgba(0, 240, 255, 0.7); }
    }

    .subtitle {
      font-family: 'Orbitron', sans-serif;
      font-size: clamp(0.8rem, 3vw, 1.2rem);
      color: var(--magenta);
      letter-spacing: 0.3em;
      margin-bottom: 3rem;
      text-transform: uppercase;
    }

    .controls-info {
      color: #888;
      font-size: clamp(0.7rem, 2vw, 0.9rem);
      text-align: center;
      margin-bottom: 2rem;
      line-height: 1.8;
    }

    .controls-info span {
      color: var(--yellow);
      font-family: 'Orbitron', sans-serif;
    }

    .start-btn {
      font-family: 'Orbitron', sans-serif;
      font-size: clamp(1rem, 3vw, 1.4rem);
      font-weight: 700;
      padding: 1rem 3rem;
      background: transparent;
      border: 2px solid var(--cyan);
      color: var(--cyan);
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.2em;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .start-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(0, 240, 255, 0.3), transparent);
      transition: left 0.5s ease;
    }

    .start-btn:hover::before {
      left: 100%;
    }

    .start-btn:hover {
      background: rgba(0, 240, 255, 0.1);
      box-shadow: 0 0 30px rgba(0, 240, 255, 0.5);
    }

    /* HUD */
    #hud {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      padding: 1rem;
      display: none;
      justify-content: space-between;
      align-items: flex-start;
      z-index: 50;
      pointer-events: none;
    }

    .hud-left, .hud-center, .hud-right {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .hud-center {
      align-items: center;
    }

    .hud-right {
      align-items: flex-end;
    }

    .score-display {
      font-family: 'Orbitron', sans-serif;
      font-size: clamp(1.2rem, 4vw, 2rem);
      color: var(--cyan);
      text-shadow: 0 0 10px var(--cyan);
    }

    .wave-display {
      font-family: 'Orbitron', sans-serif;
      font-size: clamp(0.9rem, 3vw, 1.2rem);
      color: var(--yellow);
      text-shadow: 0 0 10px var(--yellow);
    }

    .lives-display {
      display: flex;
      gap: 0.4rem;
    }

    .life-icon {
      width: 24px;
      height: 24px;
      background: var(--green);
      clip-path: polygon(50% 0%, 100% 100%, 50% 75%, 0% 100%);
      box-shadow: 0 0 10px var(--green);
      transition: all 0.3s ease;
    }

    .life-icon.lost {
      background: #333;
      box-shadow: none;
    }

    .ammo-display {
      display: flex;
      gap: 0.3rem;
    }

    .ammo-bullet {
      width: 8px;
      height: 20px;
      background: var(--magenta);
      border-radius: 4px 4px 2px 2px;
      box-shadow: 0 0 8px var(--magenta);
      transition: all 0.2s ease;
    }

    .ammo-bullet.empty {
      background: #333;
      box-shadow: none;
    }

    /* Wave Announcement */
    #waveAnnouncement {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-family: 'Orbitron', sans-serif;
      font-size: clamp(2rem, 8vw, 4rem);
      font-weight: 900;
      color: var(--yellow);
      text-shadow: 0 0 30px var(--yellow);
      z-index: 60;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    #waveAnnouncement.show {
      opacity: 1;
      animation: waveIn 0.5s ease-out;
    }

    @keyframes waveIn {
      0% { transform: translate(-50%, -50%) scale(2); opacity: 0; }
      100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }

    /* Game Over Screen */
    #gameOverScreen {
      background: radial-gradient(ellipse at center, rgba(150, 0, 50, 0.3) 0%, rgba(10, 10, 18, 0.95) 70%);
    }

    .game-over-title {
      font-family: 'Orbitron', sans-serif;
      font-size: clamp(2rem, 8vw, 4rem);
      font-weight: 900;
      color: var(--magenta);
      text-shadow: 0 0 30px var(--magenta);
      margin-bottom: 2rem;
    }

    .stats-container {
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
      margin-bottom: 2rem;
      padding: 1.5rem 2rem;
      background: var(--bg-panel);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
      gap: 2rem;
      font-size: clamp(0.9rem, 2.5vw, 1.1rem);
    }

    .stat-label {
      color: #888;
    }

    .stat-value {
      font-family: 'Orbitron', sans-serif;
      color: var(--cyan);
    }

    .final-score {
      font-family: 'Orbitron', sans-serif;
      font-size: clamp(2rem, 6vw, 3rem);
      color: var(--yellow);
      text-shadow: 0 0 20px var(--yellow);
      margin-bottom: 0.5rem;
    }

    .high-score-badge {
      font-family: 'Orbitron', sans-serif;
      font-size: 0.9rem;
      color: var(--green);
      text-transform: uppercase;
      letter-spacing: 0.2em;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .high-score-badge.show {
      opacity: 1;
      animation: badgePulse 1s ease-in-out infinite;
    }

    @keyframes badgePulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    /* Mobile Controls */
    .mobile-controls {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 35%;
      display: none;
      z-index: 40;
      pointer-events: none;
    }

    .mobile-controls.show {
      display: flex;
    }

    .mobile-zone {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: auto;
    }

    .fire-zone {
      border-right: 1px solid rgba(255, 0, 170, 0.2);
    }

    .turn-zone {
      border-left: 1px solid rgba(0, 240, 255, 0.2);
    }

    .zone-icon {
      font-family: 'Orbitron', sans-serif;
      font-size: 1.5rem;
      color: rgba(255, 255, 255, 0.2);
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .fire-zone .zone-icon {
      color: rgba(255, 0, 170, 0.3);
    }

    .turn-zone .zone-icon {
      color: rgba(0, 240, 255, 0.3);
    }

    .mobile-zone.active {
      background: rgba(255, 255, 255, 0.05);
    }
  </style>
  <script type="module" crossorigin>(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))i(a);new MutationObserver(a=>{for(const l of a)if(l.type==="childList")for(const c of l.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&i(c)}).observe(document,{childList:!0,subtree:!0});function o(a){const l={};return a.integrity&&(l.integrity=a.integrity),a.referrerPolicy&&(l.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?l.credentials="include":a.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function i(a){if(a.ep)return;a.ep=!0;const l=o(a);fetch(a.href,l)}})();const me=200,ge=Math.PI,X=400,he=2,ne=3,ye=.15,ve=5,Y=30,oe=2;let S="menu",f,n,s=null,p=3,w=[],m=[],P=[],b=[],L=[],W=[],y=0,B=0,E=1,q=0,N=0,z=0,H=0;const Me=2.5;let g={intensity:0,duration:0};const x={};let C=!1;const V=typeof window<"u"&&window.matchMedia("(pointer: coarse)").matches;let D=!1,k=!1;function A(e,t,o){return e+(t-e)*o}function xe(e,t,o,i){return Math.sqrt((o-e)**2+(i-t)**2)}function d(e,t){return e+Math.random()*(t-e)}function R(e,t){let o=t-e;for(;o>Math.PI;)o-=Math.PI*2;for(;o<-Math.PI;)o+=Math.PI*2;return o}function ie(e){for(;e>Math.PI;)e-=Math.PI*2;for(;e<-Math.PI;)e+=Math.PI*2;return e}function ae(e,t){g.intensity=Math.max(g.intensity,e),g.duration=Math.max(g.duration,t)}function O(e){e.x<-e.radius&&(e.x=f.width+e.radius),e.x>f.width+e.radius&&(e.x=-e.radius),e.y<-e.radius&&(e.y=f.height+e.radius),e.y>f.height+e.radius&&(e.y=-e.radius)}function v(e,t,o,i){const a=f.width,l=f.height;let c=Math.abs(o-e),r=Math.abs(i-t);return c>a/2&&(c=a-c),r>l/2&&(r=l-r),Math.sqrt(c*c+r*r)}function U(e,t,o){const i=f.width,a=f.height;let l=t-e.x,c=o-e.y,r=l*l+c*c;for(const h of[-i,0,i])for(const u of[-a,0,a]){if(h===0&&u===0)continue;const M=t+h-e.x,T=o+u-e.y,F=M*M+T*T;F<r&&(r=F,l=M,c=T)}return Math.atan2(c,l)}function le(){console.log("[initStars] Creating star field"),W=[];const e=Math.floor(f.width*f.height/3e3);for(let t=0;t<e;t++)W.push({x:Math.random()*f.width,y:Math.random()*f.height,size:d(.5,2),brightness:d(.3,1),twinkleSpeed:d(1,4),twinkleOffset:Math.random()*Math.PI*2})}function be(){const e=performance.now()/1e3;for(const t of W){const o=.5+.5*Math.sin(e*t.twinkleSpeed+t.twinkleOffset),i=t.brightness*o;n.fillStyle=`rgba(255, 255, 255, ${i})`,n.beginPath(),n.arc(t.x,t.y,t.size,0,Math.PI*2),n.fill()}}function re(e,t,o,i,a,l,c=1){return console.log("[createShip] Creating ship at",e,t,"isPlayer:",i),{x:e,y:t,vx:0,vy:0,angle:o,radius:15,color:a,trailColor:l,isPlayer:i,alive:!0,turnRate:ge,speed:me,isTurning:!1,bullets:[],maxBullets:ne,fireTimer:0,fireCooldown:ye,invulnerableTime:i?oe:0,aiThinkTimer:0,aiWantsTurn:!1,aiWantsFire:!1,aiDifficulty:c}}function G(e,t){if(e.alive&&(e.isTurning&&(e.angle+=e.turnRate*t,e.angle=ie(e.angle)),e.vx=Math.cos(e.angle)*e.speed,e.vy=Math.sin(e.angle)*e.speed,e.x+=e.vx*t,e.y+=e.vy*t,O(e),e.fireTimer>0&&(e.fireTimer-=t),e.invulnerableTime>0&&(e.invulnerableTime-=t),Math.random()<.5)){const o=e.x-Math.cos(e.angle)*15,i=e.y-Math.sin(e.angle)*15;I(o,i,e.trailColor,"trail")}}function we(e,t=-1){return m.filter(i=>i.ownerId===-1).length}function K(e,t){if(m.filter(l=>l.ownerId===t).length>=e.maxBullets||e.fireTimer>0)return;e.fireTimer=e.fireCooldown;const i=e.x+Math.cos(e.angle)*20,a=e.y+Math.sin(e.angle)*20;m.push({x:i,y:a,vx:Math.cos(e.angle)*X+e.vx*.3,vy:Math.sin(e.angle)*X+e.vy*.3,angle:e.angle,radius:4,lifetime:he,ownerId:t,color:e.color});for(let l=0;l<3;l++)I(i,a,e.color,"muzzle")}function Z(e){if(!e.alive)return;console.log("[destroyShip] Ship destroyed at",e.x,e.y),e.alive=!1;for(let o=0;o<20;o++)I(e.x,e.y,e.color,"explosion");for(let o=0;o<10;o++)I(e.x,e.y,"#ffffff","explosion");const t=Math.random()*Math.PI*2;b.push({x:e.x,y:e.y,vx:Math.cos(t)*Y,vy:Math.sin(t)*Y,angle:0,radius:8,lifetime:ve,fromPlayer:e.isPlayer}),ae(12,.4)}function $(e){if(!e.alive)return;n.save(),n.translate(e.x,e.y),n.rotate(e.angle+Math.PI/2),e.invulnerableTime>0&&Math.floor(e.invulnerableTime*10)%2===0&&(n.globalAlpha=.5);const t=e.radius;n.fillStyle=e.trailColor,n.globalAlpha=(n.globalAlpha||1)*.6,n.beginPath(),n.moveTo(-t*.4,t*.8),n.lineTo(t*.4,t*.8),n.lineTo(0,t*1.5+Math.random()*t*.3),n.closePath(),n.fill(),n.globalAlpha=e.invulnerableTime>0?.5:1,n.fillStyle=e.color,n.strokeStyle="#ffffff",n.lineWidth=2,n.beginPath(),n.moveTo(0,-t),n.lineTo(-t*.8,t*.7),n.lineTo(0,t*.3),n.lineTo(t*.8,t*.7),n.closePath(),n.fill(),n.stroke(),n.fillStyle="#00ffff",n.beginPath(),n.arc(0,-t*.2,t*.25,0,Math.PI*2),n.fill(),n.restore()}function Pe(e,t){if(!e.alive||e.isPlayer||(e.aiThinkTimer-=t,e.aiThinkTimer>0))return;if(e.aiThinkTimer=A(.2,.05,(e.aiDifficulty-1)/5),!s||!s.alive){e.aiWantsTurn=Math.random()<.3,e.aiWantsFire=!1;return}const o=U(e,s.x,s.y),i=ie(e.angle),a=R(i,o),l=A(.3,.15,(e.aiDifficulty-1)/5);if(Math.abs(a)>l){const r=A(.6,.9,(e.aiDifficulty-1)/5);e.aiWantsTurn=Math.random()<r}else e.aiWantsTurn=Math.random()<.1;let c=!1;for(const r of m)if(r.ownerId===-1&&v(e.x,e.y,r.x,r.y)<100){const u=Math.atan2(r.vy,r.vx),M=U({...r},e.x,e.y);if(Math.abs(R(u,M))<.4){e.aiWantsTurn=!0,c=!0;break}}if(!c&&Math.abs(a)<l){const r=A(.3,.7,(e.aiDifficulty-1)/5);e.aiWantsFire=Math.random()<r}else e.aiWantsFire=!1;for(const r of P)if(v(e.x,e.y,r.x,r.y)<r.size+80){const u=U(e,r.x,r.y),M=R(e.angle,u);Math.abs(M)<Math.PI/3&&(e.aiWantsTurn=!0)}}function Ie(e){for(let t=m.length-1;t>=0;t--){const o=m[t];if(o.x+=o.vx*e,o.y+=o.vy*e,o.lifetime-=e,O(o),o.lifetime<=0){m.splice(t,1);continue}if(o.ownerId===-1)for(const i of w){if(!i.alive)continue;if(v(o.x,o.y,i.x,i.y)<o.radius+i.radius){Z(i),m.splice(t,1),y+=100,q++,z--,_();break}}else s&&s.alive&&s.invulnerableTime<=0&&v(o.x,o.y,s.x,s.y)<o.radius+s.radius&&(ce(),m.splice(t,1));for(const i of P)if(v(o.x,o.y,i.x,i.y)<o.radius+i.size){for(let l=0;l<5;l++)I(o.x,o.y,o.color,"hit");m.splice(t,1);break}}}function Te(){for(const e of m){n.save(),n.translate(e.x,e.y),n.rotate(e.angle);const t=n.createRadialGradient(0,0,0,0,0,e.radius*3);t.addColorStop(0,e.color),t.addColorStop(1,"transparent"),n.fillStyle=t,n.globalAlpha=.5,n.beginPath(),n.arc(0,0,e.radius*3,0,Math.PI*2),n.fill(),n.globalAlpha=1,n.fillStyle="#ffffff",n.beginPath(),n.arc(0,0,e.radius*.6,0,Math.PI*2),n.fill(),n.fillStyle=e.color,n.beginPath(),n.arc(0,0,e.radius,0,Math.PI*2),n.fill(),n.restore()}}function Se(e,t,o,i,a){const l=Math.floor(d(7,12)),c=[];for(let r=0;r<l;r++){const h=r/l*Math.PI*2,u=o*d(.7,1);c.push({x:Math.cos(h)*u,y:Math.sin(h)*u})}return{x:e,y:t,vx:i??d(-20,20),vy:a??d(-20,20),angle:Math.random()*Math.PI*2,radius:o,size:o,rotationSpeed:d(-1,1),rotation:0,vertices:c}}function Le(){console.log("[initAsteroids] Creating asteroids"),P=[];const e=Math.floor(d(5,8));for(let t=0;t<e;t++){let o,i;do o=Math.random()*f.width,i=Math.random()*f.height;while(xe(o,i,f.width/2,f.height/2)<150);const a=d(30,60);P.push(Se(o,i,a))}}function Ee(e){for(const t of P)t.x+=t.vx*e,t.y+=t.vy*e,t.rotation+=t.rotationSpeed*e,O(t)}function pe(){if(s&&s.alive&&s.invulnerableTime<=0){for(const e of P)if(v(s.x,s.y,e.x,e.y)<s.radius+e.size*.8){ce();break}}for(const e of w)if(e.alive){for(const t of P)if(v(e.x,e.y,t.x,t.y)<e.radius+t.size*.8){Z(e),z--;break}}}function Ce(){for(const e of P){n.save(),n.translate(e.x,e.y),n.rotate(e.rotation),n.fillStyle="#1a1a2e",n.beginPath(),n.moveTo(e.vertices[0].x+3,e.vertices[0].y+3);for(let o=1;o<e.vertices.length;o++)n.lineTo(e.vertices[o].x+3,e.vertices[o].y+3);n.closePath(),n.fill();const t=n.createRadialGradient(-e.size*.3,-e.size*.3,0,0,0,e.size);t.addColorStop(0,"#6b6b7b"),t.addColorStop(1,"#3a3a4a"),n.fillStyle=t,n.strokeStyle="#8a8a9a",n.lineWidth=2,n.beginPath(),n.moveTo(e.vertices[0].x,e.vertices[0].y);for(let o=1;o<e.vertices.length;o++)n.lineTo(e.vertices[o].x,e.vertices[o].y);n.closePath(),n.fill(),n.stroke(),n.fillStyle="rgba(0, 0, 0, 0.3)",n.beginPath(),n.arc(e.size*.2,e.size*.1,e.size*.15,0,Math.PI*2),n.fill(),n.beginPath(),n.arc(-e.size*.25,e.size*.2,e.size*.1,0,Math.PI*2),n.fill(),n.restore()}}function ke(e){for(let t=b.length-1;t>=0;t--){const o=b[t];if(o.x+=o.vx*e,o.y+=o.vy*e,o.lifetime-=e,o.vx*=.99,o.vy*=.99,O(o),o.lifetime<=0){b.splice(t,1);continue}if(!o.fromPlayer&&s&&s.alive&&v(s.x,s.y,o.x,o.y)<s.radius+o.radius){Ae(o,t);continue}}}function Ae(e,t){console.log("[collectPilot] Pilot collected!"),b.splice(t,1),y+=250,N++,_();for(let o=0;o<15;o++)I(e.x,e.y,"#00ff88","sparkle")}function Be(){for(const e of b){const t=e.lifetime<1.5&&Math.floor(e.lifetime*5)%2===0;n.save(),n.translate(e.x,e.y),t&&(n.globalAlpha=.5),n.fillStyle=e.fromPlayer?"#00f0ff":"#ff00aa",n.beginPath(),n.arc(0,-12,12,Math.PI,Math.PI*2),n.fill(),n.strokeStyle="#888",n.lineWidth=1,n.beginPath(),n.moveTo(-10,-8),n.lineTo(0,5),n.moveTo(10,-8),n.lineTo(0,5),n.moveTo(0,-12),n.lineTo(0,5),n.stroke(),n.fillStyle="#ffcc88",n.beginPath(),n.arc(0,8,5,0,Math.PI*2),n.fill(),n.fillStyle="#ffffff",n.beginPath(),n.arc(0,6,4,0,Math.PI*2),n.fill(),n.restore()}}function I(e,t,o,i){const a=Math.random()*Math.PI*2;let l,c,r;switch(i){case"explosion":l=d(80,200),c=d(.3,.6),r=d(3,8);break;case"trail":l=d(10,30),c=d(.2,.4),r=d(2,4);break;case"muzzle":l=d(50,100),c=d(.1,.2),r=d(2,5);break;case"hit":l=d(40,80),c=d(.2,.4),r=d(2,4);break;case"sparkle":l=d(60,120),c=d(.3,.5),r=d(3,6);break;default:l=50,c=.3,r=3}L.push({x:e,y:t,vx:Math.cos(a)*l,vy:Math.sin(a)*l,life:c,maxLife:c,size:r,color:o})}function j(e){for(let t=L.length-1;t>=0;t--){const o=L[t];o.x+=o.vx*e,o.y+=o.vy*e,o.vx*=.95,o.vy*=.95,o.life-=e,o.life<=0&&L.splice(t,1)}}function De(){for(const e of L){const t=e.life/e.maxLife;n.globalAlpha=t,n.fillStyle=e.color,n.beginPath(),n.arc(e.x,e.y,e.size*t,0,Math.PI*2),n.fill()}n.globalAlpha=1}function se(e){console.log("[startWave] Starting wave",e),E=e;let t;e===1?t=1:e===2?t=2:t=Math.min(2+Math.floor((e-2)*.5),5),z=t;const o=Math.min(1+(e-1)*.3,6);w=[];const i=["#ff00aa","#ff6600","#aa00ff","#ff0066","#ffaa00"];for(let a=0;a<t;a++){let l,c,r=0;do{switch(Math.floor(Math.random()*4)){case 0:l=Math.random()*f.width,c=50;break;case 1:l=f.width-50,c=Math.random()*f.height;break;case 2:l=Math.random()*f.width,c=f.height-50;break;default:l=50,c=Math.random()*f.height}r++}while(s&&v(l,c,s.x,s.y)<200&&r<20);const h=Math.random()*Math.PI*2,u=i[a%i.length],T=re(l,c,h,!1,u,u,o);w.push(T)}We(e),_()}function We(e){const t=document.getElementById("waveAnnouncement");t.textContent="WAVE "+e,t.classList.add("show"),setTimeout(()=>{t.classList.remove("show")},1500)}function ze(){z<=0&&b.length===0&&(H=Me,S="wave_transition",console.log("[checkWaveComplete] Wave",E,"complete!"))}function ce(){if(!(!s||s.invulnerableTime>0)){console.log("[damagePlayer] Player hit! Lives:",p-1),p--,s.invulnerableTime=oe,ae(15,.5);for(let e=0;e<15;e++)I(s.x,s.y,"#00f0ff","explosion");p<=0&&(Z(s),_e()),fe()}}function _(){document.getElementById("scoreValue").textContent=y.toLocaleString(),document.getElementById("waveValue").textContent=E.toString(),de()}function fe(){const e=document.getElementById("livesDisplay");e.innerHTML="";for(let t=0;t<3;t++){const o=document.createElement("div");o.className="life-icon"+(t>=p?" lost":""),e.appendChild(o)}}function de(){const e=document.getElementById("ammoDisplay"),t=we();e.querySelectorAll(".ammo-bullet").forEach((i,a)=>{a<ne-t?i.classList.remove("empty"):i.classList.add("empty")})}function Oe(){console.log("[resetGame] Resetting game"),y=0,p=3,E=1,q=0,N=0,m=[],w=[],b=[],L=[],s=re(f.width/2,f.height/2,-Math.PI/2,!0,"#00f0ff","#00aaff"),Le()}function J(){console.log("[startGame] Starting game"),Oe(),S="playing",document.getElementById("startScreen").classList.add("hidden"),document.getElementById("gameOverScreen").classList.add("hidden"),document.getElementById("hud").style.display="flex",V&&document.getElementById("mobileControls").classList.add("show"),fe(),_(),se(1)}function _e(){console.log("[gameOver] Game over! Score:",y),S="gameover",typeof window.submitScore=="function"&&window.submitScore(y);const e=y>B;e&&(B=y,localStorage.setItem("astroparty_highscore",B.toString())),document.getElementById("finalScore").textContent=y.toLocaleString(),document.getElementById("wavesSurvived").textContent=E.toString(),document.getElementById("enemiesDestroyed").textContent=q.toString(),document.getElementById("pilotsCollected").textContent=N.toString();const t=document.getElementById("highScoreBadge");e?t.classList.add("show"):t.classList.remove("show"),document.getElementById("hud").style.display="none",V&&document.getElementById("mobileControls").classList.remove("show"),document.getElementById("gameOverScreen").classList.remove("hidden")}function Fe(){if(n.fillStyle="#0a0a12",n.fillRect(0,0,f.width,f.height),n.save(),g.duration>0){const e=(Math.random()-.5)*g.intensity,t=(Math.random()-.5)*g.intensity;n.translate(e,t)}be(),Ce(),Be(),Te();for(const e of w)$(e);s&&$(s),De(),n.restore()}let Q=0;function ue(e){const t=Math.min((e-Q)/1e3,.1);if(Q=e,g.duration>0&&(g.duration-=t,g.duration<=0&&(g.intensity=0)),S==="playing"&&s){s.isTurning=x.arrowright||x.d||C||k,(x[" "]||x.space||D)&&K(s,-1),G(s,t);for(let i=0;i<w.length;i++){const a=w[i];Pe(a,t),a.isTurning=a.aiWantsTurn,a.aiWantsFire&&K(a,i),G(a,t)}Ie(t),Ee(t),ke(t),j(t),pe(),ze(),de()}else S==="wave_transition"&&s&&(H-=t,j(t),G(s,t),s.isTurning=x.arrowright||x.d||C||k,H<=0&&(S="playing",se(E+1)));Fe(),requestAnimationFrame(ue)}function Re(){console.log("[setupInput] Setting up input handlers"),window.addEventListener("keydown",e=>{x[e.key.toLowerCase()]=!0,e.key===" "&&e.preventDefault()}),window.addEventListener("keyup",e=>{x[e.key.toLowerCase()]=!1}),f.addEventListener("mousedown",e=>{e.button===0&&(C=!0)}),f.addEventListener("mouseup",()=>{C=!1}),f.addEventListener("mouseleave",()=>{C=!1}),document.getElementById("startButton").onclick=J,document.getElementById("restartButton").onclick=J,V&&Ue()}function Ue(){console.log("[setupMobileControls] Setting up mobile controls");const e=document.getElementById("fireZone"),t=document.getElementById("turnZone");e.addEventListener("touchstart",o=>{o.preventDefault(),D=!0,e.classList.add("active")}),e.addEventListener("touchend",()=>{D=!1,e.classList.remove("active")}),e.addEventListener("touchcancel",()=>{D=!1,e.classList.remove("active")}),t.addEventListener("touchstart",o=>{o.preventDefault(),k=!0,t.classList.add("active")}),t.addEventListener("touchend",()=>{k=!1,t.classList.remove("active")}),t.addEventListener("touchcancel",()=>{k=!1,t.classList.remove("active")})}function ee(){f.width=window.innerWidth,f.height=window.innerHeight,console.log("[resizeCanvas] Canvas:",f.width,"x",f.height),W.length>0&&le()}function te(){console.log("[init] Initializing Astro Party"),f=document.getElementById("gameCanvas"),n=f.getContext("2d"),ee(),window.addEventListener("resize",ee);const e=localStorage.getItem("astroparty_highscore");e&&(B=parseInt(e,10)),le(),Re(),requestAnimationFrame(ue)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",te):te();</script>
</head>
<body>
  <canvas id="gameCanvas"></canvas>

  <!-- Start Screen -->
  <div id="startScreen" class="overlay">
    <h1 class="game-title">ASTRO PARTY</h1>
    <p class="subtitle">Survival Mode</p>
    <div class="controls-info">
      <span>RIGHT ARROW</span> or <span>D</span> - Turn Right<br>
      <span>SPACE</span> or <span>CLICK</span> - Fire
    </div>
    <button id="startButton" class="start-btn">Start Game</button>
  </div>

  <!-- HUD -->
  <div id="hud">
    <div class="hud-left">
      <div class="score-display">SCORE: <span id="scoreValue">0</span></div>
      <div class="ammo-display" id="ammoDisplay">
        <div class="ammo-bullet"></div>
        <div class="ammo-bullet"></div>
        <div class="ammo-bullet"></div>
      </div>
    </div>
    <div class="hud-center">
      <div class="wave-display">WAVE <span id="waveValue">1</span></div>
    </div>
    <div class="hud-right">
      <div class="lives-display" id="livesDisplay">
        <div class="life-icon"></div>
        <div class="life-icon"></div>
        <div class="life-icon"></div>
      </div>
    </div>
  </div>

  <!-- Wave Announcement -->
  <div id="waveAnnouncement">WAVE 1</div>

  <!-- Game Over Screen -->
  <div id="gameOverScreen" class="overlay hidden">
    <h2 class="game-over-title">GAME OVER</h2>
    <div class="final-score"><span id="finalScore">0</span></div>
    <div class="high-score-badge" id="highScoreBadge">NEW HIGH SCORE!</div>
    <div class="stats-container">
      <div class="stat-row">
        <span class="stat-label">Waves Survived</span>
        <span class="stat-value" id="wavesSurvived">0</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Enemies Destroyed</span>
        <span class="stat-value" id="enemiesDestroyed">0</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Pilots Collected</span>
        <span class="stat-value" id="pilotsCollected">0</span>
      </div>
    </div>
    <button id="restartButton" class="start-btn">Play Again</button>
  </div>

  <!-- Mobile Controls -->
  <div class="mobile-controls" id="mobileControls">
    <div class="mobile-zone fire-zone" id="fireZone">
      <span class="zone-icon">FIRE</span>
    </div>
    <div class="mobile-zone turn-zone" id="turnZone">
      <span class="zone-icon">TURN</span>
    </div>
  </div>

</body>
</html>
