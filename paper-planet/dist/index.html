<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no, minimal-ui">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Paper Planet</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bangers&family=Comic+Neue:wght@400;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            overflow: hidden;
            width: 100%;
            height: 100%;
            background: #e6dfcc; /* Slightly darker background for the "desk" */
            color: #2d2d2d;
            font-family: 'Comic Neue', cursive, sans-serif;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            background: #fdf6e3;
            overflow: hidden;
            box-shadow: none;
        }

        @media (min-width: 1024px) {
            #game-container {
                width: min(90vw, 1200px);
                height: min(90vh, 800px);
                aspect-ratio: 16 / 9;
                border: 6px solid #2d2d2d;
                border-radius: 12px;
                box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            }
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }

        /* HUD Overlay */

        #hud {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 45px 20px 15px 20px; /* Offset for desktop safe area */
            pointer-events: none;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            z-index: 5;
        }

        .hud-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .hud-box {
            background: rgba(255, 255, 255, 0.9);
            border: 4px solid #2d2d2d;
            border-radius: 12px;
            padding: 10px 18px;
            box-shadow: 4px 4px 0 #2d2d2d;
        }

        .hud-label {
            font-family: 'Bangers', cursive;
            font-size: 0.8rem;
            color: #666;
            letter-spacing: 2px;
        }

        .hud-value {
            font-family: 'Bangers', cursive;
            font-size: 2rem;
            color: #2d2d2d;
            line-height: 1;
        }

        .hp-bar-container {
            width: 150px;
            height: 20px;
            background: #ddd;
            border: 3px solid #2d2d2d;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 2px 2px 0 #2d2d2d;
        }

        .hp-bar {
            height: 100%;
            background: linear-gradient(180deg, #ff6b6b 0%, #ee5a5a 100%);
            transition: width 0.3s ease;
        }

        .round-display {
            text-align: center;
        }

        /* Overlays */

        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(253, 246, 227, 0.95);
            z-index: 10;
            transition: opacity 0.4s ease, visibility 0.4s ease;
        }

        .overlay.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .content {
            text-align: center;
            padding: 40px;
            max-width: 600px;
        }

        /* Flash-style title */

        h1 {
            font-family: 'Bangers', cursive;
            font-size: 4rem;
            color: #2d2d2d;
            text-shadow: 4px 4px 0 #ff6b6b, 8px 8px 0 #ffa94d;
            letter-spacing: 4px;
            margin-bottom: 20px;
            transform: rotate(-2deg);
        }

        .subtitle {
            font-family: 'Comic Neue', cursive;
            font-size: 1.3rem;
            color: #666;
            margin-bottom: 40px;
            font-weight: 700;
        }

        /* Flash-style buttons */

        .btn {
            background: linear-gradient(180deg, #ff6b6b 0%, #ee5a5a 100%);
            color: #fff;
            border: 4px solid #2d2d2d;
            padding: 15px 50px;
            font-family: 'Bangers', cursive;
            font-size: 1.5rem;
            cursor: pointer;
            border-radius: 12px;
            box-shadow: 4px 4px 0 #2d2d2d;
            transition: all 0.1s ease;
            letter-spacing: 2px;
            text-shadow: 2px 2px 0 rgba(0,0,0,0.3);
        }

        .btn:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 #2d2d2d;
        }

        .btn:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0 #2d2d2d;
        }

        .btn-secondary {
            background: linear-gradient(180deg, #ffa94d 0%, #ff922b 100%);
        }

        /* How to play */

        .how-to-play {
            margin-top: 40px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.8);
            border: 3px solid #2d2d2d;
            border-radius: 12px;
            box-shadow: 3px 3px 0 #2d2d2d;
        }

        .how-to-play h3 {
            font-family: 'Bangers', cursive;
            font-size: 1.2rem;
            color: #2d2d2d;
            margin-bottom: 15px;
        }

        .instructions {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
        }

        .instruction {
            font-size: 0.95rem;
            color: #555;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .key {
            background: #2d2d2d;
            color: #fff;
            padding: 4px 10px;
            border-radius: 6px;
            font-family: 'Bangers', cursive;
            font-size: 0.9rem;
        }

        /* Reward screen */

        .reward-cards {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 30px 0;
        }

        .reward-card {
            width: 180px;
            padding: 20px;
            background: #fff;
            border: 4px solid #2d2d2d;
            border-radius: 16px;
            box-shadow: 4px 4px 0 #2d2d2d;
            cursor: pointer;
            transition: all 0.15s ease;
            pointer-events: auto;
        }

        .reward-card:hover {
            transform: translateY(-8px) rotate(-2deg);
            box-shadow: 6px 10px 0 #2d2d2d;
        }

        .reward-card.common { border-color: #888; }

        .reward-card.rare { border-color: #339af0; box-shadow: 4px 4px 0 #339af0; }

        .reward-card.epic { border-color: #cc5de8; box-shadow: 4px 4px 0 #cc5de8; }

        .reward-card.legendary { border-color: #ffd43b; box-shadow: 4px 4px 0 #ffd43b; }

        .reward-card.cursed { border-color: #ff6b6b; box-shadow: 4px 4px 0 #ff6b6b; background: #fff0f0; }

        .reward-card-name {
            font-family: 'Bangers', cursive;
            font-size: 1.2rem;
            color: #2d2d2d;
            margin-bottom: 8px;
        }

        .reward-card-desc {
            font-size: 0.85rem;
            color: #666;
            line-height: 1.4;
        }

        .reward-card-rarity {
            font-family: 'Bangers', cursive;
            font-size: 0.75rem;
            margin-top: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .reward-card.common .reward-card-rarity { color: #888; }

        .reward-card.rare .reward-card-rarity { color: #339af0; }

        .reward-card.epic .reward-card-rarity { color: #cc5de8; }

        .reward-card.legendary .reward-card-rarity { color: #ffd43b; }

        .reward-card.cursed .reward-card-rarity { color: #ff6b6b; }

        /* Pause Screen */

        .pause-title {
            font-family: 'Bangers', cursive;
            font-size: 3.5rem;
            color: #2d2d2d;
            text-shadow: 3px 3px 0 #ffd93d;
            margin-bottom: 10px;
        }

        .pause-info {
            font-family: 'Comic Neue', cursive;
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 25px;
        }

        .btn-secondary {
            background: #fff;
            color: #2d2d2d;
            border: 3px solid #2d2d2d;
            margin-top: 10px;
        }

        .btn-secondary:hover {
            background: #f0f0f0;
            transform: scale(1.05);
        }

        /* Game Over */

        .game-over-title {
            font-family: 'Bangers', cursive;
            font-size: 3.5rem;
            color: #2d2d2d;
            text-shadow: 3px 3px 0 #ff6b6b;
            margin-bottom: 10px;
        }

        .final-score {
            font-family: 'Bangers', cursive;
            font-size: 4rem;
            color: #ff6b6b;
            text-shadow: 3px 3px 0 #2d2d2d;
            margin: 20px 0;
        }

        .stats-row {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 20px 0;
        }

        .stat-item {
            background: #fff;
            border: 3px solid #2d2d2d;
            border-radius: 12px;
            padding: 15px 25px;
            box-shadow: 3px 3px 0 #2d2d2d;
        }

        .stat-value {
            font-family: 'Bangers', cursive;
            font-size: 2rem;
            color: #2d2d2d;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Items display */

        .items-display {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: flex-end;
            max-width: 200px;
        }

        .item-icon {
            width: 32px;
            height: 32px;
            background: #fff;
            border: 2px solid #2d2d2d;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            box-shadow: 2px 2px 0 #2d2d2d;
        }

        /* Mobile joystick */

        .joystick-zone {
            position: absolute;
            bottom: 20px;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: rgba(45, 45, 45, 0.2);
            border: 3px solid rgba(45, 45, 45, 0.3);
            pointer-events: auto;
            touch-action: none;
        }

        .joystick-zone.left { left: 30px; }

        .joystick-zone.right { right: 30px; }

        .joystick-thumb {
            position: absolute;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(45, 45, 45, 0.5);
            border: 3px solid #2d2d2d;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }

        .desktop-only { display: block; }

        .mobile-only { display: none; }

        @media (pointer: coarse) {
            .desktop-only { display: none; }
            .mobile-only { display: flex; }
            
            h1 { font-size: 2.8rem; }
            .content { padding: 20px; }
            .btn { padding: 12px 35px; font-size: 1.2rem; }
            .instructions { flex-direction: column; gap: 10px; }
            
            #hud { padding: 120px 15px 10px 15px; } /* Offset for mobile safe area */
            .hud-box { padding: 8px 12px; }
            .hud-value { font-size: 1.5rem; }
            .hp-bar-container { width: 100px; }
        }
    </style>
  <script type="module" crossorigin>(function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function a(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(s){if(s.ep)return;s.ep=!0;const o=a(s);fetch(s.href,o)}})();const ze=[{id:"pencil_shot",name:"Pencil Shot",description:"Basic fast projectile with reliable damage",tier:1,baseDamage:10,fireRateMultiplier:1,speed:600,lifetime:2,collisionRadius:8,pierce:0,bounce:0,chain:0,aoeRadius:0,damageType:"kinetic",statusEffects:[],visual:{shape:"line",color:"#2d2d2d",length:20,width:3}},{id:"ink_blob",name:"Ink Blob",description:"Slow heavy projectile that leaves damaging puddles",tier:1,baseDamage:25,fireRateMultiplier:.6,speed:300,lifetime:3,collisionRadius:12,pierce:0,bounce:0,chain:0,aoeRadius:30,damageType:"poison",statusEffects:[{type:"poison",stacks:1,chance:.5}],visual:{shape:"circle",color:"#1a1a2e",radius:10}},{id:"bee_pellet",name:"Bee Pellet",description:"Low damage but spawns seeking micro-bees",tier:1,baseDamage:5,fireRateMultiplier:.8,speed:400,lifetime:2,collisionRadius:6,pierce:0,bounce:0,chain:0,aoeRadius:0,damageType:"kinetic",statusEffects:[],onHit:{spawnProjectile:"bee_micro",count:2,chance:1},visual:{shape:"hexagon",color:"#ffc107",radius:6}},{id:"bee_micro",name:"Micro Bee",description:"Tiny seeking projectile spawned by bee items",tier:0,baseDamage:3,fireRateMultiplier:1,speed:250,lifetime:1.5,collisionRadius:4,pierce:0,bounce:0,chain:0,aoeRadius:0,damageType:"kinetic",statusEffects:[],homing:{enabled:!0,turnRate:3,seekRadius:150},visual:{shape:"triangle",color:"#ffc107",radius:4}},{id:"spark_bolt",name:"Spark Bolt",description:"Electric projectile that can chain between enemies",tier:1,baseDamage:12,fireRateMultiplier:.9,speed:550,lifetime:2,collisionRadius:8,pierce:0,bounce:0,chain:2,chainRange:100,chainDamageMultiplier:.7,aoeRadius:0,damageType:"electric",statusEffects:[{type:"shock",stacks:1,chance:.3}],visual:{shape:"lightning",color:"#00d4ff",length:15}},{id:"rocket_bomb",name:"Rocket Bomb",description:"Slow explosive projectile with huge area damage",tier:1,baseDamage:40,fireRateMultiplier:.4,speed:200,lifetime:4,collisionRadius:15,pierce:0,bounce:0,chain:0,aoeRadius:80,damageType:"explosive",statusEffects:[],visual:{shape:"rocket",color:"#ff4444",length:25,width:8}},{id:"paper_shard",name:"Paper Shard",description:"Shotgun spread of short-range shards",tier:1,baseDamage:6,fireRateMultiplier:.7,speed:500,lifetime:.5,collisionRadius:5,pierce:0,bounce:0,chain:0,aoeRadius:0,damageType:"kinetic",statusEffects:[],spread:{count:5,angle:30},visual:{shape:"triangle",color:"#f5f5dc",radius:5}},{id:"staple_piercer",name:"Staple Piercer",description:"Pierces through multiple enemies",tier:1,baseDamage:15,fireRateMultiplier:.8,speed:700,lifetime:2.5,collisionRadius:6,pierce:3,bounce:0,chain:0,aoeRadius:0,damageType:"kinetic",statusEffects:[],visual:{shape:"staple",color:"#c0c0c0",width:12,height:6}},{id:"eraser_pulse",name:"Eraser Pulse",description:"Pushes enemies back with knockback",tier:1,baseDamage:8,fireRateMultiplier:1.1,speed:450,lifetime:1.5,collisionRadius:10,pierce:0,bounce:0,chain:0,aoeRadius:0,damageType:"kinetic",statusEffects:[],knockback:150,visual:{shape:"rectangle",color:"#ffb6c1",width:15,height:10}}],je={bullets:ze},Le=[{id:"drifter",name:"Drifter",description:"Basic enemy that slowly homes toward the player",hp:20,speed:80,contactDamage:10,attackStyle:"melee_rush",behaviorProfile:"drifter",spawnCost:1,xpValue:5,drops:{currency:{min:1,max:3}},visual:{shape:"circle",color:"#ff6b6b",radius:15,outlineWidth:3,image:"https://assets.oasiz.ai/dev/images/paper-planet/enemy-drifter.png"}},{id:"zigzag",name:"Zigzag",description:"Approaches with lateral wave motion, harder to hit",hp:15,speed:120,contactDamage:8,attackStyle:"melee_rush",behaviorProfile:"zigzag",behaviorParams:{waveAmplitude:50,waveFrequency:3},spawnCost:2,xpValue:8,drops:{currency:{min:2,max:4}},visual:{shape:"diamond",color:"#ffa94d",size:18,outlineWidth:3,image:"https://assets.oasiz.ai/dev/images/paper-planet/enemy-zigzag.png"}},{id:"dasher",name:"Dasher",description:"Charges in bursts with cooldown between dashes",hp:25,speed:60,dashSpeed:400,contactDamage:15,attackStyle:"melee_rush",behaviorProfile:"dasher",behaviorParams:{dashDuration:.3,dashCooldown:2,telegraphTime:.5},spawnCost:3,xpValue:12,drops:{currency:{min:3,max:6}},visual:{shape:"triangle",color:"#ff4757",size:20,outlineWidth:3,image:"https://assets.oasiz.ai/dev/images/paper-planet/enemy-dasher.png"}},{id:"orbiter",name:"Orbiter",description:"Circles the player at a fixed radius while shooting inward",hp:30,speed:100,contactDamage:5,attackStyle:"ranged",behaviorProfile:"orbiter",behaviorParams:{orbitRadius:200,orbitSpeed:2},projectile:{damage:8,speed:300,fireRate:1.5},spawnCost:4,xpValue:15,drops:{currency:{min:4,max:8}},visual:{shape:"ring",color:"#5f27cd",radius:16,outlineWidth:4,image:"https://assets.oasiz.ai/dev/images/paper-planet/enemy-orbiter.png"}},{id:"sniper",name:"Sniper",description:"Keeps distance and fires accurate aimed shots",hp:20,speed:50,contactDamage:5,attackStyle:"ranged",behaviorProfile:"sniper",behaviorParams:{preferredDistance:300,aimTime:1},projectile:{damage:15,speed:500,fireRate:.8},spawnCost:4,xpValue:18,drops:{currency:{min:5,max:10}},visual:{shape:"crosshair",color:"#00d2d3",size:18,outlineWidth:2,image:"https://assets.oasiz.ai/dev/images/paper-planet/enemy-sniper.png"}},{id:"bomber",name:"Bomber",description:"Runs in, drops explosive hazard, runs out",hp:15,speed:150,contactDamage:5,attackStyle:"bomber",behaviorProfile:"bomber",behaviorParams:{dropRadius:80,retreatDistance:250,bombDamage:25,bombRadius:60,bombDelay:1.5},spawnCost:3,xpValue:10,drops:{currency:{min:3,max:5}},visual:{shape:"square",color:"#ff9f43",size:14,outlineWidth:3,image:"https://assets.oasiz.ai/dev/images/paper-planet/enemy-bomber.png"}},{id:"splitter",name:"Splitter",description:"Dies into two smaller units",hp:40,speed:70,contactDamage:12,attackStyle:"melee_rush",behaviorProfile:"drifter",onDeath:{spawn:"splitter_small",count:2},spawnCost:5,xpValue:20,drops:{currency:{min:5,max:10}},visual:{shape:"blob",color:"#10ac84",radius:22,outlineWidth:3,image:"https://assets.oasiz.ai/dev/images/paper-planet/enemy-splitter.png"}},{id:"splitter_small",name:"Splitter Small",description:"Smaller version spawned when Splitter dies",hp:15,speed:100,contactDamage:6,attackStyle:"melee_rush",behaviorProfile:"drifter",spawnCost:0,xpValue:5,drops:{currency:{min:1,max:2}},visual:{shape:"blob",color:"#1dd1a1",radius:12,outlineWidth:2,image:"https://assets.oasiz.ai/dev/images/paper-planet/enemy-splitter.png"}},{id:"shielded",name:"Shielded",description:"Takes reduced frontal damage, weak from behind",hp:50,speed:60,contactDamage:12,attackStyle:"melee_rush",behaviorProfile:"drifter",shield:{frontalReduction:.8,arcDegrees:120},spawnCost:5,xpValue:25,drops:{currency:{min:6,max:12}},visual:{shape:"shielded_circle",color:"#576574",radius:18,shieldColor:"#c8d6e5",outlineWidth:3,image:"https://assets.oasiz.ai/dev/images/paper-planet/enemy-shielded.png"}}],We={enemies:Le},He=[{id:"hive_cartridge",name:"Hive Cartridge",description:"Shots have a chance to spawn seeking bee-bullets",rarity:"rare",type:"permanent",tags:["summon","projectile"],effects:[{type:"on_shot",spawnProjectile:"bee_micro",count:2,chance:.3}],stacking:"linear",stackBonus:{chance:.1}},{id:"tesla_paperclip",name:"Tesla Paperclip",description:"Projectiles gain chain lightning effect",rarity:"rare",type:"permanent",tags:["electric","projectile"],effects:[{type:"stat_add",stat:"chain",value:2},{type:"on_hit",applyStatus:"shock",stacks:1,chance:.25}],stacking:"linear",stackBonus:{chain:1}},{id:"static_wall",name:"Static Wall",description:"Every 5 shots creates a short-lived electric wall",rarity:"epic",type:"permanent",tags:["electric","area"],effects:[{type:"on_shot_count",count:5,createEntity:"electric_wall",duration:3}],stacking:"diminishing",stackBonus:{count:-1}},{id:"blink_fuse",name:"Blink Fuse",description:"Explosive projectiles teleport to nearest enemy when they miss",rarity:"epic",type:"permanent",tags:["teleport","explosive"],effects:[{type:"conditional",ifTag:"explosive",then:{type:"on_miss",teleportToNearest:!0,range:150}}],stacking:"unique"},{id:"cursed_ink",name:"Cursed Ink",description:"+200% damage, -50% max HP, enemies spawn faster",rarity:"cursed",type:"permanent",tags:["curse","damage"],effects:[{type:"stat_mult",stat:"damage",value:3},{type:"stat_mult",stat:"maxHp",value:.5},{type:"stat_mult",stat:"enemySpawnRate",value:1.3}],stacking:"unique"},{id:"rubber_band",name:"Rubber Band",description:"Projectiles bounce off walls",rarity:"common",type:"permanent",tags:["projectile"],effects:[{type:"stat_add",stat:"bounce",value:2}],stacking:"linear",stackBonus:{bounce:1}},{id:"sharpened_pencil",name:"Sharpened Pencil",description:"+20% damage",rarity:"common",type:"permanent",tags:["damage"],effects:[{type:"stat_mult",stat:"damage",value:1.2}],stacking:"linear",stackBonus:{value:.1}},{id:"coffee_stain",name:"Coffee Stain",description:"+25% fire rate",rarity:"common",type:"permanent",tags:["fire_rate"],effects:[{type:"stat_mult",stat:"fireRate",value:1.25}],stacking:"linear",stackBonus:{value:.1}},{id:"roller_skates",name:"Roller Skates",description:"+30% movement speed",rarity:"common",type:"permanent",tags:["movement"],effects:[{type:"stat_mult",stat:"moveSpeed",value:1.3}],stacking:"linear",stackBonus:{value:.1}},{id:"lucky_eraser",name:"Lucky Eraser",description:"+15% crit chance",rarity:"rare",type:"permanent",tags:["crit"],effects:[{type:"stat_add",stat:"critChance",value:.15}],stacking:"linear",stackBonus:{critChance:.05}},{id:"magnet_clip",name:"Magnet Clip",description:"+50% pickup radius",rarity:"common",type:"permanent",tags:["utility"],effects:[{type:"stat_mult",stat:"pickupRadius",value:1.5}],stacking:"linear",stackBonus:{value:.25}},{id:"flame_doodle",name:"Flame Doodle",description:"Projectiles have a chance to inflict burn",rarity:"rare",type:"permanent",tags:["fire","status"],effects:[{type:"on_hit",applyStatus:"burn",stacks:1,chance:.25}],stacking:"linear",stackBonus:{chance:.1}},{id:"paper_armor",name:"Paper Armor",description:"+25 max HP and 10% damage reduction",rarity:"rare",type:"permanent",tags:["defense","shield"],effects:[{type:"stat_add",stat:"maxHp",value:25},{type:"stat_add",stat:"damageReduction",value:.1}],stacking:"linear",stackBonus:{maxHp:15,damageReduction:.05}},{id:"poison_pen",name:"Poison Pen",description:"Projectiles apply poison on hit",rarity:"rare",type:"permanent",tags:["poison","status"],effects:[{type:"on_hit",applyStatus:"poison",stacks:2,chance:.4}],stacking:"linear",stackBonus:{stacks:1}},{id:"splash_damage",name:"Splash Page",description:"All projectiles gain small AOE",rarity:"epic",type:"permanent",tags:["aoe","projectile"],effects:[{type:"stat_add",stat:"aoeRadius",value:30}],stacking:"linear",stackBonus:{aoeRadius:15}},{id:"berserker_ink",name:"Berserker Ink",description:"Temporary: +100% damage and fire rate for 3 rounds",rarity:"epic",type:"temporary",duration:3,tags:["damage","fire_rate"],effects:[{type:"stat_mult",stat:"damage",value:2},{type:"stat_mult",stat:"fireRate",value:2}]},{id:"invincible_shield",name:"Invincible Shield",description:"Temporary: Immune to damage for 2 rounds",rarity:"legendary",type:"temporary",duration:2,tags:["shield","defense"],effects:[{type:"stat_set",stat:"damageReduction",value:1}]},{id:"bullet_storm",name:"Bullet Storm",description:"Temporary: Fire 3 projectiles per shot for 3 rounds",rarity:"epic",type:"temporary",duration:3,tags:["projectile","multishot"],effects:[{type:"stat_add",stat:"projectilesPerShot",value:2}]},{id:"speed_boost",name:"Turbo Wheels",description:"Temporary: +100% movement speed for 2 rounds",rarity:"rare",type:"temporary",duration:2,tags:["movement"],effects:[{type:"stat_mult",stat:"moveSpeed",value:2}]},{id:"vampire_quill",name:"Vampire Quill",description:"Heal 1 HP for every 10 enemies killed",rarity:"epic",type:"permanent",tags:["healing","on_kill"],effects:[{type:"on_kill_count",count:10,heal:1}],stacking:"linear",stackBonus:{count:-2}}],Oe={items:He},qe={baseSpawnBudget:10,budgetPerRound:5,maxEnemiesAlive:30,roundDuration:60,bossRounds:[5,10,15,20],scaling:{hpMultiplierPerRound:.05,speedMultiplierPerRound:.02,damageMultiplierPerRound:.03}},Fe=[{round:1,spawnBudget:5,spawnPattern:"trickle",enemyPool:["drifter"],spawnInterval:1,description:"Introduction - basic drifters only"},{round:2,spawnBudget:8,spawnPattern:"trickle",enemyPool:["drifter","zigzag"],spawnInterval:.8,description:"Introduce zigzag enemies"},{round:3,spawnBudget:12,spawnPattern:"burst",enemyPool:["drifter","zigzag"],spawnInterval:1,burstSize:3,description:"First burst spawning"},{round:4,spawnBudget:25,spawnPattern:"sides",enemyPool:["drifter","zigzag","dasher"],spawnInterval:1.5,description:"Introduce dashers, spawn from sides"},{round:5,isBoss:!0,bossId:"king_scribble",additionalEnemies:{spawnBudget:10,enemyPool:["drifter"],spawnInterval:5},description:"BOSS: King Scribble"},{round:6,spawnBudget:35,spawnPattern:"ring",enemyPool:["drifter","zigzag","dasher","orbiter"],spawnInterval:1.3,description:"Introduce orbiters, ring spawn pattern"},{round:7,spawnBudget:40,spawnPattern:"trickle",enemyPool:["zigzag","dasher","orbiter","sniper"],spawnInterval:1.2,description:"Introduce snipers"},{round:8,spawnBudget:50,spawnPattern:"burst",enemyPool:["drifter","zigzag","bomber"],spawnInterval:1,burstSize:5,description:"Introduce bombers with large bursts"},{round:9,spawnBudget:60,spawnPattern:"sides",enemyPool:["dasher","orbiter","sniper","splitter"],spawnInterval:1,description:"Introduce splitters"},{round:10,isBoss:!0,bossId:"paper_dragon",additionalEnemies:{spawnBudget:20,enemyPool:["drifter","zigzag","bomber"],spawnInterval:4},description:"BOSS: Paper Dragon"}],Ge={trickle:{description:"Enemies spawn one at a time at random screen edges",burstSize:1},burst:{description:"Groups of enemies spawn together",defaultBurstSize:4},sides:{description:"Enemies spawn from left and right sides",positions:["left","right"]},ring:{description:"Enemies spawn in a ring around the player",radius:400,distribution:"even"},corners:{description:"Enemies spawn from arena corners",positions:["top_left","top_right","bottom_left","bottom_right"]}},Xe={config:qe,rounds:Fe,spawnPatterns:Ge},Ye=[{id:"burn",name:"Burn",description:"Deals damage over time",type:"dot",damagePerSecond:5,duration:3,maxStacks:5,stackBehavior:"refresh_and_add",visual:{color:"#ff6b35",particleType:"fire",iconShape:"flame"}},{id:"shock",name:"Shock",description:"Briefly stuns and has chance to chain to nearby enemies",type:"stun",stunDuration:.3,chainChance:.3,chainRange:80,duration:.5,maxStacks:1,stackBehavior:"refresh",visual:{color:"#00d4ff",particleType:"lightning",iconShape:"bolt"}},{id:"slow",name:"Slow",description:"Reduces movement speed",type:"debuff",speedMultiplier:.5,duration:2,maxStacks:3,stackBehavior:"refresh_and_add",stackBonus:{speedMultiplier:-.1},visual:{color:"#74b9ff",particleType:"ice",iconShape:"snowflake"}},{id:"mark",name:"Mark",description:"Marked enemies take increased damage",type:"debuff",damageMultiplier:1.5,duration:5,maxStacks:1,stackBehavior:"refresh",visual:{color:"#e056fd",particleType:"glow",iconShape:"crosshair"}},{id:"poison",name:"Poison",description:"Stacking damage over time",type:"dot",damagePerSecond:3,damagePerStack:2,duration:4,maxStacks:10,stackBehavior:"add_duration",visual:{color:"#2ecc71",particleType:"bubble",iconShape:"skull"}},{id:"bleed",name:"Bleed",description:"Damage increases with movement",type:"dot_conditional",baseDamagePerSecond:2,movementDamageMultiplier:3,duration:3,maxStacks:5,stackBehavior:"add_stacks",visual:{color:"#e74c3c",particleType:"drip",iconShape:"drop"}}],Je={statusEffects:Ye};let y="menu",p,e,te=[],ae=[],ie=[],H={config:{},rounds:[]},ne=[];const f={x:0,y:0,radius:120,hp:100,maxHp:100},l={orbitAngle:0,orbitRadius:135,orbitSpeed:3,x:0,y:0,hp:100,maxHp:100,baseDamage:10,fireRate:5,lastFireTime:0,projectileSpeed:600,critChance:.05,critMultiplier:2,pickupRadius:50,luck:0,damageReduction:0,pierce:0,bounce:0,chain:0,aoeRadius:0,projectilesPerShot:1,aimAngle:0,invulnerableTime:0,isBlocking:!1,blockTime:0,blockCooldown:0};let N=0,V=8,se=!1,g=[],v=[],j=[],Ne=0,b=1,U=0,L=0,B=0,le=0,q=0,T=0,G=0;const Ve=2,$e=5;let C=0,P=[],oe=0,re=0,D=[];const Q=new Map;function Ke(t){if(Q.has(t)){const a=Q.get(t);return a.complete?a:null}const i=new Image;return i.src=t,Q.set(t,i),null}const z={};let X=0,Y=0,F=!1;const $=typeof window<"u"&&window.matchMedia("(pointer: coarse)").matches,K={active:!1,dx:0,dy:0},E={active:!1,dx:0,dy:0};let x={intensity:0,duration:0};function ee(t,i,a){return Math.max(i,Math.min(a,t))}function w(t,i,a,n){return Math.sqrt((a-t)**2+(n-i)**2)}function ce(t,i){const a=Math.sqrt(t*t+i*i);return a===0?{x:0,y:0}:{x:t/a,y:i/a}}function I(t,i){return t+Math.random()*(i-t)}function ke(t,i="weight"){const a=t.reduce((s,o)=>s+(o[i]||1),0);let n=Math.random()*a;for(const s of t)if(n-=s[i]||1,n<=0)return s;return t[0]}function J(t,i){x.intensity=Math.max(x.intensity,t),x.duration=Math.max(x.duration,i)}function Ue(){console.log("[loadGameData] Loading game data from bundled JSON..."),te=je.bullets,ae=We.enemies,ie=Oe.items,H=Xe,ne=Je.statusEffects,console.log("[loadGameData] Loaded:",{bullets:te.length,enemies:ae.length,items:ie.length,rounds:H.rounds.length,statusEffects:ne.length})}function Ze(t){return te.find(i=>i.id===t)}function we(t){return ae.find(i=>i.id===t)}function W(t){return ne.find(i=>i.id===t)}function xe(t){return H.rounds.find(i=>i.round===t)}function M(t){let i=l[t]||0,a=0,n=1;for(const s of P)for(const o of s.data.effects)if(o.stat===t){if(o.type==="stat_add")a+=(o.value||0)*s.stacks;else if(o.type==="stat_mult")n*=o.value||1;else if(o.type==="stat_set")return o.value||0}return(i+a)*n}function ue(t,i="pencil_shot"){const a=Ze(i);if(!a){console.log("[createPlayerProjectile] Unknown bullet type:",i);return}const n=M("baseDamage")*(a.baseDamage/10),s=a.speed,o=a.pierce+Math.floor(M("pierce")),r=a.bounce+Math.floor(M("bounce")),c=a.chain+Math.floor(M("chain")),u=a.aoeRadius+M("aoeRadius"),d={x:l.x,y:l.y,vx:Math.cos(t)*s,vy:Math.sin(t)*s,damage:n,lifetime:a.lifetime,maxLifetime:a.lifetime,radius:a.collisionRadius,pierce:o,pierceCount:0,bounce:r,chain:c,chainRange:a.chainRange||100,chainDamageMultiplier:a.chainDamageMultiplier||.7,aoeRadius:u,damageType:a.damageType,statusEffects:a.statusEffects,knockback:a.knockback||0,homing:a.homing?.enabled?{turnRate:a.homing.turnRate,seekRadius:a.homing.seekRadius}:void 0,visual:a.visual,hitEnemies:new Set,isPlayerProjectile:!0};if(g.push(d),a.spread){const h=a.spread.angle*Math.PI/180;for(let m=1;m<a.spread.count;m++){const k=(m%2===0?1:-1)*Math.ceil(m/2)*h/(a.spread.count-1),R={...d,hitEnemies:new Set};R.vx=Math.cos(t+k)*s,R.vy=Math.sin(t+k)*s,g.push(R)}}}function Pe(){const t=performance.now()/1e3,a=1/M("fireRate");if(t-l.lastFireTime<a)return;l.lastFireTime=t;const n=Math.max(1,Math.floor(M("projectilesPerShot")));for(let s=0;s<n;s++){const o=n>1?(s-(n-1)/2)*.1:0;ue(l.aimAngle+o)}oe++;for(const s of P)for(const o of s.data.effects){if(o.type==="on_shot"&&o.spawnProjectile&&Math.random()<(o.chance||1))for(let r=0;r<(o.count||1);r++){const c=l.aimAngle+I(-.3,.3);ue(c,o.spawnProjectile)}o.type==="on_shot_count"&&o.count&&oe%o.count===0&&console.log("[firePlayerWeapon] Triggered on_shot_count effect:",o.createEntity)}}function Qe(t){for(let i=g.length-1;i>=0;i--){const a=g[i];if(a.homing){let n=null,s=a.homing.seekRadius;for(const o of v){const r=w(a.x,a.y,o.x,o.y);r<s&&!a.hitEnemies.has(o.id)&&(s=r,n=o)}if(n){const o=Math.atan2(n.y-a.y,n.x-a.x),r=Math.atan2(a.vy,a.vx);let c=o-r;for(;c>Math.PI;)c-=Math.PI*2;for(;c<-Math.PI;)c+=Math.PI*2;const u=ee(c,-a.homing.turnRate*t,a.homing.turnRate*t),d=r+u,h=Math.sqrt(a.vx*a.vx+a.vy*a.vy);a.vx=Math.cos(d)*h,a.vy=Math.sin(d)*h}}if(a.x+=a.vx*t,a.y+=a.vy*t,a.lifetime-=t,a.bounce>0&&((a.x<a.radius||a.x>p.width-a.radius)&&(a.vx*=-1,a.bounce--,a.x=ee(a.x,a.radius,p.width-a.radius)),(a.y<a.radius||a.y>p.height-a.radius)&&(a.vy*=-1,a.bounce--,a.y=ee(a.y,a.radius,p.height-a.radius))),a.isPlayerProjectile)for(const n of v){if(a.hitEnemies.has(n.id))continue;const s=w(a.x,a.y,n.x,n.y),o=n.data.visual.radius||n.data.visual.size||15;if(s<a.radius+o){if(a.hitEnemies.add(n.id),fe(n,a.damage,a),a.knockback>0){const r=ce(n.x-a.x,n.y-a.y);n.vx+=r.x*a.knockback,n.vy+=r.y*a.knockback}if(a.aoeRadius>0){for(const r of v)r.id!==n.id&&!a.hitEnemies.has(r.id)&&w(a.x,a.y,r.x,r.y)<a.aoeRadius&&(a.hitEnemies.add(r.id),fe(r,a.damage*.5,a));for(let r=0;r<10;r++)S(a.x,a.y,a.visual.color,"explosion")}if(a.chain>0){let r=null,c=a.chainRange;for(const u of v)if(!a.hitEnemies.has(u.id)){const d=w(n.x,n.y,u.x,u.y);d<c&&(c=d,r=u)}if(r){const u={...a,x:n.x,y:n.y,vx:0,vy:0,damage:a.damage*a.chainDamageMultiplier,chain:a.chain-1,hitEnemies:new Set(a.hitEnemies),lifetime:.1},d=Math.atan2(r.y-n.y,r.x-n.x),h=Math.sqrt(a.vx*a.vx+a.vy*a.vy);u.vx=Math.cos(d)*h,u.vy=Math.sin(d)*h,g.push(u)}}a.pierceCount++,a.pierceCount>a.pierce&&(a.lifetime=0);break}}(a.lifetime<=0||a.x<-100||a.x>p.width+100||a.y<-100||a.y>p.height+100)&&g.splice(i,1)}}function Se(t,i,a){const n=we(t);if(!n)return console.log("[spawnEnemy] Unknown enemy type:",t),null;if(i===void 0||a===void 0)switch(Math.floor(Math.random()*4)){case 0:i=I(0,p.width),a=-30;break;case 1:i=p.width+30,a=I(0,p.height);break;case 2:i=I(0,p.width),a=p.height+30;break;case 3:i=-30,a=I(0,p.height);break}const s=H.config,o=1+(b-1)*(s.scaling?.hpMultiplierPerRound||.05),r=1+(b-1)*(s.scaling?.speedMultiplierPerRound||.02),c={id:Ne++,type:t,x:i,y:a,vx:0,vy:0,hp:n.hp*o,maxHp:n.hp*o,speed:n.speed*r,contactDamage:n.contactDamage,data:n,behaviorState:{},statusEffects:new Map,invulnerableTime:0,facingAngle:0,lastFireTime:0};return v.push(c),c}function fe(t,i,a){if(t.invulnerableTime>0)return;if(t.data.shield){const s=Math.atan2(l.y-t.y,l.x-t.x);let o=Math.abs(s-t.facingAngle);for(;o>Math.PI;)o=Math.abs(o-Math.PI*2);const r=t.data.shield.arcDegrees*Math.PI/180/2;o<r&&(i*=1-t.data.shield.frontalReduction)}if(Math.random()<M("critChance")&&(i*=M("critMultiplier"),S(t.x,t.y-20,"#ffd700","crit")),t.statusEffects.get("mark")){const s=W("mark");s&&(i*=s.damageMultiplier||1.5)}if(t.hp-=i,t.invulnerableTime=.05,a)for(const s of a.statusEffects)Math.random()<s.chance&&et(t,s.type,s.stacks);S(t.x,t.y,t.data.visual.color,"hit"),t.hp<=0&&Me(t)}function Me(t){console.log("[killEnemy] Enemy killed:",t.type);for(let a=0;a<8;a++)S(t.x,t.y,t.data.visual.color,"death");if(q+=t.data.xpValue*10,le++,re++,T+=1+Math.floor(T*.1),G=Ve,t.data.onDeath)for(let a=0;a<t.data.onDeath.count;a++){const n=I(-20,20);Se(t.data.onDeath.spawn,t.x+n,t.y+n)}for(const a of P)for(const n of a.data.effects)n.type==="on_kill_count"&&n.count&&re%n.count===0&&n.heal&&(l.hp=Math.min(l.maxHp,l.hp+n.heal));const i=v.indexOf(t);i>=0&&v.splice(i,1),J(3,.1)}function et(t,i,a){const n=W(i);if(!n)return;const s=t.statusEffects.get(i);s?(s.stacks=Math.min(s.stacks+a,n.maxStacks),s.duration=n.duration):t.statusEffects.set(i,{stacks:a,duration:n.duration})}function tt(t){for(const i of v){for(const[c,u]of i.statusEffects){if(u.duration-=t,u.duration<=0){i.statusEffects.delete(c);continue}const d=W(c);if(d&&d.type==="dot"&&d.damagePerSecond){const h=(d.damagePerSecond+(d.damagePerStack||0)*(u.stacks-1))*t;if(i.hp-=h,i.hp<=0){Me(i);continue}}}i.invulnerableTime>0&&(i.invulnerableTime-=t);let a=1;if(i.statusEffects.get("slow")){const c=W("slow");c&&(a*=c.speedMultiplier||.5)}const s=i.statusEffects.get("shock");if(s){const c=W("shock");if(c&&s.duration>c.duration-(c.stunDuration||0))continue}at(i,t,a),i.x+=i.vx*t,i.y+=i.vy*t,i.vx*=.9,i.vy*=.9,w(i.x,i.y,f.x,f.y)<f.radius+15&&(Te(i.contactDamage),i.hp=0),w(i.x,i.y,l.x,l.y)<30&&l.invulnerableTime<=0&&Re(i.contactDamage)}}function at(t,i,a){const n=t.data.behaviorProfile,s=t.data.behaviorParams||{},o=ce(f.x-t.x,f.y-t.y);switch(t.facingAngle=Math.atan2(o.y,o.x),n){case"drifter":{t.vx+=o.x*t.speed*a*i*2,t.vy+=o.y*t.speed*a*i*2;break}case"zigzag":{const r=performance.now()/1e3,c=Math.sin(r*(s.waveFrequency||3))*(s.waveAmplitude||50),u=-o.y,d=o.x;t.vx+=(o.x*t.speed+u*c)*a*i*2,t.vy+=(o.y*t.speed+d*c)*a*i*2;break}case"dasher":{const r=t.behaviorState;if(r.dashCooldown=(r.dashCooldown||0)-i,r.dashing)r.dashTime=(r.dashTime||0)-i,r.dashTime<=0&&(r.dashing=!1,r.dashCooldown=s.dashCooldown||2);else if(r.dashCooldown<=0){r.dashing=!0,r.dashTime=s.dashDuration||.3;const c=t.data.dashSpeed||400;t.vx=o.x*c,t.vy=o.y*c}else t.vx+=o.x*t.speed*a*i*.5,t.vy+=o.y*t.speed*a*i*.5;break}case"orbiter":{const r=s.orbitRadius||200,c=s.orbitSpeed||2,u=t.behaviorState;u.angle=(u.angle||Math.atan2(t.y-f.y,t.x-f.x))+c*i;const d=f.x+Math.cos(u.angle)*r,h=f.y+Math.sin(u.angle)*r;if(t.vx+=(d-t.x)*3*i,t.vy+=(h-t.y)*3*i,t.data.projectile){const m=performance.now()/1e3;m-t.lastFireTime>1/t.data.projectile.fireRate&&(t.lastFireTime=m,pe(t))}break}case"sniper":{const r=s.preferredDistance||300,c=w(t.x,t.y,f.x,f.y);if(c<r-50?(t.vx-=o.x*t.speed*a*i*2,t.vy-=o.y*t.speed*a*i*2):c>r+50&&(t.vx+=o.x*t.speed*a*i*2,t.vy+=o.y*t.speed*a*i*2),t.data.projectile){const u=performance.now()/1e3;u-t.lastFireTime>1/t.data.projectile.fireRate&&(t.lastFireTime=u,pe(t))}break}case"bomber":{const r=t.behaviorState,c=s.dropRadius||80,u=w(t.x,t.y,f.x,f.y);r.retreating?(t.vx-=o.x*t.speed*a*i*3,t.vy-=o.y*t.speed*a*i*3,u>(s.retreatDistance||250)&&(r.retreating=!1,r.bombDropped=!1)):(t.vx+=o.x*t.speed*a*i*3,t.vy+=o.y*t.speed*a*i*3,u<c&&!r.bombDropped&&(r.bombDropped=!0,r.retreating=!0,S(t.x,t.y,"#ff9f43","bomb")));break}default:t.vx+=o.x*t.speed*a*i*2,t.vy+=o.y*t.speed*a*i*2}}function pe(t){if(!t.data.projectile)return;const i=Math.atan2(l.y-t.y,l.x-t.x),a={x:t.x,y:t.y,vx:Math.cos(i)*t.data.projectile.speed,vy:Math.sin(i)*t.data.projectile.speed,damage:t.data.projectile.damage,lifetime:3,maxLifetime:3,radius:6,pierce:0,pierceCount:0,bounce:0,chain:0,chainRange:0,chainDamageMultiplier:0,aoeRadius:0,damageType:"kinetic",statusEffects:[],knockback:0,visual:{shape:"circle",color:"#ff4444",radius:6},hitEnemies:new Set,isPlayerProjectile:!1};g.push(a)}function it(){console.log("[spawnMeteor] Spawning meteor targeting player");const t=Math.random()*Math.PI*2,i=Math.max(p.width,p.height)*.7,a=f.x+Math.cos(t)*i,n=f.y+Math.sin(t)*i,s=ce(l.x-a,l.y-n),o=180+b*10,r=!se;se=!0;const c={x:a,y:n,vx:s.x*o,vy:s.y*o,damage:25,lifetime:8,maxLifetime:8,radius:18,pierce:0,pierceCount:0,bounce:0,chain:0,chainRange:0,chainDamageMultiplier:0,aoeRadius:0,damageType:"fire",statusEffects:[],knockback:0,visual:{shape:"circle",color:"#ff9800",radius:18,trail:!0,trailColor:"#ff5722"},hitEnemies:new Set,isPlayerProjectile:!1,isMeteor:!0,showTutorial:r};g.push(c)}function Te(t){f.hp-=t,console.log("[damagePlanet] Planet took",t,"damage. HP:",f.hp),J(10,.3),S(f.x,f.y,"#ff6b6b","hit"),f.hp<=0&&(f.hp=0,Be())}function Re(t){if(l.isBlocking){S(l.x,l.y,"#4fc3f7","block"),J(3,.1);return}if(l.invulnerableTime>0)return;const i=M("damageReduction"),a=t*(1-i);l.hp-=a,l.invulnerableTime=.5,J(8,.2),S(l.x,l.y,"#ff6b6b","hit"),l.hp<=0&&Be()}function nt(){l.blockCooldown>0||(console.log("[activateBlock] Block activated!"),l.isBlocking=!0,l.blockTime=.5,l.blockCooldown=2,S(l.x,l.y,"#4fc3f7","shield"))}function st(){let t=null,i=1/0;for(const a of v){if(!ot(l.x,l.y,a.x,a.y,f.x,f.y,f.radius-5))continue;const n=w(l.x,l.y,a.x,a.y);n<i&&(i=n,t=a)}return t}function ot(t,i,a,n,s,o,r){const c=a-t,u=n-i,d=c*c+u*u;if(d===0)return w(t,i,s,o)>r;let h=((s-t)*c+(o-i)*u)/d;h=Math.max(0,Math.min(1,h));const m=t+h*c,k=i+h*u;return(s-m)**2+(o-k)**2>r*r}function rt(t){let i=0;$?i=-K.dx:((z.a||z.arrowleft)&&(i-=1),(z.d||z.arrowright)&&(i+=1)),l.orbitAngle+=i*l.orbitSpeed*t,l.x=f.x+Math.cos(l.orbitAngle)*l.orbitRadius,l.y=f.y+Math.sin(l.orbitAngle)*l.orbitRadius;let a=!1;if($?E.active&&(E.dx!==0||E.dy!==0)&&(l.aimAngle=Math.atan2(E.dy,E.dx),a=!0):F&&(l.aimAngle=Math.atan2(Y-l.y,X-l.x),a=!0),!a){const n=st();n?l.aimAngle=Math.atan2(n.y-l.y,n.x-l.x):$||(l.aimAngle=Math.atan2(Y-l.y,X-l.x))}Pe(),l.invulnerableTime>0&&(l.invulnerableTime-=t),l.isBlocking&&(l.blockTime-=t,l.blockTime<=0&&(l.isBlocking=!1)),l.blockCooldown>0&&(l.blockCooldown-=t),N-=t,N<=0&&y==="playing"&&(it(),N=V,V=Math.max(4,V-.5));for(let n=g.length-1;n>=0;n--){const s=g[n];if(w(s.x,s.y,f.x,f.y)<s.radius+f.radius-10){s.isPlayerProjectile||Te(s.damage),g.splice(n,1);continue}s.isPlayerProjectile||w(s.x,s.y,l.x,l.y)<s.radius+20&&(Re(s.damage),g.splice(n,1))}}function de(){const t=xe(b);if(!t){console.log("[startRound] No data for round",b,"- using default"),B=10+b*5,L=2,U=60;return}console.log("[startRound] Starting round",b,t),t.isBoss?(console.log("[startRound] Boss round - spawning boss:",t.bossId),B=t.additionalEnemies?.spawnBudget||20,L=t.additionalEnemies?.spawnInterval||3):(B=t.spawnBudget,L=t.spawnInterval),U=H.config.roundDuration||60}function lt(t){const i=xe(b);if(L-=t,L<=0&&B>0){const n=(i?.enemyPool||["drifter"]).map(s=>we(s)).filter(s=>s&&s.spawnCost<=B);if(n.length>0){const s=H.config.maxEnemiesAlive||30;if(v.length<s){const o=ke(n.map(r=>({...r,weight:1/r.spawnCost})));Se(o.id),B-=o.spawnCost}}L=i?.spawnInterval||1.5}B<=0&&v.length===0&&he(),U-=t,U<=0&&he()}function he(){console.log("[endRound] Round",b,"complete!"),b++,v=[],g=[];for(let t=P.length-1;t>=0;t--){const i=P[t];i.data.type==="temporary"&&i.remainingRounds!==void 0&&(i.remainingRounds--,i.remainingRounds<=0&&(console.log("[endRound] Temporary item expired:",i.data.name),P.splice(t,1)))}b>=2?dt():de()}function ct(t){G>0?G-=t:T>0&&(T=Math.max(0,T-$e*t))}function dt(){y="reward",C=Math.floor(T),T=0,G=0,console.log("[showRewardScreen] Currency earned:",C);const t=ut(2),i={common:10,rare:25,epic:50,legendary:100,cursed:15},a=p.width/2,n=p.height/2,s=180,o=220,r=50;D=[],t[0]&&D.push({x:a-s-r/2,y:n-o/2-30,width:s,height:o,item:t[0],cost:i[t[0].rarity]||20}),t[1]&&D.push({x:a+r/2,y:n-o/2-30,width:s,height:o,item:t[1],cost:i[t[1].rarity]||20}),D.push({x:a-80,y:n+o/2+20,width:160,height:50,item:null,cost:0}),document.getElementById("rewardScreen").classList.remove("hidden"),document.getElementById("hud").style.display="none"}function ut(t){const i=[],a=[...ie],n={common:50,rare:30,epic:15,legendary:4,cursed:1+(b>5?4:0)};for(let s=0;s<t&&a.length>0;s++){const o=a.map(c=>({...c,weight:n[c.rarity]||10})),r=ke(o);if(i.push(r),r.stacking==="unique"){const c=a.findIndex(u=>u.id===r.id);c>=0&&a.splice(c,1)}}return i}function ft(t){l.x=f.x+Math.cos(l.orbitAngle)*l.orbitRadius,l.y=f.y+Math.sin(l.orbitAngle)*l.orbitRadius,l.aimAngle=Math.atan2(Y-l.y,X-l.x);for(let i=g.length-1;i>=0;i--){const a=g[i];if(a.isPlayerProjectile){for(const n of D)if(a.x>=n.x&&a.x<=n.x+n.width&&a.y>=n.y&&a.y<=n.y+n.height){g.splice(i,1),n.item===null?ht():C>=n.cost?pt(n.item,n.cost):(S(n.x+n.width/2,n.y+n.height/2,"#ff4444","hit"),J(3,.1));break}}}F&&Pe()}function pt(t,i){console.log("[selectReward] Selected:",t.name,"Cost:",i),C-=i;const a=P.find(n=>n.data.id===t.id);if(a&&t.stacking!=="unique")a.stacks++;else{const n={data:t,stacks:1};t.type==="temporary"&&(n.remainingRounds=t.duration||3),P.push(n)}Ee(),S(p.width/2,p.height/2,"#4caf50","death"),Ie()}function ht(){console.log("[skipReward] Skipping reward"),Ie()}function Ie(){document.getElementById("rewardScreen").classList.add("hidden"),document.getElementById("hud").style.display="flex",D=[],g=[],y="playing",de()}function Ee(){const t=document.getElementById("itemsDisplay");t.innerHTML="";for(const i of P){const a=document.createElement("div");a.className="item-icon",a.title=`${i.data.name}${i.stacks>1?" x"+i.stacks:""}`,a.textContent=i.data.name.charAt(0).toUpperCase(),t.appendChild(a)}}function me(){console.log("[startGame] Starting new game"),y="playing",b=1,q=0,le=0,oe=0,re=0,g=[],v=[],j=[],P=[],f.x=p.width/2,f.y=p.height/2,f.hp=f.maxHp,l.orbitAngle=-Math.PI/2,l.x=f.x+Math.cos(l.orbitAngle)*l.orbitRadius,l.y=f.y+Math.sin(l.orbitAngle)*l.orbitRadius,l.hp=100,l.maxHp=100,l.invulnerableTime=0,l.isBlocking=!1,l.blockTime=0,l.blockCooldown=0,N=5,V=8,se=!1,T=0,G=0,C=0,document.getElementById("startScreen").classList.add("hidden"),document.getElementById("gameOverScreen").classList.add("hidden"),document.getElementById("hud").style.display="flex",Ee(),de()}function Be(){console.log("[gameOver] Game over! Score:",q),y="gameover",typeof window.submitScore=="function"&&window.submitScore(q),document.getElementById("finalScore").textContent=q.toString(),document.getElementById("roundsCleared").textContent=(b-1).toString(),document.getElementById("enemiesKilled").textContent=le.toString(),document.getElementById("itemsCollected").textContent=P.length.toString(),document.getElementById("hud").style.display="none",document.getElementById("gameOverScreen").classList.remove("hidden")}function mt(){y==="playing"&&(console.log("[pauseGame] Game paused"),y="paused",document.getElementById("pauseScreen").classList.remove("hidden"))}function De(){y==="paused"&&(console.log("[resumeGame] Game resumed"),y="playing",document.getElementById("pauseScreen").classList.add("hidden"))}function gt(){y==="playing"?mt():y==="paused"&&De()}function S(t,i,a,n){const s=Math.random()*Math.PI*2,o=I(50,150);j.push({x:t,y:i,vx:Math.cos(s)*o,vy:Math.sin(s)*o,life:I(.3,.6),maxLife:.5,size:I(3,8),color:a,type:n})}function ge(t){for(let i=j.length-1;i>=0;i--){const a=j[i];a.x+=a.vx*t,a.y+=a.vy*t,a.vx*=.95,a.vy*=.95,a.life-=t,a.life<=0&&j.splice(i,1)}}function yt(){e.fillStyle="#fdf6e3",e.fillRect(0,0,p.width,p.height),e.strokeStyle="rgba(200, 190, 170, 0.3)",e.lineWidth=1;const t=40;for(let i=0;i<p.width;i+=t)e.beginPath(),e.moveTo(i,0),e.lineTo(i,p.height),e.stroke();for(let i=0;i<p.height;i+=t)e.beginPath(),e.moveTo(0,i),e.lineTo(p.width,i),e.stroke();if(x.duration>0){const i=(Math.random()-.5)*x.intensity,a=(Math.random()-.5)*x.intensity;e.translate(i,a)}for(const i of j){const a=i.life/i.maxLife;e.globalAlpha=a,e.fillStyle=i.color,e.beginPath(),e.arc(i.x,i.y,i.size*a,0,Math.PI*2),e.fill()}e.globalAlpha=1;for(const i of g)Ce(i);for(const i of v)vt(i);kt(),wt(),e.setTransform(1,0,0,1,0,0),xt(),y==="reward"&&bt()}function bt(){e.font="bold 32px 'Bangers', cursive",e.fillStyle="#ffd93d",e.strokeStyle="#333",e.lineWidth=3,e.textAlign="center";const t=`COMBO COINS: ${C}`;e.strokeText(t,p.width/2,80),e.fillText(t,p.width/2,80),e.font="18px 'Comic Neue', cursive",e.fillStyle="#666",e.fillText("SHOOT to select an item!",p.width/2,110);for(const i of D){e.save();const a=i.item===null||C>=i.cost,n=i.item===null;if(e.fillStyle=a?"#fff":"rgba(255, 255, 255, 0.5)",e.strokeStyle=n?"#888":a?"#333":"#ccc",e.lineWidth=3,e.beginPath(),e.roundRect(i.x,i.y,i.width,i.height,10),e.fill(),e.stroke(),n)e.font="bold 24px 'Bangers', cursive",e.fillStyle="#666",e.textAlign="center",e.fillText("SKIP",i.x+i.width/2,i.y+i.height/2+8);else if(i.item){const s=i.item,o=i.x+i.width/2;let r=i.y+30;const c={common:"#888",rare:"#4fc3f7",epic:"#ab47bc",legendary:"#ffd93d",cursed:"#8b0000"};e.fillStyle=c[s.rarity]||"#888",e.font="12px 'Comic Neue', cursive",e.textAlign="center",e.fillText(s.rarity.toUpperCase(),o,r),r+=25,e.font="bold 18px 'Bangers', cursive",e.fillStyle=a?"#333":"#999",e.fillText(s.name,o,r),r+=25,e.font="14px 'Comic Neue', cursive",e.fillStyle=a?"#555":"#aaa";const u=s.description.split(" ");let d="";const h=i.width-20;for(const k of u){const R=d+k+" ";e.measureText(R).width>h?(e.fillText(d.trim(),o,r),d=k+" ",r+=18):d=R}e.fillText(d.trim(),o,r),r+=30,e.font="bold 20px 'Bangers', cursive",e.fillStyle=a?"#ffd93d":"#ff4444",e.strokeStyle="#333",e.lineWidth=2;const m=`${i.cost} coins`;e.strokeText(m,o,i.y+i.height-20),e.fillText(m,o,i.y+i.height-20),a||(e.fillStyle="rgba(255, 0, 0, 0.1)",e.beginPath(),e.roundRect(i.x,i.y,i.width,i.height,10),e.fill())}e.restore()}for(const i of g)Ce(i)}function Ce(t){e.save(),e.translate(t.x,t.y);const i=Math.atan2(t.vy,t.vx);if(t.isMeteor){e.save(),e.rotate(i);const a=e.createLinearGradient(-40,0,10,0);if(a.addColorStop(0,"rgba(255, 87, 34, 0)"),a.addColorStop(.5,"rgba(255, 152, 0, 0.6)"),a.addColorStop(1,"rgba(255, 193, 7, 0.8)"),e.fillStyle=a,e.beginPath(),e.moveTo(-50,0),e.quadraticCurveTo(-25,-12,0,-8),e.lineTo(0,8),e.quadraticCurveTo(-25,12,-50,0),e.fill(),e.restore(),e.fillStyle="#ff9800",e.strokeStyle="#e65100",e.lineWidth=3,e.beginPath(),e.arc(0,0,t.radius,0,Math.PI*2),e.fill(),e.stroke(),e.fillStyle="#f57c00",e.beginPath(),e.arc(-4,-3,5,0,Math.PI*2),e.arc(5,4,4,0,Math.PI*2),e.arc(-2,6,3,0,Math.PI*2),e.fill(),e.shadowColor="#ff9800",e.shadowBlur=15,e.beginPath(),e.arc(0,0,t.radius-2,0,Math.PI*2),e.stroke(),e.shadowBlur=0,t.showTutorial){e.rotate(-i),e.font="bold 16px 'Comic Neue', cursive",e.fillStyle="#fff",e.strokeStyle="#333",e.lineWidth=3,e.textAlign="center";const n="RIGHT CLICK TO BLOCK!";e.strokeText(n,0,-35),e.fillText(n,0,-35),e.fillStyle="#fff",e.beginPath(),e.moveTo(0,-25),e.lineTo(-6,-30),e.lineTo(6,-30),e.closePath(),e.fill()}e.restore();return}switch(e.rotate(i),e.fillStyle=t.visual.color,e.strokeStyle="#2d2d2d",e.lineWidth=2,t.visual.shape){case"circle":e.beginPath(),e.arc(0,0,t.visual.radius||5,0,Math.PI*2),e.fill(),e.stroke();break;case"line":e.lineCap="round",e.lineWidth=t.visual.width||3,e.strokeStyle=t.visual.color,e.beginPath(),e.moveTo(-(t.visual.length||15)/2,0),e.lineTo((t.visual.length||15)/2,0),e.stroke();break;case"triangle":e.beginPath(),e.moveTo(t.visual.radius||5,0),e.lineTo(-(t.visual.radius||5),-(t.visual.radius||5)*.6),e.lineTo(-(t.visual.radius||5),(t.visual.radius||5)*.6),e.closePath(),e.fill(),e.stroke();break;default:e.beginPath(),e.arc(0,0,t.radius,0,Math.PI*2),e.fill(),e.stroke()}e.restore()}function vt(t){e.save(),e.translate(t.x,t.y);const i=t.data.visual,a=i.radius||i.size||15;if(t.invulnerableTime>0&&(e.globalAlpha=.6),i.image){const s=Ke(i.image);if(s){const o=a*2.5;e.drawImage(s,-o/2,-o/2,o,o),e.restore();return}}switch(e.fillStyle=i.color,e.strokeStyle="#2d2d2d",e.lineWidth=i.outlineWidth,i.shape){case"circle":case"blob":e.beginPath(),e.arc(0,0,a,0,Math.PI*2),e.fill(),e.stroke();break;case"diamond":e.beginPath(),e.moveTo(0,-a),e.lineTo(a,0),e.lineTo(0,a),e.lineTo(-a,0),e.closePath(),e.fill(),e.stroke();break;case"triangle":e.rotate(t.facingAngle),e.beginPath(),e.moveTo(a,0),e.lineTo(-a*.7,-a*.8),e.lineTo(-a*.7,a*.8),e.closePath(),e.fill(),e.stroke();break;case"square":e.beginPath(),e.rect(-a,-a,a*2,a*2),e.fill(),e.stroke();break;case"ring":e.beginPath(),e.arc(0,0,a,0,Math.PI*2),e.stroke(),e.beginPath(),e.arc(0,0,a*.6,0,Math.PI*2),e.fill(),e.stroke();break;case"shielded_circle":if(t.data.shield){e.fillStyle=i.shieldColor||"#c8d6e5",e.beginPath();const s=t.data.shield.arcDegrees*Math.PI/180/2;e.arc(0,0,a+5,t.facingAngle-s,t.facingAngle+s),e.lineTo(0,0),e.closePath(),e.fill()}e.fillStyle=i.color,e.beginPath(),e.arc(0,0,a,0,Math.PI*2),e.fill(),e.stroke();break;default:e.beginPath(),e.arc(0,0,a,0,Math.PI*2),e.fill(),e.stroke()}let n=0;for(const[s]of t.statusEffects){const o=W(s);o&&(e.fillStyle=o.visual.color,e.beginPath(),e.arc(-a+n*8,-a-8,4,0,Math.PI*2),e.fill(),n++)}e.restore()}function kt(){e.save(),e.translate(f.x,f.y);const t=f.hp<f.maxHp*.3,i=Math.sin(performance.now()/800)*1.5;e.fillStyle="rgba(0, 0, 0, 0.1)",e.beginPath(),e.arc(4,4,f.radius+i,0,Math.PI*2),e.fill(),e.fillStyle=t?"#ffeeee":"#fafaf8",e.strokeStyle="#333",e.lineWidth=3,e.beginPath(),e.arc(0,0,f.radius+i,0,Math.PI*2),e.fill(),e.stroke(),e.strokeStyle="rgba(0, 0, 0, 0.05)",e.lineWidth=1;for(let r=0;r<5;r++){const c=r/5*Math.PI*2+performance.now()/1e4;e.beginPath(),e.arc(0,0,f.radius*(.3+r*.12),c,c+Math.PI*.5),e.stroke()}const a=[{angle:-Math.PI*.7,size:1},{angle:-Math.PI*.3,size:.7},{angle:Math.PI*.1,size:.85},{angle:Math.PI*.5,size:.6},{angle:Math.PI*.8,size:.9}];for(const r of a){e.save();const c=Math.cos(r.angle)*f.radius,u=Math.sin(r.angle)*f.radius;e.translate(c,u),e.rotate(r.angle+Math.PI/2);const d=r.size*12;e.strokeStyle="#5d4037",e.lineWidth=2*r.size,e.beginPath(),e.moveTo(0,0),e.lineTo(0,-d*1.2),e.stroke(),e.fillStyle="#66bb6a",e.strokeStyle="#333",e.lineWidth=1.5,e.beginPath(),e.moveTo(0,-d*2.5),e.lineTo(-d*.8,-d*.8),e.lineTo(0,-d*1.2),e.lineTo(d*.8,-d*.8),e.closePath(),e.fill(),e.stroke(),e.restore()}const n=100,s=8,o=f.hp/f.maxHp;e.fillStyle="rgba(255, 255, 255, 0.8)",e.strokeStyle="#333",e.lineWidth=2,e.beginPath(),e.roundRect(-n/2-4,-150,n+8,s+8,4),e.fill(),e.stroke(),e.fillStyle=o>.3?"#66bb6a":"#ef5350",e.beginPath(),e.roundRect(-n/2,-146,n*o,s,2),e.fill(),e.restore()}function wt(){e.save(),e.translate(l.x,l.y),e.rotate(l.orbitAngle+Math.PI/2),l.invulnerableTime>0&&Math.floor(l.invulnerableTime*10)%2===0&&(e.globalAlpha=.5),e.save(),e.rotate(-(l.orbitAngle+Math.PI/2));const t=w(l.x,l.y,X,Y),i=Math.max(40,t);e.strokeStyle="rgba(51, 51, 51, 0.3)",e.lineWidth=2,e.setLineDash([6,6]),e.beginPath(),e.moveTo(Math.cos(l.aimAngle)*30,Math.sin(l.aimAngle)*30),e.lineTo(Math.cos(l.aimAngle)*i,Math.sin(l.aimAngle)*i),e.stroke(),e.setLineDash([]);const a=Math.cos(l.aimAngle)*i,n=Math.sin(l.aimAngle)*i;e.fillStyle="rgba(239, 83, 80, 0.5)",e.beginPath(),e.arc(a,n,5,0,Math.PI*2),e.fill(),e.restore();const s=18;if(e.fillStyle="rgba(0, 0, 0, 0.15)",e.beginPath(),e.moveTo(2,-s*1.3+2),e.lineTo(s+2,2),e.lineTo(2,s*.6+2),e.lineTo(-s+2,2),e.closePath(),e.fill(),e.fillStyle="#fff",e.strokeStyle="#333",e.lineWidth=2.5,e.beginPath(),e.moveTo(0,-s*1.3),e.lineTo(s,0),e.lineTo(0,s*.6),e.lineTo(-s,0),e.closePath(),e.fill(),e.stroke(),e.fillStyle="#333",e.beginPath(),e.arc(-5,-4,3,0,Math.PI*2),e.arc(5,-4,3,0,Math.PI*2),e.fill(),e.strokeStyle="#333",e.lineWidth=2,e.lineCap="round",e.beginPath(),e.moveTo(-4,4),e.lineTo(4,4),e.stroke(),e.save(),e.rotate(-(l.orbitAngle+Math.PI/2)),e.rotate(l.aimAngle),e.fillStyle="#555",e.strokeStyle="#333",e.lineWidth=2,e.beginPath(),e.roundRect(8,-4,22,8,2),e.fill(),e.stroke(),e.fillStyle="#444",e.beginPath(),e.roundRect(26,-5,6,10,1),e.fill(),e.stroke(),e.restore(),l.isBlocking){e.save(),e.rotate(-(l.orbitAngle+Math.PI/2));const r=35*(Math.sin(performance.now()/50)*.2+.8);e.strokeStyle="rgba(79, 195, 247, 0.8)",e.lineWidth=4,e.shadowColor="#4fc3f7",e.shadowBlur=20,e.beginPath(),e.arc(0,0,r,0,Math.PI*2),e.stroke(),e.fillStyle="rgba(79, 195, 247, 0.2)",e.beginPath(),e.arc(0,0,r-2,0,Math.PI*2),e.fill(),e.strokeStyle="rgba(79, 195, 247, 0.5)",e.lineWidth=1,e.shadowBlur=0;for(let c=0;c<6;c++){const u=c/6*Math.PI*2;e.beginPath(),e.moveTo(0,0),e.lineTo(Math.cos(u)*r,Math.sin(u)*r),e.stroke()}e.restore()}if(l.blockCooldown>0&&!l.isBlocking){e.save(),e.rotate(-(l.orbitAngle+Math.PI/2));const o=l.blockCooldown/2;e.strokeStyle="rgba(150, 150, 150, 0.4)",e.lineWidth=3,e.beginPath(),e.arc(0,0,30,-Math.PI/2,-Math.PI/2+(1-o)*Math.PI*2),e.stroke(),e.restore()}e.restore()}function xt(){const t=f.hp/f.maxHp*100;document.getElementById("hpBar").style.width=t+"%";const i=document.getElementById("scoreDisplay");i.textContent=Math.floor(T).toString(),T>20?(i.style.color="#ffd93d",i.style.transform=`scale(${1+Math.sin(performance.now()/100)*.1})`):(i.style.color="",i.style.transform=""),document.getElementById("roundDisplay").textContent=b.toString()}let ye=0;function _e(t){const i=Math.min((t-ye)/1e3,.1);ye=t,x.duration>0&&(x.duration-=i,x.duration<=0&&(x.intensity=0)),y==="playing"?(rt(i),Qe(i),tt(i),ge(i),lt(i),ct(i)):y==="reward"&&(ft(),ge(i)),yt(),requestAnimationFrame(_e)}function Pt(){window.addEventListener("keydown",t=>{z[t.key.toLowerCase()]=!0,t.key==="Escape"&&gt(),t.key===" "&&y==="playing"&&(l.orbitAngle+=Math.PI)}),window.addEventListener("keyup",t=>{z[t.key.toLowerCase()]=!1}),p.addEventListener("mousemove",t=>{const i=p.getBoundingClientRect();X=(t.clientX-i.left)*(p.width/i.width),Y=(t.clientY-i.top)*(p.height/i.height)}),p.addEventListener("mousedown",t=>{t.button===0?F=!0:t.button===2&&y==="playing"&&nt()}),p.addEventListener("mouseup",t=>{t.button===0&&(F=!1)}),p.addEventListener("mouseleave",()=>{F=!1}),p.addEventListener("contextmenu",t=>{t.preventDefault()}),$&&Mt(),document.getElementById("startButton").onclick=me,document.getElementById("restartButton").onclick=me,document.getElementById("resumeButton").onclick=De,document.getElementById("quitButton").onclick=St}function St(){console.log("[quitToMenu] Returning to menu"),y="menu",document.getElementById("pauseScreen").classList.add("hidden"),document.getElementById("hud").style.display="none",document.getElementById("startScreen").classList.remove("hidden")}function Mt(){const t=document.getElementById("moveJoystick"),i=document.getElementById("moveThumb"),a=document.getElementById("aimJoystick"),n=document.getElementById("aimThumb");let s=null,o=null;const r=(u,d,h,m)=>{const k=u.getBoundingClientRect(),R=k.left+k.width/2,Ae=k.top+k.height/2,O=k.width/2-25;let _=m.clientX-R,A=m.clientY-Ae;const Z=Math.sqrt(_*_+A*A);Z>O&&(_=_/Z*O,A=A/Z*O),h.dx=_/O,h.dy=A/O,h.active=!0,d.style.transform=`translate(calc(-50% + ${_}px), calc(-50% + ${A}px))`},c=(u,d)=>{d.dx=0,d.dy=0,d.active=!1,u.style.transform="translate(-50%, -50%)"};document.addEventListener("touchstart",u=>{for(const d of Array.from(u.changedTouches)){const h=t.getBoundingClientRect(),m=a.getBoundingClientRect();d.clientX>=h.left&&d.clientX<=h.right&&d.clientY>=h.top&&d.clientY<=h.bottom?(s=d.identifier,r(t,i,K,d)):d.clientX>=m.left&&d.clientX<=m.right&&d.clientY>=m.top&&d.clientY<=m.bottom&&(o=d.identifier,r(a,n,E,d))}}),document.addEventListener("touchmove",u=>{for(const d of Array.from(u.changedTouches))d.identifier===s?r(t,i,K,d):d.identifier===o&&r(a,n,E,d)}),document.addEventListener("touchend",u=>{for(const d of Array.from(u.changedTouches))d.identifier===s?(s=null,c(i,K)):d.identifier===o&&(o=null,c(n,E))})}function be(){const t=document.getElementById("game-container");t?(p.width=t.clientWidth,p.height=t.clientHeight):(p.width=window.innerWidth,p.height=window.innerHeight),f.x=p.width/2,f.y=p.height/2,console.log("[resizeCanvas] Canvas resized to",p.width,"x",p.height)}async function ve(){console.log("[init] Initializing Paper Planet"),p=document.getElementById("gameCanvas"),e=p.getContext("2d"),be(),window.addEventListener("resize",be),Ue(),Pt(),requestAnimationFrame(_e)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",ve):ve();</script>
</head>
<body>
    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        
        <!-- HUD -->
        <div id="hud" style="display: none;">
            <div class="hud-section">
                <div class="hud-box">
                    <div class="hud-label">PLANET</div>
                    <div class="hp-bar-container">
                        <div class="hp-bar" id="hpBar" style="width: 100%"></div>
                    </div>
                </div>
                <div class="hud-box round-display">
                    <div class="hud-label">ROUND</div>
                    <div class="hud-value" id="roundDisplay">1</div>
                </div>
            </div>
            <div class="hud-section" style="align-items: flex-end;">
                <div class="hud-box">
                    <div class="hud-label">COMBO</div>
                    <div class="hud-value" id="scoreDisplay">0</div>
                </div>
                <div class="items-display" id="itemsDisplay"></div>
            </div>
        </div>

        <!-- Mobile Joysticks -->
        <div class="joystick-zone left mobile-only" id="moveJoystick">
            <div class="joystick-thumb" id="moveThumb"></div>
        </div>
        <div class="joystick-zone right mobile-only" id="aimJoystick">
            <div class="joystick-thumb" id="aimThumb"></div>
        </div>

        <!-- Start Screen -->
        <div id="startScreen" class="overlay">
            <div class="content">
                <h1>PAPER PLANET</h1>
                <p class="subtitle">Defend your doodly planet from waves of scribble monsters!</p>
                <button class="btn" id="startButton">PLAY!</button>
                <div class="how-to-play desktop-only">
                    <h3>HOW TO PLAY</h3>
                    <div class="instructions">
                        <div class="instruction"><span class="key">A / D</span> Orbit around planet</div>
                        <div class="instruction"><span class="key">SPACE</span> Flip to other side</div>
                        <div class="instruction"><span class="key">L-CLICK</span> Aim & Shoot</div>
                        <div class="instruction"><span class="key">R-CLICK</span> Block meteors</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reward Screen (now rendered on canvas, this is just for state) -->
        <div id="rewardScreen" class="overlay hidden" style="background: transparent; pointer-events: none;">
        </div>

        <!-- Pause Screen -->
        <div id="pauseScreen" class="overlay hidden">
            <div class="content">
                <h2 class="pause-title">PAUSED</h2>
                <div class="pause-info">Press ESC to resume</div>
                <button class="btn" id="resumeButton">RESUME</button>
                <button class="btn btn-secondary" id="quitButton">QUIT TO MENU</button>
            </div>
        </div>

        <!-- Game Over Screen -->
        <div id="gameOverScreen" class="overlay hidden">
            <div class="content">
                <h2 class="game-over-title">GAME OVER</h2>
                <div class="final-score" id="finalScore">0</div>
                <div class="stats-row">
                    <div class="stat-item">
                        <div class="stat-value" id="roundsCleared">0</div>
                        <div class="stat-label">Rounds</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="enemiesKilled">0</div>
                        <div class="stat-label">Enemies</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="itemsCollected">0</div>
                        <div class="stat-label">Items</div>
                    </div>
                </div>
                <button class="btn" id="restartButton">PLAY AGAIN</button>
            </div>
        </div>
    </div>

</body>
</html>
