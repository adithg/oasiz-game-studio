<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no, minimal-ui">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Elevator Action</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            overflow: hidden;
            width: 100%;
            height: 100%;
            background: #000;
            color: #ffffff;
            font-family: 'VT323', monospace;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
            position: fixed;
            top: 0;
            left: 0;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }

        /* HUD Overlay */

        #hud {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            padding: 10px 20px;
            pointer-events: none;
            display: none;
            justify-content: space-between;
            align-items: flex-start;
            z-index: 5;
            font-family: 'Press Start 2P', cursive;
        }

        .hud-section {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .hud-label {
            font-size: 10px;
            color: #888;
            text-transform: uppercase;
        }

        .hud-value {
            font-size: 18px;
            color: #fff;
            text-shadow: 2px 2px 0 #000;
        }

        .hud-value.score {
            color: #ffd700;
        }

        .hud-value.lives {
            color: #ff4444;
        }

        .hud-value.docs {
            color: #44ff44;
        }

        /* Floor indicator */

        #floorIndicator {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-family: 'Press Start 2P', cursive;
            font-size: 14px;
            color: #fff;
            text-shadow: 2px 2px 0 #000;
            z-index: 5;
            pointer-events: none;
            display: none;
        }

        /* Overlays */

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10;
            transition: opacity 0.4s ease, visibility 0.4s ease;
        }

        .overlay.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .content {
            text-align: center;
            padding: 40px;
            max-width: 90%;
        }

        h1 {
            font-family: 'Press Start 2P', cursive;
            font-size: 2.5rem;
            color: #ff4444;
            margin-bottom: 20px;
            text-shadow: 4px 4px 0 #880000;
            animation: titlePulse 1.5s ease-in-out infinite;
        }

        @keyframes titlePulse {
            0%, 100% { text-shadow: 4px 4px 0 #880000, 0 0 20px rgba(255, 68, 68, 0.5); }
            50% { text-shadow: 4px 4px 0 #880000, 0 0 40px rgba(255, 68, 68, 0.8); }
        }

        .subtitle {
            font-family: 'VT323', monospace;
            font-size: 1.5rem;
            color: #888;
            margin-bottom: 30px;
        }

        .mission-brief {
            font-family: 'VT323', monospace;
            font-size: 1.2rem;
            color: #44ff44;
            margin-bottom: 30px;
            line-height: 1.8;
            text-align: left;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
            padding: 20px;
            border: 2px solid #44ff44;
            background: rgba(0, 50, 0, 0.5);
        }

        .mission-brief h3 {
            color: #ffd700;
            margin-bottom: 10px;
            text-align: center;
        }

        /* Buttons */

        .btn {
            background: #ff4444;
            color: #fff;
            border: none;
            padding: 15px 40px;
            font-family: 'Press Start 2P', cursive;
            font-size: 1rem;
            cursor: pointer;
            box-shadow: 4px 4px 0 #880000;
            transition: all 0.1s ease;
            text-transform: uppercase;
        }

        .btn:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 #880000;
        }

        .btn:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0 #880000;
        }

        /* Controls display */

        .controls-info {
            font-family: 'VT323', monospace;
            font-size: 1rem;
            color: #888;
            margin-top: 30px;
            line-height: 1.6;
        }

        .controls-info kbd {
            background: #333;
            padding: 3px 8px;
            border: 1px solid #666;
            border-radius: 3px;
            color: #fff;
        }

        /* Mobile controls */

        #mobileControls {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 15px;
            display: none;
            justify-content: space-between;
            align-items: flex-end;
            z-index: 5;
            pointer-events: none;
        }

        .mobile-btn {
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: auto;
            touch-action: manipulation;
        }

        .mobile-btn svg {
            width: 30px;
            height: 30px;
            fill: rgba(255, 255, 255, 0.8);
        }

        .mobile-btn:active {
            background: rgba(255, 255, 255, 0.4);
        }

        .dpad {
            display: grid;
            grid-template-columns: repeat(3, 60px);
            grid-template-rows: repeat(3, 60px);
            gap: 5px;
        }

        .dpad .mobile-btn {
            border-radius: 10px;
        }

        .dpad-up { grid-column: 2; grid-row: 1; }

        .dpad-left { grid-column: 1; grid-row: 2; }

        .dpad-right { grid-column: 3; grid-row: 2; }

        .dpad-down { grid-column: 2; grid-row: 3; }

        .action-buttons {
            display: flex;
            gap: 15px;
        }

        .action-btn {
            width: 70px;
            height: 70px;
            font-family: 'Press Start 2P', cursive;
            font-size: 10px;
            color: rgba(255, 255, 255, 0.8);
        }

        .action-btn.shoot {
            background: rgba(255, 68, 68, 0.3);
            border-color: rgba(255, 68, 68, 0.6);
        }

        .action-btn.jump {
            background: rgba(68, 68, 255, 0.3);
            border-color: rgba(68, 68, 255, 0.6);
        }

        /* Game Over styles */

        .game-over-title {
            font-family: 'Press Start 2P', cursive;
            font-size: 2rem;
            color: #ff4444;
            margin-bottom: 20px;
        }

        .final-score {
            font-family: 'Press Start 2P', cursive;
            font-size: 1.5rem;
            color: #ffd700;
            margin-bottom: 20px;
        }

        .mission-result {
            font-family: 'VT323', monospace;
            font-size: 1.5rem;
            margin-bottom: 30px;
        }

        .mission-result.success {
            color: #44ff44;
        }

        .mission-result.failed {
            color: #ff4444;
        }

        /* Mobile adjustments */

        @media (pointer: coarse) {
            h1 {
                font-size: 1.5rem;
            }
            .mission-brief {
                font-size: 1rem;
                padding: 15px;
            }
            .controls-info {
                display: none;
            }
            #mobileControls {
                display: flex;
            }
            #hud {
                padding: 60px 10px 10px 10px;
            }
            .hud-value {
                font-size: 14px;
            }
        }

        @media (max-height: 600px) {
            .mission-brief {
                display: none;
            }
        }
    </style>
  <script type="module" crossorigin>(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&o(r)}).observe(document,{childList:!0,subtree:!0});function t(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(s){if(s.ep)return;s.ep=!0;const i=t(s);fetch(s.href,i)}})();const n={TOTAL_FLOORS:15,FLOOR_HEIGHT:80,PLAYER_SPEED:120,GRAVITY:800,ELEVATOR_SPEED:100,ELEVATOR_WIDTH:48,ELEVATOR_HEIGHT:64,ENEMY_SPEED:60,ENEMY_SPAWN_INTERVAL:3e3,MAX_ENEMIES:5,BULLET_SPEED:400,DOCS_PER_LEVEL:5,POINTS_PER_DOC:500,POINTS_PER_ENEMY:300,COLORS:{bg:"#1a1a2e",building:"#2d2d44",floor:"#4a4a6a",wall:"#3d3d5c",doorRed:"#cc3333",doorRedDark:"#991111",doorNormal:"#666688",elevator:"#888899",elevatorDark:"#555566",player:"#4488ff",playerDark:"#2255cc",enemy:"#ff4444",enemyDark:"#cc2222",bullet:"#ffff44",car:"#44cc44"}};function H(h,e,t){return h+(e-h)*t}function O(h,e,t){return Math.max(e,Math.min(t,h))}function R(h,e){return h.x<e.x+e.width&&h.x+h.width>e.x&&h.y<e.y+e.height&&h.y+h.height>e.y}function S(h,e,t,o,s){return h.x<e+o&&h.x+h.width>e&&h.y<t+s&&h.y+h.height>t}class x{ctx;constructor(e){this.ctx=e}drawPlayer(e,t,o,s,i,r=2){const l=this.ctx,a=r;l.save(),o||(l.translate(e+16*a,t),l.scale(-1,1),e=0,t=0);const y=i?16:24,f=i?8*a:0;if(l.fillStyle=n.COLORS.player,l.fillRect(e+4*a,t+f+8*a,8*a,(y-8)*a),l.fillStyle=n.COLORS.playerDark,l.fillRect(e+4*a,t+f+8*a,2*a,(y-8)*a),l.fillStyle="#ffcc99",l.fillRect(e+5*a,t+f+2*a,6*a,6*a),l.fillStyle="#442200",l.fillRect(e+5*a,t+f+1*a,6*a,2*a),l.fillStyle="#000",l.fillRect(e+9*a,t+f+4*a,1*a,1*a),!i){const p=Math.sin(s*.5)*2*a;l.fillStyle="#333344",l.fillRect(e+5*a,t+20*a+Math.max(0,p),3*a,4*a),l.fillRect(e+9*a,t+20*a+Math.max(0,-p),3*a,4*a)}l.fillStyle=n.COLORS.player,l.fillRect(e+12*a,t+f+10*a,3*a,6*a),l.fillStyle="#333",l.fillRect(e+13*a,t+f+12*a,4*a,2*a),l.restore()}drawEnemy(e,t,o,s,i=2){const r=this.ctx,l=i;r.save(),o||(r.translate(e+16*l,t),r.scale(-1,1),e=0,t=0),r.fillStyle=n.COLORS.enemy,r.fillRect(e+4*l,t+8*l,8*l,12*l),r.fillStyle=n.COLORS.enemyDark,r.fillRect(e+4*l,t+8*l,2*l,12*l),r.fillStyle="#ffcc99",r.fillRect(e+5*l,t+2*l,6*l,6*l),r.fillStyle="#222",r.fillRect(e+4*l,t+1*l,8*l,2*l),r.fillStyle="#000",r.fillRect(e+9*l,t+4*l,1*l,1*l);const a=Math.sin(s*.5)*2*l;r.fillStyle="#222",r.fillRect(e+5*l,t+20*l+Math.max(0,a),3*l,4*l),r.fillRect(e+9*l,t+20*l+Math.max(0,-a),3*l,4*l),r.fillStyle=n.COLORS.enemy,r.fillRect(e+12*l,t+10*l,3*l,6*l),r.fillStyle="#333",r.fillRect(e+13*l,t+12*l,4*l,2*l),r.restore()}drawDoor(e,t,o,s,i,r=2){const l=this.ctx,a=r;if(l.fillStyle="#333",l.fillRect(e,t,20*a,28*a),i)l.fillStyle="#111",l.fillRect(e+2*a,t+2*a,16*a,24*a);else{const y=o&&!s?n.COLORS.doorRed:n.COLORS.doorNormal,f=o&&!s?n.COLORS.doorRedDark:"#444466";l.fillStyle=y,l.fillRect(e+2*a,t+2*a,16*a,24*a),l.fillStyle="#ffd700",l.fillRect(e+13*a,t+14*a,2*a,2*a),l.fillStyle=f,l.fillRect(e+2*a,t+2*a,2*a,24*a),o&&!s&&(l.fillStyle="#fff",l.fillRect(e+7*a,t+8*a,6*a,8*a),l.fillStyle="#333",l.fillRect(e+8*a,t+10*a,4*a,1*a),l.fillRect(e+8*a,t+12*a,4*a,1*a),l.fillRect(e+8*a,t+14*a,3*a,1*a))}}drawElevator(e,t,o,s){const i=this.ctx;i.fillStyle=n.COLORS.elevator,i.fillRect(e,t,o,s),i.fillStyle=n.COLORS.elevatorDark,i.fillRect(e,t,4,s),i.fillRect(e+o-4,t,4,s),i.fillStyle="#666",i.fillRect(e,t,o,4),i.fillStyle="#111",i.fillRect(e+o/2-8,t+6,16,12),i.fillStyle="#ff0",i.font="10px 'Press Start 2P'",i.textAlign="center",i.fillText("E",e+o/2,t+15)}drawElevatorShaft(e,t,o,s){const i=this.ctx;i.fillStyle="#0a0a15",i.fillRect(e,t,s,o-t),i.fillStyle="#333",i.fillRect(e,t,3,o-t),i.fillRect(e+s-3,t,3,o-t)}drawCar(e,t,o=2){const s=this.ctx,i=o;s.fillStyle=n.COLORS.car,s.fillRect(e,t+8*i,48*i,16*i),s.fillRect(e+8*i,t,24*i,10*i),s.fillStyle="#88ccff",s.fillRect(e+10*i,t+2*i,8*i,6*i),s.fillRect(e+22*i,t+2*i,8*i,6*i),s.fillStyle="#111",s.beginPath(),s.arc(e+10*i,t+24*i,5*i,0,Math.PI*2),s.fill(),s.beginPath(),s.arc(e+38*i,t+24*i,5*i,0,Math.PI*2),s.fill(),s.fillStyle="#888",s.beginPath(),s.arc(e+10*i,t+24*i,2*i,0,Math.PI*2),s.fill(),s.beginPath(),s.arc(e+38*i,t+24*i,2*i,0,Math.PI*2),s.fill(),s.fillStyle="#ffff88",s.fillRect(e+45*i,t+12*i,3*i,4*i)}drawBullet(e,t,o){const s=this.ctx;s.fillStyle=o?n.COLORS.bullet:n.COLORS.enemy,s.fillRect(e-3,t-2,6,4),s.fillStyle=o?"rgba(255, 255, 0, 0.3)":"rgba(255, 0, 0, 0.3)",s.beginPath(),s.arc(e,t,6,0,Math.PI*2),s.fill()}}class I{ctx=null;initialized=!1;init(){if(!this.initialized)try{this.ctx=new(window.AudioContext||window.webkitAudioContext),this.initialized=!0,console.log("[AudioManager.init] Initialized")}catch(e){console.warn("[AudioManager.init] Failed:",e)}}playTone(e,t,o="square",s=.2){if(!this.ctx)return;const i=this.ctx.createOscillator(),r=this.ctx.createGain();i.type=o,i.frequency.value=e,i.connect(r),r.connect(this.ctx.destination),r.gain.setValueAtTime(s,this.ctx.currentTime),r.gain.exponentialRampToValueAtTime(.01,this.ctx.currentTime+t),i.start(),i.stop(this.ctx.currentTime+t)}playShoot(){this.playTone(800,.1,"square",.15),setTimeout(()=>this.playTone(600,.05,"square",.1),50)}playEnemyShoot(){this.playTone(400,.1,"sawtooth",.1)}playJump(){this.playTone(200,.1,"sine",.15),setTimeout(()=>this.playTone(300,.1,"sine",.1),50)}playCollect(){this.playTone(523,.1,"sine",.2),setTimeout(()=>this.playTone(659,.1,"sine",.2),100),setTimeout(()=>this.playTone(784,.15,"sine",.2),200)}playEnemyDeath(){this.playTone(300,.15,"sawtooth",.15),setTimeout(()=>this.playTone(200,.15,"sawtooth",.1),100),setTimeout(()=>this.playTone(100,.2,"sawtooth",.08),200)}playPlayerHit(){this.playTone(200,.2,"sawtooth",.2),setTimeout(()=>this.playTone(150,.3,"sawtooth",.15),150)}playElevator(){this.playTone(100,.3,"triangle",.08)}playVictory(){[523,659,784,1047].forEach((t,o)=>{setTimeout(()=>this.playTone(t,.2,"sine",.2),o*150)})}playGameOver(){[392,349,330,262].forEach((t,o)=>{setTimeout(()=>this.playTone(t,.3,"sawtooth",.15),o*200)})}}class b{keys={};justPressed={};constructor(){window.addEventListener("keydown",e=>this.onKeyDown(e)),window.addEventListener("keyup",e=>this.onKeyUp(e)),document.querySelectorAll(".mobile-btn").forEach(e=>{const t=e.getAttribute("data-key");t&&(e.addEventListener("touchstart",o=>{o.preventDefault(),this.keys[t]=!0,this.justPressed[t]=!0}),e.addEventListener("touchend",o=>{o.preventDefault(),this.keys[t]=!1}))})}onKeyDown(e){const t=this.mapKey(e.code);this.keys[t]||(this.justPressed[t]=!0),this.keys[t]=!0,["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Space"].includes(e.code)&&e.preventDefault()}onKeyUp(e){const t=this.mapKey(e.code);this.keys[t]=!1}mapKey(e){switch(e){case"ArrowUp":case"KeyW":return"up";case"ArrowDown":case"KeyS":return"down";case"ArrowLeft":case"KeyA":return"left";case"ArrowRight":case"KeyD":return"right";case"KeyZ":case"Space":return"jump";case"KeyX":case"KeyC":return"shoot";default:return e}}isDown(e){return this.keys[e]||!1}wasPressed(e){return this.justPressed[e]||!1}clearJustPressed(){this.justPressed={}}}function L(h){console.log("[generateLevel] Creating level");const e=Math.min(h-40,600),t=[],o=[],s=[];for(let c=0;c<n.TOTAL_FLOORS;c++){const m=c*n.FLOOR_HEIGHT;t.push({y:m,floorNumber:n.TOTAL_FLOORS-c,platforms:[{x:0,width:e}]})}const i=2+Math.floor(Math.random()*2),r=e/(i+1);for(let c=0;c<i;c++){const m=r*(c+1)-n.ELEVATOR_WIDTH/2,u=0,T=n.TOTAL_FLOORS-2;s.push({x:m,y:u*n.FLOOR_HEIGHT+n.FLOOR_HEIGHT-n.ELEVATOR_HEIGHT,floor:u,targetY:u*n.FLOOR_HEIGHT+n.FLOOR_HEIGHT-n.ELEVATOR_HEIGHT,moving:!1,direction:0,shaftTop:u*n.FLOOR_HEIGHT,shaftBottom:T*n.FLOOR_HEIGHT+n.FLOOR_HEIGHT})}let l=0;const a=n.DOCS_PER_LEVEL,y=[],f=[];for(let c=2;c<n.TOTAL_FLOORS-1;c++)f.push(c);for(let c=f.length-1;c>0;c--){const m=Math.floor(Math.random()*(c+1));[f[c],f[m]]=[f[m],f[c]]}for(let c=0;c<Math.min(a,f.length);c++)y.push(f[c]);for(let c=1;c<n.TOTAL_FLOORS-1;c++){const m=c*n.FLOOR_HEIGHT+n.FLOOR_HEIGHT-56,u=[],T=40;for(let d=30;d<e-50;d+=80)s.some(E=>d+T>E.x-10&&d<E.x+n.ELEVATOR_WIDTH+10)||u.push(d);const w=Math.min(u.length,1+Math.floor(Math.random()*2));for(let d=u.length-1;d>0;d--){const g=Math.floor(Math.random()*(d+1));[u[d],u[g]]=[u[g],u[d]]}for(let d=0;d<w;d++){const g=u[d],E=y.includes(c)&&l<a;if(E){l++;const v=y.indexOf(c);v>-1&&y.splice(v,1)}o.push({x:g,y:m,floor:c,isRed:E,collected:!1,open:!1,openTimer:0})}}const p=o.filter(c=>!c.isRed&&c.floor>1);for(;l<a&&p.length>0;){const c=Math.floor(Math.random()*p.length),m=p.splice(c,1)[0];m.isRed=!0,l++}return console.log("[generateLevel] Created",o.length,"doors,",l,"red doors"),{player:{x:e/2-16,y:n.FLOOR_HEIGHT-48,width:32,height:48,vx:0,vy:0,facingRight:!0,onGround:!0,crouching:!1,inElevator:null,animFrame:0,animTimer:0,shooting:!1,shootTimer:0,invincible:0},enemies:[],bullets:[],doors:o,elevators:s,floors:t,score:0,lives:3,docsCollected:0,totalDocs:l,gameOver:!1,victory:!1,started:!1,cameraY:0,buildingWidth:e,buildingHeight:n.TOTAL_FLOORS*n.FLOOR_HEIGHT}}class _{canvas;ctx;sprites;audio;input;state;lastTime=0;enemySpawnTimer=0;isMobile;buildingOffsetX=0;constructor(){console.log("[ElevatorActionGame] Initializing"),this.canvas=document.getElementById("gameCanvas"),this.ctx=this.canvas.getContext("2d"),this.sprites=new x(this.ctx),this.audio=new I,this.input=new b,this.isMobile=window.matchMedia("(pointer: coarse)").matches,this.state=L(window.innerWidth),this.setupEventListeners(),this.resizeCanvas(),window.addEventListener("resize",()=>this.resizeCanvas()),requestAnimationFrame(e=>this.gameLoop(e))}setupEventListeners(){document.getElementById("startButton")?.addEventListener("click",()=>this.startGame()),document.getElementById("restartButton")?.addEventListener("click",()=>this.startGame())}resizeCanvas(){this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.buildingOffsetX=(this.canvas.width-this.state.buildingWidth)/2,console.log("[resizeCanvas] canvas:",this.canvas.width,"x",this.canvas.height)}startGame(){console.log("[startGame]"),this.audio.init(),this.state=L(this.canvas.width),this.state.started=!0,this.enemySpawnTimer=0,document.getElementById("startScreen")?.classList.add("hidden"),document.getElementById("gameOverScreen")?.classList.add("hidden"),document.getElementById("hud").style.display="flex",document.getElementById("floorIndicator").style.display="block",this.updateHUD()}gameLoop(e){const t=Math.min((e-this.lastTime)/1e3,.1);this.lastTime=e,this.state.started&&!this.state.gameOver&&!this.state.victory&&this.update(t),this.render(),this.input.clearJustPressed(),requestAnimationFrame(o=>this.gameLoop(o))}update(e){this.updatePlayer(e),this.updateElevators(e),this.updateEnemies(e),this.updateBullets(e),this.updateCamera(e),this.spawnEnemies(e),this.checkCollisions(),this.checkVictory(),this.updateDoors(e)}updatePlayer(e){const t=this.state.player;if(t.invincible>0&&(t.invincible-=e),t.shootTimer>0&&(t.shootTimer-=e),t.inElevator){const o=t.inElevator;this.input.isDown("up")?(o.direction=-1,o.moving=!0):this.input.isDown("down")?(o.direction=1,o.moving=!0):o.moving=!1,(this.input.isDown("left")||this.input.isDown("right"))&&(t.inElevator=null,t.vx=this.input.isDown("left")?-120:n.PLAYER_SPEED,t.facingRight=this.input.isDown("right")),t.x=o.x+(n.ELEVATOR_WIDTH-t.width)/2,t.y=o.y+n.ELEVATOR_HEIGHT-t.height,t.vy=0,t.onGround=!0}else{t.vx=0,this.input.isDown("left")&&(t.vx=-120,t.facingRight=!1),this.input.isDown("right")&&(t.vx=n.PLAYER_SPEED,t.facingRight=!0),t.crouching=this.input.isDown("down")&&t.onGround,t.crouching?(t.vx=0,t.height=32):t.height=48,this.input.wasPressed("jump")&&t.onGround&&(t.vy=-280,t.onGround=!1,this.audio.playJump()),t.vy+=n.GRAVITY*e,t.x+=t.vx*e,t.y+=t.vy*e,t.onGround=!1;for(const o of this.state.floors){const s=o.y+n.FLOOR_HEIGHT-8;t.vy>=0&&t.y+t.height>s&&t.y+t.height<s+20&&t.x+t.width>0&&t.x<this.state.buildingWidth&&(t.y=s-t.height,t.vy=0,t.onGround=!0)}t.x=O(t.x,0,this.state.buildingWidth-t.width);for(const o of this.state.elevators)S(t,o.x,o.y,n.ELEVATOR_WIDTH,n.ELEVATOR_HEIGHT)&&(this.input.wasPressed("up")||this.input.wasPressed("down"))&&(t.inElevator=o,this.audio.playElevator())}this.input.wasPressed("shoot")&&t.shootTimer<=0&&(this.shoot(t,!0),t.shootTimer=.3),Math.abs(t.vx)>0?(t.animTimer+=e,t.animTimer>.1&&(t.animFrame=(t.animFrame+1)%4,t.animTimer=0)):t.animFrame=0;for(const o of this.state.doors)o.isRed&&!o.collected&&S(t,o.x,o.y,40,56)&&(o.collected=!0,o.open=!0,o.openTimer=1,this.state.docsCollected++,this.state.score+=n.POINTS_PER_DOC,this.audio.playCollect(),this.updateHUD())}updateElevators(e){for(const t of this.state.elevators)if(t.moving){const o=n.ELEVATOR_SPEED*t.direction;t.y+=o*e;const s=t.shaftTop+10,i=t.shaftBottom-n.ELEVATOR_HEIGHT;t.y=O(t.y,s,i)}}updateEnemies(e){for(const t of this.state.enemies){t.shootTimer>0&&(t.shootTimer-=e);const o=this.state.player,s=Math.abs(o.x-t.x);Math.abs(o.y-t.y)<20&&s<300?(t.state="chase",t.facingRight=o.x>t.x,s<200&&t.shootTimer<=0&&Math.random()<.02&&(this.shoot(t,!1),t.shootTimer=1.5+Math.random())):t.state="patrol",t.state==="patrol"?t.vx=(t.facingRight?1:-1)*n.ENEMY_SPEED:t.state==="chase"&&(t.vx=(t.facingRight?1:-1)*n.ENEMY_SPEED*1.5),t.vy+=n.GRAVITY*e,t.x+=t.vx*e,t.y+=t.vy*e,t.onGround=!1;for(const l of this.state.floors){const a=l.y+n.FLOOR_HEIGHT-8;t.vy>=0&&t.y+t.height>a&&t.y+t.height<a+20&&(t.y=a-t.height,t.vy=0,t.onGround=!0)}(t.x<=0||t.x>=this.state.buildingWidth-t.width)&&(t.facingRight=!t.facingRight,t.x=O(t.x,0,this.state.buildingWidth-t.width)),Math.abs(t.vx)>0&&(t.animTimer+=e,t.animTimer>.12&&(t.animFrame=(t.animFrame+1)%4,t.animTimer=0))}}updateBullets(e){for(let t=this.state.bullets.length-1;t>=0;t--){const o=this.state.bullets[t];o.x+=o.vx*e,o.y+=o.vy*e,(o.x<-50||o.x>this.state.buildingWidth+50||o.y<-50||o.y>this.state.buildingHeight+50)&&this.state.bullets.splice(t,1)}}updateCamera(e){const t=this.state.player,o=t.y-this.canvas.height/3;this.state.cameraY=H(this.state.cameraY,o,5*e),this.state.cameraY=O(this.state.cameraY,0,this.state.buildingHeight-this.canvas.height);const s=n.TOTAL_FLOORS-Math.floor(t.y/n.FLOOR_HEIGHT),i=document.getElementById("floorIndicator");i&&(i.textContent="FLOOR "+s)}updateDoors(e){for(const t of this.state.doors)t.open&&t.openTimer>0&&(t.openTimer-=e,t.openTimer<=0&&(t.open=!1))}spawnEnemies(e){if(this.enemySpawnTimer+=e*1e3,this.enemySpawnTimer>=n.ENEMY_SPAWN_INTERVAL&&this.state.enemies.length<n.MAX_ENEMIES){this.enemySpawnTimer=0;const t=Math.floor(this.state.player.y/n.FLOOR_HEIGHT),o=this.state.doors.filter(s=>Math.abs(s.floor-t)>=2&&!s.isRed);if(o.length>0){const s=o[Math.floor(Math.random()*o.length)],i={x:s.x,y:s.y-4,width:32,height:48,vx:0,vy:0,facingRight:Math.random()>.5,onGround:!0,animFrame:0,animTimer:0,shootTimer:1+Math.random(),state:"patrol",spawnDoor:s};this.state.enemies.push(i),s.open=!0,s.openTimer=.5,console.log("[spawnEnemies] Spawned enemy at floor",s.floor)}}}shoot(e,t){const o={x:e.x+e.width/2+(e.facingRight?20:-20),y:e.y+e.height/2-5,width:8,height:4,vx:(e.facingRight?1:-1)*n.BULLET_SPEED,vy:0,isPlayer:t};this.state.bullets.push(o),t?this.audio.playShoot():this.audio.playEnemyShoot()}checkCollisions(){const e=this.state.player;for(let t=this.state.bullets.length-1;t>=0;t--){const o=this.state.bullets[t];if(o.isPlayer)for(let s=this.state.enemies.length-1;s>=0;s--){const i=this.state.enemies[s];if(R(o,i)){this.state.bullets.splice(t,1),this.state.enemies.splice(s,1),this.state.score+=n.POINTS_PER_ENEMY,this.audio.playEnemyDeath(),this.updateHUD();break}}else e.invincible<=0&&R(o,e)&&(this.state.bullets.splice(t,1),this.playerHit())}if(e.invincible<=0){for(const t of this.state.enemies)if(R(e,t)){this.playerHit();break}}}playerHit(){console.log("[playerHit] Lives remaining:",this.state.lives-1),this.state.lives--,this.state.player.invincible=2,this.audio.playPlayerHit(),this.updateHUD(),this.state.lives<=0&&this.endGame(!1)}checkVictory(){const e=this.state.player;if(this.state.docsCollected>=this.state.totalDocs){const t=(n.TOTAL_FLOORS-1)*n.FLOOR_HEIGHT;e.y>t-50&&this.endGame(!0)}}endGame(e){console.log("[endGame] Victory:",e,"Score:",this.state.score),this.state.gameOver=!0,this.state.victory=e,typeof window.submitScore=="function"&&window.submitScore(this.state.score);const t=document.getElementById("gameOverTitle"),o=document.getElementById("missionResult");e?(t.textContent="MISSION COMPLETE",t.style.color="#44ff44",o.textContent="All documents recovered! Agent extracted.",o.className="mission-result success",this.audio.playVictory()):(t.textContent="MISSION FAILED",t.style.color="#ff4444",o.textContent="Agent eliminated. Mission aborted.",o.className="mission-result failed",this.audio.playGameOver()),document.getElementById("finalScore").textContent=this.state.score.toString(),setTimeout(()=>{document.getElementById("gameOverScreen")?.classList.remove("hidden")},500)}updateHUD(){document.getElementById("score").textContent=this.state.score.toString(),document.getElementById("docs").textContent=this.state.docsCollected+"/"+this.state.totalDocs,document.getElementById("lives").textContent=this.state.lives.toString()}render(){const e=this.ctx,t=this.canvas.width,o=this.canvas.height;e.fillStyle=n.COLORS.bg,e.fillRect(0,0,t,o),e.save(),e.translate(this.buildingOffsetX,-this.state.cameraY),this.renderBuilding();for(const i of this.state.elevators)this.sprites.drawElevatorShaft(i.x,i.shaftTop,i.shaftBottom,n.ELEVATOR_WIDTH);for(const i of this.state.doors)this.sprites.drawDoor(i.x,i.y,i.isRed,i.collected,i.open);for(const i of this.state.elevators)this.sprites.drawElevator(i.x,i.y,n.ELEVATOR_WIDTH,n.ELEVATOR_HEIGHT);if(this.state.docsCollected>=this.state.totalDocs){const i=(n.TOTAL_FLOORS-1)*n.FLOOR_HEIGHT+n.FLOOR_HEIGHT-60;this.sprites.drawCar(this.state.buildingWidth-120,i)}for(const i of this.state.enemies)this.sprites.drawEnemy(i.x,i.y,i.facingRight,i.animFrame);const s=this.state.player;(s.invincible<=0||Math.floor(s.invincible*10)%2===0)&&this.sprites.drawPlayer(s.x,s.y,s.facingRight,s.animFrame,s.crouching);for(const i of this.state.bullets)this.sprites.drawBullet(i.x,i.y,i.isPlayer);e.restore(),this.state.started&&!this.state.gameOver&&this.state.docsCollected>=this.state.totalDocs&&(e.fillStyle="#44ff44",e.font="16px 'Press Start 2P'",e.textAlign="center",e.fillText("GET TO ESCAPE CAR!",t/2,80))}renderBuilding(){const e=this.ctx;e.fillStyle=n.COLORS.building,e.fillRect(-20,-50,this.state.buildingWidth+40,this.state.buildingHeight+100);for(const o of this.state.floors){const s=o.y+n.FLOOR_HEIGHT;e.fillStyle=n.COLORS.floor,e.fillRect(0,s-8,this.state.buildingWidth,8),e.fillStyle="#5a5a7a",e.fillRect(0,s-8,this.state.buildingWidth,2),e.fillStyle="#666",e.font="10px 'Press Start 2P'",e.textAlign="right",e.fillText(o.floorNumber.toString(),this.state.buildingWidth-5,s-20)}e.fillStyle=n.COLORS.wall,e.fillRect(-20,-50,20,this.state.buildingHeight+100),e.fillRect(this.state.buildingWidth,-50,20,this.state.buildingHeight+100),e.fillStyle="#333344",e.fillRect(-30,-60,this.state.buildingWidth+60,15);const t=(n.TOTAL_FLOORS-1)*n.FLOOR_HEIGHT+n.FLOOR_HEIGHT;e.fillStyle="#222233",e.fillRect(this.state.buildingWidth-80,t-70,60,70),e.fillStyle="#111",e.fillRect(this.state.buildingWidth-75,t-65,50,60),e.fillStyle="#44ff44",e.font="8px 'Press Start 2P'",e.textAlign="center",e.fillText("EXIT",this.state.buildingWidth-50,t-72)}}window.addEventListener("DOMContentLoaded",()=>{console.log("[main] Initializing Elevator Action"),new _});</script>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    
    <!-- HUD -->
    <div id="hud">
        <div class="hud-section">
            <div class="hud-label">Score</div>
            <div class="hud-value score" id="score">0</div>
        </div>
        <div class="hud-section">
            <div class="hud-label">Docs</div>
            <div class="hud-value docs" id="docs">0/0</div>
        </div>
        <div class="hud-section">
            <div class="hud-label">Lives</div>
            <div class="hud-value lives" id="lives">3</div>
        </div>
    </div>

    <div id="floorIndicator">FLOOR 30</div>

    <!-- Mobile Controls -->
    <div id="mobileControls">
        <div class="dpad">
            <button class="mobile-btn dpad-up" data-key="up">
                <svg viewBox="0 0 24 24"><path d="M7 14l5-5 5 5H7z"/></svg>
            </button>
            <button class="mobile-btn dpad-left" data-key="left">
                <svg viewBox="0 0 24 24"><path d="M14 7l-5 5 5 5V7z"/></svg>
            </button>
            <button class="mobile-btn dpad-right" data-key="right">
                <svg viewBox="0 0 24 24"><path d="M10 7v10l5-5-5-5z"/></svg>
            </button>
            <button class="mobile-btn dpad-down" data-key="down">
                <svg viewBox="0 0 24 24"><path d="M7 10l5 5 5-5H7z"/></svg>
            </button>
        </div>
        <div class="action-buttons">
            <button class="mobile-btn action-btn jump" data-key="jump">JUMP</button>
            <button class="mobile-btn action-btn shoot" data-key="shoot">FIRE</button>
        </div>
    </div>

    <!-- Start Screen -->
    <div id="startScreen" class="overlay">
        <div class="content">
            <h1>ELEVATOR ACTION</h1>
            <p class="subtitle">Secret Agent Mission</p>
            <div class="mission-brief">
                <h3>MISSION BRIEFING</h3>
                Agent Otto, your mission:<br><br>
                - Infiltrate the 30-story building<br>
                - Collect SECRET DOCUMENTS from RED doors<br>
                - Eliminate enemy agents<br>
                - Escape via the car at ground floor<br><br>
                Use ELEVATORS to navigate between floors.
            </div>
            <button class="btn" id="startButton">START MISSION</button>
            <div class="controls-info">
                <kbd>←</kbd> <kbd>→</kbd> Move &nbsp;|&nbsp;
                <kbd>↑</kbd> <kbd>↓</kbd> Elevator &nbsp;|&nbsp;
                <kbd>Z</kbd> Jump &nbsp;|&nbsp;
                <kbd>X</kbd> Shoot
            </div>
        </div>
    </div>

    <!-- Game Over Screen -->
    <div id="gameOverScreen" class="overlay hidden">
        <div class="content">
            <h2 class="game-over-title" id="gameOverTitle">MISSION FAILED</h2>
            <div class="mission-result failed" id="missionResult">You were eliminated!</div>
            <div class="final-score">SCORE: <span id="finalScore">0</span></div>
            <button class="btn" id="restartButton">TRY AGAIN</button>
        </div>
    </div>

</body>
</html>
